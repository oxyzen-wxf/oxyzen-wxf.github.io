<!-- build time:Mon Jul 18 2022 22:16:35 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://oxyzen-wxf.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://oxyzen-wxf.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://oxyzen-wxf.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java,Transaction"><link rel="canonical" href="https://oxyzen-wxf.github.io/computer-science/java/microservice/transaction-1/"><title>分布式事务 - 微服务分布式 - Java - 计算机科学 | Oxygen Anoxia = = 人生当苦无妨，良人当归即好!</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">分布式事务</h1><div class="meta"><span class="item" title="创建时间：2021-07-27 13:07:54"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-07-27T13:07:54+08:00">2021-07-27</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>11k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>10 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Oxygen Anoxia</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicljgocqbj20zk0m8e81.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipexj2jgzj20zk0m8b09.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipesng5oej20zk0m87d4.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giph4fomxoj20zk0m8axp.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/computer-science/java/microservice/" itemprop="item" rel="index" title="分类于 微服务分布式"><span itemprop="name">微服务分布式</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://oxyzen-wxf.github.io/computer-science/java/microservice/transaction-1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="WangXuefeng"><meta itemprop="description" content="人生当苦无妨，良人当归即好!, 日常学习 & 复习记录"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><p><img data-src="D:%5Cworkspace%5Cblog%5Chexo%5Cmyblog%5Csource%5Cassets%5Cimage-20210727104850584.png" alt="image-20210727104850584"></p><h2 id="一-本地事务"><a class="anchor" href="#一-本地事务">#</a> 一、本地事务</h2><h3 id="1-事务的基本性质"><a class="anchor" href="#1-事务的基本性质">#</a> 1、事务的基本性质</h3><p>数据库事务的几个特性：原子性 (Atomicity)、一致性 ( Consistency )、隔离性或独立性 ( Isolation) 和持久性 (Durabilily)，简称就是 ACID；</p><ul><li>原子性：一系列的操作整体不可拆分，要么同时成功，要么同时失败</li><li>一致性：数据在事务的前后，业务整体一致。<ul><li>转账。A:1000；B:1000； 转 200 事务成功；A：800 B：1200</li></ul></li><li>隔离性：事务之间互相隔离。</li><li>持久性：一旦事务成功，数据一定会落盘在数据库。</li></ul><p>在以往的单体应用中，我们多个业务操作使用同一条连接操作不同的数据表，一旦有异常， 我们可以很容易的整体回滚；</p><p><img data-src="../../../../assets/image-20210727113528088.png" alt="image-20210727113528088"></p><h3 id="2-事务的隔离级别"><a class="anchor" href="#2-事务的隔离级别">#</a> 2、事务的隔离级别</h3><ul><li><strong>READ UNCOMMITTED</strong>（读未提交）<br>该隔离级别的事务会读到其它未提交事务的数据，此现象也称之为脏读。</li><li><strong>READ COMMITTED</strong>（读提交）<br>一个事务可以读取另一个已提交的事务，多次读取会造成不一样的结果，此现象称为不可重<br>复读问题，Oracle 和 SQL Server 的默认隔离级别。</li><li><strong>REPEATABLE READ</strong>（可重复读）<br>该隔离级别是 MySQL 默认的隔离级别，在同一个事务里，select 的结果是事务开始时时间<br>点的状态，因此，同样的 select 操作读到的结果会是一致的，但是，会有幻读现象。MySQL<br>的 InnoDB 引擎可以通过 next-key locks 机制（参考下文 &quot;行锁的算法&quot; 一节）来避免幻读。</li><li><strong>SERIALIZABLE</strong>（序列化）<br>在该隔离级别下事务都是串行顺序执行的，MySQL 数据库的 InnoDB 引擎会给读操作隐式<br>加一把读共享锁，从而避免了脏读、不可重读复读和幻读问题。</li></ul><h3 id="3-事务的传播行为"><a class="anchor" href="#3-事务的传播行为">#</a> 3、事务的传播行为</h3><p>1、**PROPAGATION_REQUIRED：** 如果当前没有事务，就创建一个新事务，如果当前存在事务，<br>就加入该事务，该设置是最常用的设置。<br>2、**PROPAGATION_SUPPORTS：** 支持当前事务，如果当前存在事务，就加入该事务，如果当<br>前不存在事务，就以非事务执行。<br>3、**PROPAGATION_MANDATORY：** 支持当前事务，如果当前存在事务，就加入该事务，如果<br>当前不存在事务，就抛出异常。<br>4、**PROPAGATION_REQUIRES_NEW：** 创建新事务，无论当前存不存在事务，都创建新事务。<br>5、**PROPAGATION_NOT_SUPPORTED：** 以非事务方式执行操作，如果当前存在事务，就把当<br>前事务挂起。<br>6、**PROPAGATION_NEVER：** 以非事务方式执行，如果当前存在事务，则抛出异常。<br>7、**PROPAGATION_NESTED：** 如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，<br>则执行与 PROPAGATION_REQUIRED 类似的操作。</p><h3 id="4-springboot-事务关键点"><a class="anchor" href="#4-springboot-事务关键点">#</a> 4、SpringBoot 事务关键点</h3><h4 id="1-事务的自动配置"><a class="anchor" href="#1-事务的自动配置">#</a> 1、事务的自动配置</h4><p>TransactionAutoConfiguration</p><h4 id="2-事务的坑"><a class="anchor" href="#2-事务的坑">#</a> 2、事务的坑</h4><p>在同一个类里面，编写两个方法，内部调用的时候，会导致事务设置失效。原因是没有用到 代理对象的缘故。</p><p>解决：</p><p>​ 0）、导入 spring-boot-starter-aop<br>​ 1）、@EnableTransactionManagement(proxyTargetClass = true)<br>​ 2）、@EnableAspectJAutoProxy(exposeProxy=true)<br>​ 3）、AopContext.currentProxy () 调用方法</p><h3 id="5-本地事务回顾"><a class="anchor" href="#5-本地事务回顾">#</a> 5、本地事务回顾</h3><p><strong>开启 aspectj 动态代理，不开启默认使用 jdk 代理</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">// 没有接口也可以动态代理</span></pre></td></tr><tr><td data-num="2"></td><td><pre>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 对外暴漏代理对象</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>timeout <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span> <span class="token comment">//a 事务  b 会随 a 的超时时间不会用自己的子事务无效  （同一个 service 调用 bc 方法其实还是共用一个事务）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// （同一个 service 调用 bc 方法其实还是共用一个事务）用动态代理对象调方法就可以了</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">OrderServiceImpl</span> o <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OrderServiceImpl</span><span class="token punctuation">)</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    o<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//a 事务</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    o<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 新事务  （不随 a 回滚）</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 需要一个事务：如果前面有了就公用一个事务</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span>REQUIRES_NEW<span class="token punctuation">)</span> <span class="token comment">// 需要一个新的事务，自己用一个事务</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="二-分布式事务"><a class="anchor" href="#二-分布式事务">#</a> 二、分布式事务</h2><h3 id="1-为什么有分布式事务"><a class="anchor" href="#1-为什么有分布式事务">#</a> 1、为什么有分布式事务</h3><p>分布式系统经常出现的异常<br>机器宕机、网络异常、消息丢失、消息乱序、数据错误、不可靠的 TCP、存储数据丢失...</p><p><img data-src="../../../../assets/image-20210727120556443.png" alt="image-20210727120556443"></p><h3 id="2-cap-定理与-base-理论"><a class="anchor" href="#2-cap-定理与-base-理论">#</a> 2、CAP 定理与 BASE 理论</h3><h4 id="1-cap-定理"><a class="anchor" href="#1-cap-定理">#</a> 1、CAP 定理</h4><p>CAP 原则又称 CAP 定理，指的是在一个分布式系统中</p><ul><li><strong>一致性</strong>（Consistency）：<ul><li>在分布式系统中的所有数据备份，在同一时刻是否同样的值。（等同于所有节点访<br>问同一份最新的数据副本）</li></ul></li><li><strong>可用性</strong>（Availability）</li><li>在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。（对数据<br>更新具备高可用性）</li><li><strong>分区容错性</strong>（Partition tolerance）</li><li>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。<br>分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务<br>器放在美国，这就是两个区，它们之间可能无法通信。<br>CAP 原则指的是，这三个要素最多只能同时实现两点，<strong>不可能三者兼顾。</strong></li></ul><p><img data-src="../../../../assets/image-20210727120708664.png" alt="image-20210727120708664"></p><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们， 剩下的 C 和 A 无法同时做到。</p><p>分布式系统中实现一致性的 raft 算法、paxos</p><p><strong>raft 算法动画：<span class="exturl" data-url="aHR0cDovL3RoZXNlY3JldGxpdmVzb2ZkYXRhLmNvbS9yYWZ0Lw==">http://thesecretlivesofdata.com/raft/</span></strong></p><h4 id="2-面临的问题"><a class="anchor" href="#2-面临的问题">#</a> 2、面临的问题</h4><p>对于多数大型互联网应用的场景，主机众多、部署分散，而且现在的集群规模越来越大，所 以节点故障、网络故障是常态，而且要保证服务可用性达到 99.99999%（N 个 9），即保证 P 和 A，舍弃 C。</p><h4 id="3-base-理论"><a class="anchor" href="#3-base-理论">#</a> 3、BASE 理论</h4><p>是对 CAP 理论的延伸，思想是即使无法做到强一致性（CAP 的一致性就是强一致性），但可 以采用适当的采取弱一致性，<strong>即最终一致性。</strong></p><p>BASE 是指</p><ul><li>基本可用（Basically Available）<ul><li>基本可用是指分布式系统在出现故障的时候，允许损失部分可用性（例如响应时间、<br>功能上的可用性），允许损失部分可用性。需要注意的是，基本可用绝不等价于系<br>统不可用。</li><li>响应时间上的损失：正常情况下搜索引擎需要在 0.5 秒之内返回给用户相应的<br>查询结果，但由于出现故障（比如系统部分机房发生断电或断网故障），查询<br>结果的响应时间增加到了 1~2 秒。</li><li>功能上的损失：购物网站在购物高峰（如双十一）时，为了保护系统的稳定性，<br>部分消费者可能会被引导到一个降级页面。</li></ul></li><li>软状态（ Soft State）</li><li>软状态是指允许系统存在中间状态，而该中间状态不会影响系统整体可用性。分布<br>式存储中一般一份数据会有多个副本，允许不同副本同步的延时就是软状态的体<br>现。mysql replication 的异步复制也是一种体现。</li><li>最终一致性（ Eventual Consistency）</li><li>最终一致性是指系统中的所有数据副本经过一定时间后，最终能够达到一致的状<br>态。弱一致性和强一致性相反，最终一致性是弱一致性的一种特殊情况。</li></ul><h4 id="4-强一致性-弱一致性-最终一致性"><a class="anchor" href="#4-强一致性-弱一致性-最终一致性">#</a> 4、强一致性、弱一致性、最终一致性</h4><p>从客户端角度，多进程并发访问时，更新过的数据在不同进程如何获取的不同策略，决定了 不同的一致性。对于关系型数据库，要求更新过的数据能被后续的访问都能看到，这是<strong>强一 致性</strong>。如果能容忍后续的部分或者全部访问不到，则是<strong>弱一致性</strong>。如果经过一段时间后要求 能访问到更新后的数据，则是<strong>最终一致性</strong></p><h3 id="3-分布式事务几种方案"><a class="anchor" href="#3-分布式事务几种方案">#</a> 3、分布式事务几种方案</h3><h4 id="1-2pc-模式"><a class="anchor" href="#1-2pc-模式">#</a> 1）、2PC 模式</h4><p>数据库支持的 2PC【2 phase commit 二阶提交】，又叫做 XA Transactions。 MySQL 从 5.5 版本开始支持，SQL Server 2005 开始支持，Oracle 7 开始支持。 其中，XA 是一个两阶段提交协议，该协议分为以下两个阶段：</p><p>第一阶段：事务协调器要求每个涉及到事务的数据库预提交 (precommit) 此操作，并反映是<br>否可以提交。第二阶段：事务协调器要求每个数据库提交数据。<br>其中，如果有任何一个数据库否决此次提交，那么所有数据库都会被要求回滚它们在此事务<br>中的那部分信息。</p><p><img data-src="../../../../assets/image-20210727122326176.png" alt="image-20210727122326176"></p><h4 id="2-柔性事务-tcc-事务补偿型方案"><a class="anchor" href="#2-柔性事务-tcc-事务补偿型方案">#</a> 2）、柔性事务 - TCC 事务补偿型方案</h4><p><img data-src="../../../../assets/image-20210727122349309.png" alt="image-20210727122349309"></p><h4 id="3-柔性事务-最大努力通知型方案"><a class="anchor" href="#3-柔性事务-最大努力通知型方案">#</a> 3）、柔性事务 - 最大努力通知型方案</h4><p>按规律进行通知，** 不保证数据一定能通知成功，但会提供可查询操作接口进行核对。** 这种<br>方案主要用在与第三方系统通讯时，比如：调用微信或支付宝支付后的支付结果通知。这种<br>方案也是结合 MQ 进行实现，例如：通过 MQ 发送 http 请求，设置最大通知次数。达到通<br>知次数后即不再通知。<br><strong>案例</strong>：银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对<br>账文件），支付宝的支付成功异步回调</p><h4 id="4-柔性事务-可靠消息最终一致性方案异步确保型"><a class="anchor" href="#4-柔性事务-可靠消息最终一致性方案异步确保型">#</a> 4）、柔性事务 - 可靠消息 + 最终一致性方案（异步确保型）</h4><p>实现：业务处理服务在业务事务提交之前，向实时消息服务请求发送消息，实时消息服务只<br>记录消息数据，而不是真正的发送。业务处理服务在业务事务提交之后，向实时消息服务确<br>认发送。只有在得到确认发送指令后，实时消息服务才会真正发送。<br>防止消息丢失：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* 1、做好消息确认机制（pulisher，consumer【手动 ack】）</pre></td></tr><tr><td data-num="3"></td><td><pre>* 2、每一个发送的消息都在数据库做好记录。定期将失败的消息再次发送一</pre></td></tr><tr><td data-num="4"></td><td><pre>遍</pre></td></tr><tr><td data-num="5"></td><td><pre>*/</pre></td></tr></table></figure><h2 id="三-seata的使用"><a class="anchor" href="#三-seata的使用">#</a> 三、Seata 的使用</h2><p><strong>文档：<span class="exturl" data-url="aHR0cDovL3NlYXRhLmlvL3poLWNuL2RvY3Mvb3ZlcnZpZXcvd2hhdC1pcy1zZWF0YS5odG1s">http://seata.io/zh-cn/docs/overview/what-is-seata.html</span></strong></p><h3 id="seata-2pc-at事务模式"><a class="anchor" href="#seata-2pc-at事务模式">#</a> Seata 2PC-AT 事务模式</h3><h4 id="步骤-1建立数据库"><a class="anchor" href="#步骤-1建立数据库">#</a> 步骤 1：建立数据库</h4><ul><li>要求：具有 InnoDB 引擎的 MySQL。</li></ul><p><strong>注意:</strong> 实际上，在示例用例中，这 3 个服务应该有 3 个数据库。 但是，为了简单起见，我们只创建一个数据库并配置 3 个数据源。</p><h4 id="步骤-2创建-undo_log-表"><a class="anchor" href="#步骤-2创建-undo_log-表">#</a> 步骤 2：创建 UNDO_LOG 表</h4><p><strong>每个需要用 seata 的库都需要建立 undo_log 表</strong></p><p>SEATA AT 模式需要 <code>UNDO_LOG</code> 表</p><figure class="highlight sql"><figcaption data-lang="SQL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">-- 注意此处 0.3.0+ 增加唯一索引 ux_undo_log</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span> <span class="token punctuation">(</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">`</span>xid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">`</span>context<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span> <span class="token keyword">longblob</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token punctuation">`</span>log_status<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">`</span>log_created<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token punctuation">`</span>ext<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>xid<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="步骤-3为示例业务创建表"><a class="anchor" href="#步骤-3为示例业务创建表">#</a> 步骤 3：为示例业务创建表</h4><h4 id="步骤-4-启动服务"><a class="anchor" href="#步骤-4-启动服务">#</a> 步骤 4: 启动服务</h4><ul><li>从 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlYXRhL3NlYXRhL3JlbGVhc2VzLCVFNCVCOCU4QiVFOCVCRCVCRCVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOCVFOCVCRCVBRiVFNCVCQiVCNiVFNSU4QyU4NSVFRiVCQyU4QyVFNSVCMCU4NiVFNSU4NSVCNiVFOCVBNyVBMyVFNSU4RSU4QiVFNyVCQyVBOSVFMyU4MCU4Mg==">https://github.com/seata/seata/releases, 下载服务器软件包，将其解压缩。</span></li></ul><h4 id="步骤5添加seata依赖"><a class="anchor" href="#步骤5添加seata依赖">#</a> 步骤 5：添加 seata 依赖</h4><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span> 对应版本号下载对应的服务器软件包</pre></td></tr></table></figure><p><img data-src="../../../../assets/image-20210727125053591.png" alt="image-20210727125053591"></p><p>对应服务器包的版本也应该是 0.7.1<img data-src="../../../../assets/image-20210727125121971.png" alt="image-20210727125121971"></p><h4 id="步骤6配置软件包"><a class="anchor" href="#步骤6配置软件包">#</a> 步骤 6：配置软件包</h4><p><img data-src="../../../../assets/image-20210727125323648.png" alt="image-20210727125323648"></p><p><strong>registry.conf</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>registry <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  # file 、nacos 、eureka、redis、zk、consul、etcd3、sofa  type指定用什么注册中心 并配置对应注册中心地址</pre></td></tr><tr><td data-num="3"></td><td><pre>  type = <span class="token string">"nacos"</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  nacos <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    serverAddr = <span class="token string">"localhost:8848"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    namespace = <span class="token string">"public"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  eureka <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    serviceUrl = <span class="token string">"http://localhost:1001/eureka"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    application = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    weight = <span class="token string">"1"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  redis <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    serverAddr = <span class="token string">"localhost:6379"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    db = <span class="token string">"0"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  zk <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    serverAddr = <span class="token string">"127.0.0.1:2181"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    session.timeout = <span class="token number">6000</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    connect.timeout = <span class="token number">2000</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  consul <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    serverAddr = <span class="token string">"127.0.0.1:8500"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  etcd3 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    serverAddr = <span class="token string">"http://localhost:2379"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  sofa <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    serverAddr = <span class="token string">"127.0.0.1:9603"</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    application = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    region = <span class="token string">"DEFAULT_ZONE"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    datacenter = <span class="token string">"DefaultDataCenter"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    group = <span class="token string">"SEATA_GROUP"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    addressWaitTime = <span class="token string">"3000"</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  file <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    name = <span class="token string">"file.conf"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>config <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  # file、nacos 、apollo、zk、consul、etcd3    seata的配置信息</pre></td></tr><tr><td data-num="49"></td><td><pre>  type = <span class="token string">"file"</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  nacos <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    serverAddr = <span class="token string">"localhost"</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    namespace = <span class="token string">"public"</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    cluster = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  consul <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    serverAddr = <span class="token string">"127.0.0.1:8500"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  apollo <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    app.id = <span class="token string">"seata-server"</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    apollo.meta = <span class="token string">"http://192.168.1.204:8801"</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  zk <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    serverAddr = <span class="token string">"127.0.0.1:2181"</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    session.timeout = <span class="token number">6000</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    connect.timeout = <span class="token number">2000</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  etcd3 <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    serverAddr = <span class="token string">"http://localhost:2379"</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  file <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    name = <span class="token string">"file.conf"</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>file.conf</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>transport <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  # tcp udt unix-domain-socket</pre></td></tr><tr><td data-num="3"></td><td><pre>  type = <span class="token string">"TCP"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  #NIO NATIVE</pre></td></tr><tr><td data-num="5"></td><td><pre>  server = <span class="token string">"NIO"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  #enable heartbeat</pre></td></tr><tr><td data-num="7"></td><td><pre>  heartbeat = <span class="token boolean">true</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  #thread factory for netty</pre></td></tr><tr><td data-num="9"></td><td><pre>  thread-factory <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    boss-thread-prefix = <span class="token string">"NettyBoss"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    worker-thread-prefix = <span class="token string">"NettyServerNIOWorker"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    server-executor-thread-prefix = <span class="token string">"NettyServerBizHandler"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    share-boss-worker = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    client-selector-thread-prefix = <span class="token string">"NettyClientSelector"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    client-selector-thread-size = <span class="token number">1</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    client-worker-thread-prefix = <span class="token string">"NettyClientWorkerThread"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    # netty boss thread size<span class="token punctuation">,</span>will not be used for UDT</pre></td></tr><tr><td data-num="18"></td><td><pre>    boss-thread-size = <span class="token number">1</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    #auto default pin or <span class="token number">8</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    worker-thread-size = <span class="token number">8</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  shutdown <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    # when destroy server<span class="token punctuation">,</span> wait seconds</pre></td></tr><tr><td data-num="24"></td><td><pre>    wait = <span class="token number">3</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  serialization = <span class="token string">"seata"</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  compressor = <span class="token string">"none"</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>service <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  #vgroup->rgroup</pre></td></tr><tr><td data-num="31"></td><td><pre>  vgroup_mapping.my_test_tx_group = <span class="token string">"default"</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  #only support single node</pre></td></tr><tr><td data-num="33"></td><td><pre>  default.grouplist = <span class="token string">"127.0.0.1:8091"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  #degrade current not support</pre></td></tr><tr><td data-num="35"></td><td><pre>  enableDegrade = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  #disable</pre></td></tr><tr><td data-num="37"></td><td><pre>  disable = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  #unit ms<span class="token punctuation">,</span>s<span class="token punctuation">,</span>m<span class="token punctuation">,</span>h<span class="token punctuation">,</span>d represents milliseconds<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> minutes<span class="token punctuation">,</span> hours<span class="token punctuation">,</span> days<span class="token punctuation">,</span> default permanent</pre></td></tr><tr><td data-num="39"></td><td><pre>  max.commit.retry.timeout = <span class="token string">"-1"</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  max.rollback.retry.timeout = <span class="token string">"-1"</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>client <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  async.commit.buffer.limit = <span class="token number">10000</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  lock <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    retry.internal = <span class="token number">10</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    retry.times = <span class="token number">30</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  report.retry.count = <span class="token number">5</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>## transaction log store 事务日志存在哪里</pre></td></tr><tr><td data-num="53"></td><td><pre>store <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>  ## store mode<span class="token operator">:</span> file、db</pre></td></tr><tr><td data-num="55"></td><td><pre>  mode = <span class="token string">"file"</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>  ## file store</pre></td></tr><tr><td data-num="58"></td><td><pre>  file <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    dir = <span class="token string">"sessionStore"</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    # branch session size <span class="token punctuation">,</span> if exceeded first try compress lockkey<span class="token punctuation">,</span> still exceeded throws exceptions</pre></td></tr><tr><td data-num="62"></td><td><pre>    max-branch-session-size = <span class="token number">16384</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    # globe session size <span class="token punctuation">,</span> if exceeded throws exceptions</pre></td></tr><tr><td data-num="64"></td><td><pre>    max-global-session-size = <span class="token number">512</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    # file buffer size <span class="token punctuation">,</span> if exceeded allocate new buffer</pre></td></tr><tr><td data-num="66"></td><td><pre>    file-write-buffer-cache-size = <span class="token number">16384</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    # when recover batch read size</pre></td></tr><tr><td data-num="68"></td><td><pre>    session.reload.read_size = <span class="token number">100</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    # async<span class="token punctuation">,</span> sync</pre></td></tr><tr><td data-num="70"></td><td><pre>    flush-disk-mode = async</pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  ## database store 数据库配置   global_table branch_table branch_table  对应外面的db_store.sql</pre></td></tr><tr><td data-num="74"></td><td><pre>  db <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    ## the implement of javax.sql.DataSource<span class="token punctuation">,</span> such as DruidDataSource(druid)/BasicDataSource(dbcp) etc.</pre></td></tr><tr><td data-num="76"></td><td><pre>    datasource = <span class="token string">"dbcp"</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    ## mysql/oracle/h2/oceanbase etc.</pre></td></tr><tr><td data-num="78"></td><td><pre>    db-type = <span class="token string">"mysql"</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    url = <span class="token string">"jdbc:mysql://127.0.0.1:3306/seata"</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    user = <span class="token string">"mysql"</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    password = <span class="token string">"mysql"</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    min-conn = <span class="token number">1</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    max-conn = <span class="token number">3</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    global.table = <span class="token string">"global_table"</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    branch.table = <span class="token string">"branch_table"</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    lock-table = <span class="token string">"lock_table"</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    query-limit = <span class="token number">100</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>lock <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>  ## the lock store mode<span class="token operator">:</span> local、remote</pre></td></tr><tr><td data-num="92"></td><td><pre>  mode = <span class="token string">"remote"</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>  local <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    ## store locks in user's database</pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="97"></td><td><pre></pre></td></tr><tr><td data-num="98"></td><td><pre>  remote <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    ## store locks in the seata's server</pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="101"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>recovery <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  committing-retry-delay = <span class="token number">30</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  asyn-committing-retry-delay = <span class="token number">30</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  rollbacking-retry-delay = <span class="token number">30</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  timeout-retry-delay = <span class="token number">30</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>transaction <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>  undo.data.validation = <span class="token boolean">true</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  undo.log.serialization = <span class="token string">"jackson"</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>## metrics settings</pre></td></tr><tr><td data-num="115"></td><td><pre>metrics <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  enabled = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  registry-type = <span class="token string">"compact"</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  # multi exporters use comma divided</pre></td></tr><tr><td data-num="119"></td><td><pre>  exporter-list = <span class="token string">"prometheus"</span></pre></td></tr><tr><td data-num="120"></td><td><pre>  exporter-prometheus-port = <span class="token number">9898</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>异常</strong></p><pre><code>org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'globalTransactionScanner' defined in class path resource [com/alibaba/cloud/seata/GlobalTransactionAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.seata.spring.annotation.GlobalTransactionScanner]: Factory method 'globalTransactionScanner' threw exception; nested exception is io.seata.common.exception.NotSupportYetException: not support register type: null
</code></pre><p><strong>原因是因为导入了 seata，而 seata 接管事务是需要我们配置的，要不然 seata 拿不到配置的数据源则会报 null，不需要的排除 seata 就行，引用的需要配置</strong></p><h4 id="注意"><a class="anchor" href="#注意">#</a> 注意：</h4><p>所有想要用到分布式事务的微服务使用 seata DataSourceProxy 代理自己的数据源</p><h4 id="步骤7配置"><a class="anchor" href="#步骤7配置">#</a> 步骤 7：配置</h4><p>首先需要导入软件包中的两个配置文件到需要使用 seata 的服务的配置下</p><p><img data-src="../../../../assets/image-20210727133200515.png" alt="image-20210727133200515"></p><p>并修改如下配置</p><p><strong>file.conf</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>service <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  #vgroup->rgroup</pre></td></tr><tr><td data-num="3"></td><td><pre>  vgroup_mapping.gulimall-order-fescar-service-group = <span class="token string">"default"</span>  <span class="token comment">// 此处 gulimall-order - 为服务的名字需要与 yml 配置文件的 applicationname 相同</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  #only support single node</pre></td></tr><tr><td data-num="5"></td><td><pre>  default.grouplist = <span class="token string">"127.0.0.1:8091"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  #degrade current not support</pre></td></tr><tr><td data-num="7"></td><td><pre>  enableDegrade = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  #disable</pre></td></tr><tr><td data-num="9"></td><td><pre>  disable = <span class="token boolean">false</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  #unit ms<span class="token punctuation">,</span>s<span class="token punctuation">,</span>m<span class="token punctuation">,</span>h<span class="token punctuation">,</span>d represents milliseconds<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> minutes<span class="token punctuation">,</span> hours<span class="token punctuation">,</span> days<span class="token punctuation">,</span> default permanent</pre></td></tr><tr><td data-num="11"></td><td><pre>  max.commit.retry.timeout = <span class="token string">"-1"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  max.rollback.retry.timeout = <span class="token string">"-1"</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>为 seata 配置接管事务，用 DataSourceProxy 去代理事务（必须配置，否则导入 seata 在 spring 容器中进行加载 seata 配置 的时候为报错）</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * @author WangXuefeng</pre></td></tr><tr><td data-num="3"></td><td><pre> * @version 1.0</pre></td></tr><tr><td data-num="4"></td><td><pre> * @date 2021/7/27 13:34</pre></td></tr><tr><td data-num="5"></td><td><pre> * @description</pre></td></tr><tr><td data-num="6"></td><td><pre> */</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySeataConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>     * </pre></td></tr><tr><td data-num="12"></td><td><pre>     * 获取数据源配置，springboot 把数据原所有配置封装到了 DataSourceProperties 中</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">DataSourceProperties</span> dataSourceProperties<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     * 配置 seata 接管原先我们的数据源，此处用的是 springboot 默认的 HikariDataSource 数据原，</pre></td></tr><tr><td data-num="19"></td><td><pre>     * 我们需要将数据源交给 DataSourceProxy 也就 seata 代理</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @param dataSourceProperties</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSourceProperties</span> dataSourceProperties<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">HikariDataSource</span> hikariDataSource <span class="token operator">=</span> dataSourceProperties<span class="token punctuation">.</span><span class="token function">initializeDataSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">HikariDataSource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>dataSourceProperties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            hikariDataSource<span class="token punctuation">.</span><span class="token function">setPoolName</span><span class="token punctuation">(</span>dataSourceProperties<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span>  <span class="token class-name">DataSourceProxy</span><span class="token punctuation">(</span>hikariDataSource<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="步骤8加全局注解"><a class="anchor" href="#步骤8加全局注解">#</a> 步骤 8：加全局注解</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GlobalTransactional</span> <span class="token comment">// 在主事务上加</span></pre></td></tr></table></figure><p><strong>问题：不适合高并发场景（因为 AT 模式需要加很多锁，所以高并发性能很低）</strong></p><h3 id="高并发方式分布式"><a class="anchor" href="#高并发方式分布式">#</a> 高并发方式分布式</h3><p>分布式事务几种方案中的 3 和 4 柔性事务最终一致性</p><p>使用消息中间来完成业务逻辑</p><p><strong>RabbitMQ:<a href="https://oxyzen-wxf.github.io/database/msg/rabbitmq-1/">https://oxyzen-wxf.github.io/database/msg/rabbitmq-1/</a></strong></p><div class="tags"><a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a> <a href="/tags/Transaction/" rel="tag"><i class="ic i-tag"></i> Transaction</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-03 16:55:50" itemprop="dateModified" datetime="2022-06-03T16:55:50+08:00">2022-06-03</time> </span><span id="computer-science/java/microservice/transaction-1/" class="item leancloud_visitors" data-flag-title="分布式事务" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="WangXuefeng 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="WangXuefeng 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="WangXuefeng 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文博主： </strong>WangXuefeng <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://oxyzen-wxf.github.io/computer-science/java/microservice/transaction-1/" title="分布式事务">https://oxyzen-wxf.github.io/computer-science/java/microservice/transaction-1/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/computer-science/vue/vue-2/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;picsum.photos&#x2F;id&#x2F;1060&#x2F;1910&#x2F;656" title="vue中$refs, $emit, $on, $once, $off的使用详解"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Vue</span><h3>vue中$refs, $emit, $on, $once, $off的使用详解</h3></a></div><div class="item right"><a href="/computer-science/java/microservice/sleuth-1/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciszlczyj20zk0m816d.jpg" title="Sleuth-链路追踪"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务分布式</span><h3>Sleuth-链路追踪</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">一、本地事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%80%A7%E8%B4%A8"><span class="toc-number">1.1.</span> <span class="toc-text">1、事务的基本性质</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">2、事务的隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3、事务的传播行为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-springboot-%E4%BA%8B%E5%8A%A1%E5%85%B3%E9%94%AE%E7%82%B9"><span class="toc-number">1.4.</span> <span class="toc-text">4、SpringBoot 事务关键点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BA%8B%E5%8A%A1%E7%9A%84%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、事务的自动配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9D%91"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、事务的坑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.5.</span> <span class="toc-text">5、本地事务回顾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">二、分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">1、为什么有分布式事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-cap-%E5%AE%9A%E7%90%86%E4%B8%8E-base-%E7%90%86%E8%AE%BA"><span class="toc-number">2.2.</span> <span class="toc-text">2、CAP 定理与 BASE 理论</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-cap-%E5%AE%9A%E7%90%86"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、CAP 定理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、面临的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-base-%E7%90%86%E8%AE%BA"><span class="toc-number">2.2.3.</span> <span class="toc-text">3、BASE 理论</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7-%E5%BC%B1%E4%B8%80%E8%87%B4%E6%80%A7-%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.2.4.</span> <span class="toc-text">4、强一致性、弱一致性、最终一致性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%87%A0%E7%A7%8D%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.</span> <span class="toc-text">3、分布式事务几种方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2pc-%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text">1）、2PC 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1-tcc-%E4%BA%8B%E5%8A%A1%E8%A1%A5%E5%81%BF%E5%9E%8B%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.2.</span> <span class="toc-text">2）、柔性事务 - TCC 事务补偿型方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1-%E6%9C%80%E5%A4%A7%E5%8A%AA%E5%8A%9B%E9%80%9A%E7%9F%A5%E5%9E%8B%E6%96%B9%E6%A1%88"><span class="toc-number">2.3.3.</span> <span class="toc-text">3）、柔性事务 - 最大努力通知型方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1-%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88%E5%BC%82%E6%AD%A5%E7%A1%AE%E4%BF%9D%E5%9E%8B"><span class="toc-number">2.3.4.</span> <span class="toc-text">4）、柔性事务 - 可靠消息 + 最终一致性方案（异步确保型）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-seata%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">三、Seata 的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#seata-2pc-at%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.1.</span> <span class="toc-text">Seata 2PC-AT 事务模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">3.1.1.</span> <span class="toc-text">步骤 1：建立数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%E5%88%9B%E5%BB%BA-undo_log-%E8%A1%A8"><span class="toc-number">3.1.2.</span> <span class="toc-text">步骤 2：创建 UNDO_LOG 表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%E4%B8%BA%E7%A4%BA%E4%BE%8B%E4%B8%9A%E5%8A%A1%E5%88%9B%E5%BB%BA%E8%A1%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">步骤 3：为示例业务创建表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.4.</span> <span class="toc-text">步骤 4: 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A45%E6%B7%BB%E5%8A%A0seata%E4%BE%9D%E8%B5%96"><span class="toc-number">3.1.5.</span> <span class="toc-text">步骤 5：添加 seata 依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A46%E9%85%8D%E7%BD%AE%E8%BD%AF%E4%BB%B6%E5%8C%85"><span class="toc-number">3.1.6.</span> <span class="toc-text">步骤 6：配置软件包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">3.1.7.</span> <span class="toc-text">注意：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A47%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.8.</span> <span class="toc-text">步骤 7：配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A48%E5%8A%A0%E5%85%A8%E5%B1%80%E6%B3%A8%E8%A7%A3"><span class="toc-number">3.1.9.</span> <span class="toc-text">步骤 8：加全局注解</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E6%96%B9%E5%BC%8F%E5%88%86%E5%B8%83%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">高并发方式分布式</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/computer-science/java/microservice/lock-1/" rel="bookmark" title="分布式锁（一）之Redis分布式锁">分布式锁（一）之Redis分布式锁</a></li><li><a href="/computer-science/java/microservice/lock-2/" rel="bookmark" title="分布式锁（二）之Redisson分布式锁框架">分布式锁（二）之Redisson分布式锁框架</a></li><li><a href="/computer-science/java/microservice/lock-cache/" rel="bookmark" title="分布式锁（三）之SpringCache">分布式锁（三）之SpringCache</a></li><li><a href="/computer-science/java/microservice/oauth-1/" rel="bookmark" title="Guli认证服务笔记(一) Spring Session">Guli认证服务笔记(一) Spring Session</a></li><li><a href="/computer-science/java/microservice/oauth-2/" rel="bookmark" title="Guli认证服务笔记(二) 单点登录">Guli认证服务笔记(二) 单点登录</a></li><li><a href="/computer-science/java/microservice/spring-cloud-alibaba-1/" rel="bookmark" title="Spring Cloud Alibaba">Spring Cloud Alibaba</a></li><li><a href="/computer-science/java/microservice/ribbon-1/" rel="bookmark" title="Ribbon">Ribbon</a></li><li><a href="/computer-science/java/microservice/sentinel-1/" rel="bookmark" title="Sentinel">Sentinel</a></li><li><a href="/computer-science/java/microservice/sleuth-1/" rel="bookmark" title="Sleuth-链路追踪">Sleuth-链路追踪</a></li><li class="active"><a href="/computer-science/java/microservice/transaction-1/" rel="bookmark" title="分布式事务">分布式事务</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="WangXuefeng" data-src="/images/avatar.jpg"><p class="name" itemprop="name">WangXuefeng</p><div class="description" itemprop="description">日常学习 & 复习记录</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">85</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">25</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">44</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL294eXplbi13eGY=" title="https:&#x2F;&#x2F;github.com&#x2F;oxyzen-wxf"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTYwNzA2MDI0MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;607060241"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjk2MzIxMDczOEBxcS5jb20=" title="mailto:963210738@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/computer-science/vue/vue-2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/computer-science/java/microservice/sleuth-1/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/vue/" title="分类于 Vue">Vue</a></div><span><a href="/computer-science/vue/vue-2/" title="vue中$refs, $emit, $on, $once, $off的使用详解">vue中$refs, $emit, $on, $once, $off的使用详解</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/designpattern/" title="分类于 设计模式">设计模式</a></div><span><a href="/computer-science/java/designpattern/design-1/" title="设计模式">设计模式</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/computer-science/java/javaframe/springsecurity-1/" title="未命名">未命名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/javautil/" title="分类于 Java常用工具">Java常用工具</a></div><span><a href="/worknote/javautil/util-4/" title="JDBC连接工具">JDBC连接工具</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/javahigh/" title="分类于 Java高级">Java高级</a></div><span><a href="/computer-science/java/javahigh/juc-1/" title="JUC并发编程">JUC并发编程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/interview-3/" title="面试题笔记记录(三)周阳尚硅谷版">面试题笔记记录(三)周阳尚硅谷版</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/vue/" title="分类于 Vue">Vue</a></div><span><a href="/computer-science/vue/vue-4/" title="vue中传值的使用">vue中传值的使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/microservice/" title="分类于 微服务分布式">微服务分布式</a></div><span><a href="/computer-science/java/microservice/oauth-2/" title="Guli认证服务笔记(二) 单点登录">Guli认证服务笔记(二) 单点登录</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/microservice/" title="分类于 微服务分布式">微服务分布式</a></div><span><a href="/computer-science/java/microservice/spring-cloud-alibaba-1/" title="Spring Cloud Alibaba">Spring Cloud Alibaba</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/elasticsearch/" title="分类于 ElasticSearch">ElasticSearch</a></div><span><a href="/database/elasticsearch/es-1/" title="ElasticSearch学习笔记">ElasticSearch学习笔记</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">WangXuefeng @ Oxygen Anoxia</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">631k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">9:34</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"computer-science/java/microservice/transaction-1/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:{placeholder:"1. 提问前请先仔细阅读本文档⚡\n2. 页面显示问题💥，请提供控制台截图📸或者您的测试网址\n3. 其他任何报错💣，请提供详细描述和截图📸，祝食用愉快💪"},fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->