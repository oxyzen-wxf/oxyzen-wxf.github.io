<!-- build time:Fri Dec 30 2022 00:25:59 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://oxyzen-wxf.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://oxyzen-wxf.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://oxyzen-wxf.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java"><link rel="canonical" href="https://oxyzen-wxf.github.io/worknote/gulinote/"><title>谷粒商城笔记 - Java - 工作日常笔记 | Oxygen Anoxia = = 人生当苦无妨，良人当归即好!</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">谷粒商城笔记</h1><div class="meta"><span class="item" title="创建时间：2021-07-10 11:44:55"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-07-10T11:44:55+08:00">2021-07-10</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>82k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>1:14</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Oxygen Anoxia</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipew28b65j20zk0m8hdt.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipet4bz0yj20zk0m8e81.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipesx5fdwj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/worknote/" itemprop="item" rel="index" title="分类于 工作日常笔记"><span itemprop="name">工作日常笔记</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/worknote/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://oxyzen-wxf.github.io/worknote/gulinote/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="WangXuefeng"><meta itemprop="description" content="人生当苦无妨，良人当归即好!, 日常学习 & 复习记录"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h1 id="谷粒商城笔记"><a class="anchor" href="#谷粒商城笔记">#</a> 谷粒商城笔记</h1><h1 id="分布式基础"><a class="anchor" href="#分布式基础">#</a> 分布式基础</h1><h2 id="1设置docker容器在服务器重启容器自动重启"><a class="anchor" href="#1设置docker容器在服务器重启容器自动重启">#</a> 1. 设置 docker 容器在服务器重启容器自动重启</h2><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>docker update redis --restart<span class="token operator">=</span>always</pre></td></tr></table></figure><h2 id="2快速开发-人人开源"><a class="anchor" href="#2快速开发-人人开源">#</a> 2. 快速开发 - 人人开源</h2><h3 id="人人开源后台搭建"><a class="anchor" href="#人人开源后台搭建">#</a> 人人开源后台搭建</h3><ol><li>gitee 克隆下来 ，然后创建项目自带的 mysql 数据库</li><li>修改数据库地址</li></ol><h3 id="人人开源前台搭建"><a class="anchor" href="#人人开源前台搭建">#</a> 人人开源前台搭建</h3><ol><li>gitee 克隆下来</li><li>坑：报错 需要 python 环境</li><li>解决如下</li></ol><p><strong>1、npm:error MSB3428: 未能加载 Visual C++ 组件 “VCBuild.exe”</strong></p><p>原因：未使用管理员权限打开 vscode 导致未能加载<br>解决：</p><p>1、 以管理员权限运行 vscode<br>2、 npm install --global --production windows-build-tools<br>3、npm install -g node-gyp</p><p><strong>2、npm install Error: not found: python2：</strong></p><p>原因： 与上文类似，由于未安装 windows-build-tools 导致<br>解决：</p><p>1、 npm install --global --production windows-build-tools<br>2、npm install -g node-gyp</p><p>参考文章：npm install 报错:error MSB4019: 未找到导入的项目 “D:\Microsoft.Cpp.Defa ult.props”。</p><p><strong>3、npm install 报错:error MSB4019: 未找到导入的项目 “D:\Microsoft.Cpp.Defa ult.props”</strong></p><p>解决： npm install --global --production windows-build-tools</p><p><strong>4、renren-fast-vue 无法运行相关问题解决办法 n ./src/assets/scss/index.scss Module build failed: Error: ENOENT: no su</strong></p><p>解决：</p><p>1、 npm uninstall --save node-sass<br>2、 npm install --save node-sass</p><p><strong>5、Error: Node Sass does not yet support your current environment: Windows 64-bit with Unsupported runtime (83)</strong></p><p>与第四点相同：卸载再安装 node-sass</p><p><strong>6、安装 windows_build_tools 一直处于 still waiting for installer log file … 中</strong><br><strong>现象：安装 windows-build-tools 时 python2 已安装完毕，但是 windows_build_tools 一直暂停再 still waiting for installer log file</strong></p><p>运行指令:<br>npm install --global --production windows-build-tools@4.0.0</p><p>有可能人会有错误提示，这是直接运行项目</p><p>npm run dev</p><p>如果出现了问题 4 的情况，按照问题 4 解决，项目就可以跑起来了 。</p><h3 id="3人人开源逆向工程搭建使用"><a class="anchor" href="#3人人开源逆向工程搭建使用">#</a> 3. 人人开源逆向工程搭建使用</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">git</span> clone https://gitee.com/renrenio/renren-generator.git</pre></td></tr></table></figure><p>删除.git 文件</p><p>把 clone 下来的项目放进自己的项目中</p><h4 id="步骤"><a class="anchor" href="#步骤">#</a> <strong>步骤</strong></h4><ol><li>修改 application.yml 数据库链接地址</li><li>修改 generator.properties 文件</li></ol><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#代码生成器，配置信息</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">mainPath</span><span class="token punctuation">=</span><span class="token attr-value">com.atguigu</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#包名</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">package</span><span class="token punctuation">=</span><span class="token attr-value">com.atguigu.gulimall</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">moduleName</span><span class="token punctuation">=</span><span class="token attr-value">product</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#作者</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">author</span><span class="token punctuation">=</span><span class="token attr-value">wangxuefeng</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#Email</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token attr-name">email</span><span class="token punctuation">=</span><span class="token attr-value">963210738@qq.com</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#表前缀 (类名不会包含表前缀）</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">tablePrefix</span><span class="token punctuation">=</span><span class="token attr-value">pms_</span></pre></td></tr></table></figure><ol start="3"><li>启动后访问 localhost 端口 80</li></ol><p><img data-src="../../assets/image-20210625210427509.png" alt="image-20210625210427509"></p><ol start="4"><li><p>生成代码，下载 zip 替换项目</p></li><li><p>替换项目中 main，然后解决报错</p></li><li><p>模板核心</p></li></ol><p><img data-src="../../assets/image-20210625215320961.png" alt="image-20210625215320961"></p><h2 id="4创建公共模块gulimall-common"><a class="anchor" href="#4创建公共模块gulimall-common">#</a> 4. 创建公共模块 gulimall-common</h2><p>在所有模块中第一件事先导入公共 gulimall-common</p><p>然后导入，mybatis-plus 导入最新的去官网复制</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mybatis-plus.version</span><span class="token punctuation">></span></span>3.4.3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mybatis-plus.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lombok.version</span><span class="token punctuation">></span></span>1.18.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lombok.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>httpcore.version</span><span class="token punctuation">></span></span>4.4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>httpcore.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>commons.lang.version</span><span class="token punctuation">></span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>commons.lang.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">&lt;!--mybatis-plus 持久层 --></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;mybatis-plus.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;lombok.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.httpcomponents/httpcore --></span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.httpcomponents<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>httpcore<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;httpcore.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>commons-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;commons.lang.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h2 id="5gulimall-prodcut启动测试"><a class="anchor" href="#5gulimall-prodcut启动测试">#</a> 5.gulimall-prodcut 启动测试</h2><ol><li><p>整合 mybatis-plus</p></li><li><p>导入 mysql 驱动包在 common 模块中</p></li><li><p>配置 yml</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#数据库连接配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.61.128<span class="token punctuation">:</span>3360/gulimall_pms</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver</pre></td></tr><tr><td data-num="8"></td><td><pre>    </pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#mybatis-plus 配置    </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	// 路径可以点进去获取默认路径</pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">mapper-locations</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>/mapper/<span class="token important">**/*.xml</span> <span class="token comment">#配置扫描 mapper</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">global-config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">db-config</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto <span class="token comment"># 主键自增</span></pre></td></tr></table></figure></li><li><p>开启扫描 dao</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.atguigu.gulimall.product.dao"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallProdcutApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GulimallProdcutApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li><li><p>单元测试</p></li></ol><p><strong>注意：测试要与启动类同包同路径下创建</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GuliMallProductTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BrandService</span> brandService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">BrandEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrandEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        entity<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"华为"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">boolean</span> save <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>save<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="用人人逆向工程生成所有服务的代码"><a class="anchor" href="#用人人逆向工程生成所有服务的代码">#</a> 用人人逆向工程生成所有服务的代码</h2><h3 id="遇见无法加载主类报错"><a class="anchor" href="#遇见无法加载主类报错">#</a> 遇见无法加载主类报错</h3><p>根据错误重新 clean 然后 install 如果报错就看报错信息根据信息修改对应错误</p><h3 id="一输入netstat-ano并回车查看在运行的端口号"><a class="anchor" href="#一输入netstat-ano并回车查看在运行的端口号">#</a> 一：输入 netstat -ano 并回车查看在运行的端口号</h3><h3 id="三通过端口号查看相应端口号"><a class="anchor" href="#三通过端口号查看相应端口号">#</a> 三：通过端口号查看相应端口号</h3><h5 id="netstat-ano-findstr-端口号"><a class="anchor" href="#netstat-ano-findstr-端口号">#</a> netstat -ano | findstr “端口号”</h5><h3 id="四通过端口pid查看端口运行程序"><a class="anchor" href="#四通过端口pid查看端口运行程序">#</a> 四：通过端口 PID 查看端口运行程序</h3><h6 id="tasklist-findstr-pid"><a class="anchor" href="#tasklist-findstr-pid">#</a> tasklist | findstr “PID”</h6><h2 id="6把springboot-从251更换为218release的时候的报错"><a class="anchor" href="#6把springboot-从251更换为218release的时候的报错">#</a> 6. 把 Springboot 从 2.5.1 更换为 2.1.8.Release 的时候的报错</h2><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>org.springframework.context.ApplicationContextException: Unable to start web server<span class="token punctuation">;</span> nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name <span class="token string">'org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration<span class="token variable">$EmbeddedTomcat</span>'</span><span class="token builtin class-name">:</span> Initialization of bean failed<span class="token punctuation">;</span> nested exception is java.lang.NoClassDefFoundError: org/springframework/boot/context/properties/ConfigurationPropertiesBean</pre></td></tr><tr><td data-num="2"></td><td><pre>	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh<span class="token punctuation">(</span>ServletWebServerApplicationContext.java:156<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	at org.springframework.context.support.AbstractApplicationContext.refresh<span class="token punctuation">(</span>AbstractApplicationContext.java:543<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-context-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh<span class="token punctuation">(</span>ServletWebServerApplicationContext.java:141<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	at org.springframework.boot.SpringApplication.refresh<span class="token punctuation">(</span>SpringApplication.java:744<span class="token punctuation">)</span> <span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	at org.springframework.boot.SpringApplication.refreshContext<span class="token punctuation">(</span>SpringApplication.java:391<span class="token punctuation">)</span> <span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	at org.springframework.boot.SpringApplication.run<span class="token punctuation">(</span>SpringApplication.java:312<span class="token punctuation">)</span> <span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	at org.springframework.boot.SpringApplication.run<span class="token punctuation">(</span>SpringApplication.java:1215<span class="token punctuation">)</span> <span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	at org.springframework.boot.SpringApplication.run<span class="token punctuation">(</span>SpringApplication.java:1204<span class="token punctuation">)</span> <span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	at com.atguigu.gulimall.ware.GulimallWareApplication.main<span class="token punctuation">(</span>GulimallWareApplication.java:10<span class="token punctuation">)</span> <span class="token punctuation">[</span>classes/:na<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name <span class="token string">'org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration<span class="token variable">$EmbeddedTomcat</span>'</span><span class="token builtin class-name">:</span> Initialization of bean failed<span class="token punctuation">;</span> nested exception is java.lang.NoClassDefFoundError: org/springframework/boot/context/properties/ConfigurationPropertiesBean</pre></td></tr><tr><td data-num="12"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:601<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:515<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda<span class="token variable">$doGetBean</span><span class="token variable">$0</span><span class="token punctuation">(</span>AbstractBeanFactory.java:320<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton<span class="token punctuation">(</span>DefaultSingletonBeanRegistry.java:222<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean<span class="token punctuation">(</span>AbstractBeanFactory.java:318<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean<span class="token punctuation">(</span>AbstractBeanFactory.java:199<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>	at org.springframework.beans.factory.support.ConstructorResolver.instantiateUsingFactoryMethod<span class="token punctuation">(</span>ConstructorResolver.java:392<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.instantiateUsingFactoryMethod<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:1321<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:1160<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:555<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:515<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="23"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda<span class="token variable">$doGetBean</span><span class="token variable">$0</span><span class="token punctuation">(</span>AbstractBeanFactory.java:320<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="24"></td><td><pre>	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton<span class="token punctuation">(</span>DefaultSingletonBeanRegistry.java:222<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean<span class="token punctuation">(</span>AbstractBeanFactory.java:318<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean<span class="token punctuation">(</span>AbstractBeanFactory.java:204<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.getWebServerFactory<span class="token punctuation">(</span>ServletWebServerApplicationContext.java:210<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer<span class="token punctuation">(</span>ServletWebServerApplicationContext.java:179<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh<span class="token punctuation">(</span>ServletWebServerApplicationContext.java:153<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-boot-2.1.8.RELEASE.jar:2.1.8.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>	<span class="token punctuation">..</span>. <span class="token number">8</span> common frames omitted</pre></td></tr><tr><td data-num="31"></td><td><pre>Caused by: java.lang.NoClassDefFoundError: org/springframework/boot/context/properties/ConfigurationPropertiesBean</pre></td></tr><tr><td data-num="32"></td><td><pre>	at org.springframework.cloud.context.properties.ConfigurationPropertiesBeans.postProcessBeforeInitialization<span class="token punctuation">(</span>ConfigurationPropertiesBeans.java:76<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-cloud-context-3.0.3.jar:3.0.3<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="33"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:414<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:1770<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="35"></td><td><pre>	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean<span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory.java:593<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>spring-beans-5.1.9.RELEASE.jar:5.1.9.RELEASE<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token punctuation">..</span>. <span class="token number">25</span> common frames omitted</pre></td></tr><tr><td data-num="37"></td><td><pre>Caused by: java.lang.ClassNotFoundException: org.springframework.boot.context.properties.ConfigurationPropertiesBean</pre></td></tr><tr><td data-num="38"></td><td><pre>	at java.net.URLClassLoader.findClass<span class="token punctuation">(</span>URLClassLoader.java:382<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_231<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="39"></td><td><pre>	at java.lang.ClassLoader.loadClass<span class="token punctuation">(</span>ClassLoader.java:418<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_231<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="40"></td><td><pre>	at sun.misc.Launcher<span class="token variable">$AppClassLoader</span>.loadClass<span class="token punctuation">(</span>Launcher.java:355<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_231<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="41"></td><td><pre>	at java.lang.ClassLoader.loadClass<span class="token punctuation">(</span>ClassLoader.java:351<span class="token punctuation">)</span> ~<span class="token punctuation">[</span>na:1.8.0_231<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="42"></td><td><pre>	<span class="token punctuation">..</span>. <span class="token number">29</span> common frames omitted</pre></td></tr></table></figure><h3 id="错误原因就是251对应的springcloud版本是3x而替换为springboot21x版本的时候应该对应替换springcloud的版本"><a class="anchor" href="#错误原因就是251对应的springcloud版本是3x而替换为springboot21x版本的时候应该对应替换springcloud的版本">#</a> 错误原因就是 2.5.1 对应的 springcloud 版本是 3.x，而替换为 springboot2.1.x 版本的时候应该对应替换 springcloud 的版本</h3><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">></span></span>Greenwich.SR3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">></span></span> 对应着2.1.x版本的springboot</pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h2 id="7添加spring-cloud-alibaba依赖"><a class="anchor" href="#7添加spring-cloud-alibaba依赖">#</a> 7. 添加 Spring Cloud Alibaba 依赖</h2><h3 id="版本选择"><a class="anchor" href="#版本选择">#</a> 版本选择</h3><p>** 由于 Spring Boot 1 和 Spring Boot 2 在 Actuator 模块的接口和注解有很大的变更，且 spring-cloud-commons 从 1.x.x 版本升级到 2.0.0 版本也有较大的变更，因此我们采取跟 SpringBoot 版本号一致的版本: **</p><p>**1.5.x 版本适用于 Spring Boot 1.5.x **</p><p>**2.0.x 版本适用于 Spring Boot 2.0.x **</p><p><strong>2.1.x 版本适用于 Spring Boot 2.1.x</strong></p><h3 id="首先加入依赖管理坐标"><a class="anchor" href="#首先加入依赖管理坐标">#</a> 首先加入依赖管理坐标</h3><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><strong>添加了上述坐标就已经将 Spring Cloud Alibaba 版本锁定了，以后填入对应组件不用再写版本号</strong></p><h3 id="添加服务注册发现"><a class="anchor" href="#添加服务注册发现">#</a> 添加服务注册发现</h3><p><strong>SpringCloud Alibaba-Nacos [作为注册中心]</strong></p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="测试远程服务调用"><a class="anchor" href="#测试远程服务调用">#</a> 测试远程服务调用</h3><p>首先找到调用者确保调用者引入 open-feign 组件，被调用者是否注册服务</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">"com.atguigu.gulimall.member.dao"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@EnableDiscoveryClient</span> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@EnableFeignClients</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.atguigu.gulimall.member.feign"</span><span class="token punctuation">)</span> <span class="token comment">// 调用者开起远程调用注解指定对应的包</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallMemberApplication</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GulimallMemberApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>远程服务</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"gulimall-coupon"</span><span class="token punctuation">)</span><span class="token comment">// 指定被调用的服务名称</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CouponFeignService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"coupon/coupon/coupons"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">R</span> <span class="token function">coupons</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="nacos做配置中心"><a class="anchor" href="#nacos做配置中心">#</a> Nacos 做配置中心</h3><h4 id="1-pomxml-引入-nacos-config-starter"><a class="anchor" href="#1-pomxml-引入-nacos-config-starter">#</a> 1、pom.xml 引入 Nacos Config Starter。</h4><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- 注册中心 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="2-在需要用配置中心管理服务应用的-srcmainresourcesbootstrapproperties-配-置文件中配置-nacos"><a class="anchor" href="#2-在需要用配置中心管理服务应用的-srcmainresourcesbootstrapproperties-配-置文件中配置-nacos">#</a> 2、在需要用配置中心管理服务应用的 /src/main/resources/bootstrap.properties 配 置文件中配置 Nacos</h4><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">gulimall-coupon</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.server-addr</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:8848</span></pre></td></tr></table></figure><pre><code>// 服务启动控制台打印提示&#123;name='gulimall-coupon.properties'&#125; -》 需要一个coupon.properties的配置
Located property source: CompositePropertySource &#123;name='NACOS', propertySources=[NacosPropertySource &#123;name='gulimall-coupon.properties'&#125;]&#125;
</code></pre><h3 id="3-在-nacos-中添加配置"><a class="anchor" href="#3-在-nacos-中添加配置">#</a> 3、在 nacos 中添加配置</h3><p><strong>在 nacos 中创建一个 应用名.properties 配置文件并编写配置</strong></p><p><img data-src="../../assets/image-20210709105430805.png" alt="image-20210709105430805"></p><p><strong>动态获取配置中心</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RefreshScope</span> <span class="token comment">// 刷新配置中心注解</span></pre></td></tr></table></figure><p><strong>细节：</strong></p><p><strong>命名空间：做环境隔离，默认 public，可以根据开发测试生产环境进行隔离也可以通过微服务进行配置隔离，可通过下面配置选择对应配置中心的配置</strong></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.namespace</span><span class="token punctuation">=</span><span class="token attr-value">04a8869a-0ee9-4cc1-b198-aca7b2302a05 // 命名空间id</span></pre></td></tr></table></figure><p><strong>配置集：就是所有配置的集合</strong></p><p><strong>配置分组：可以继续进行隔离</strong></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.group</span><span class="token punctuation">=</span><span class="token attr-value">dev 配置指定分组</span></pre></td></tr></table></figure><p><strong>加载多配置集，拆分配置管理</strong></p><p><img data-src="../../assets/image-20210709113931767.png" alt="image-20210709113931767"></p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">gulimall-coupon</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.server-addr</span><span class="token punctuation">=</span><span class="token attr-value">127.0.0.1:8848</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.namespace</span><span class="token punctuation">=</span><span class="token attr-value">0a448223-e57a-4458-a89a-0e2bc70fdb3e</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[0].data-id</span><span class="token punctuation">=</span><span class="token attr-value">datasource.yml</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[0].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[0].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true // 刷新</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[1].data-id</span><span class="token punctuation">=</span><span class="token attr-value">mybatisplus.yml</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[1].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[1].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[2].data-id</span><span class="token punctuation">=</span><span class="token attr-value">other.yml</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[2].group</span><span class="token punctuation">=</span><span class="token attr-value">dev</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token attr-name">spring.cloud.nacos.config.ext-config[2].refresh</span><span class="token punctuation">=</span><span class="token attr-value">true</span></pre></td></tr></table></figure><h3 id="api网关gateway"><a class="anchor" href="#api网关gateway">#</a> API 网关 Gateway</h3><p>首先注册到 nacos 服务中心</p><p>坐标</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>排除公共包中的 mybaitsplus 数据源配置，还有个什么生成自动配置</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IdentifierGeneratorAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>编写网关配置文件</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">gateway</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token key atrule">routes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> test_baidu // 随便id不重复就行</pre></td></tr><tr><td data-num="4"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.baidu.com // 转发到那个请求</pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span> // 断言 为 true就转发</pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">-</span> Query=url<span class="token punctuation">,</span>baidu</pre></td></tr></table></figure><h2 id="前端简单复习"><a class="anchor" href="#前端简单复习">#</a> 前端简单复习</h2><h2 id="es6-新特性"><a class="anchor" href="#es6-新特性">#</a> ES6 新特性</h2><h3 id="let-声明变量"><a class="anchor" href="#let-声明变量">#</a> let 声明变量</h3><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//var 声明的变量往往会越域</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//let 声明的变量有严格局部作用域</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span></pre></td></tr><tr><td data-num="8"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ReferenceError: b is not defined</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//var 可以声明多次</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">//let 只能声明一次</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">var</span> m <span class="token operator">=</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">let</span> n <span class="token operator">=</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// let n = 4</span></pre></td></tr><tr><td data-num="15"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span> <span class="token comment">// 2</span></pre></td></tr><tr><td data-num="16"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment">// Identifier 'n' has already been declared</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//var 会变量提升</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">//let 不存在变量提升</span></pre></td></tr><tr><td data-num="19"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ReferenceError: y is not defined</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="const-声明常量只读变量"><a class="anchor" href="#const-声明常量只读变量">#</a> const 声明常量（只读变量）</h3><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 1. 声明之后不允许改变</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 2. 一但声明必须初始化，否则会报错</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">//Uncaught TypeError: Assignment to constant variable.</span></pre></td></tr></table></figure><h3 id="解构表达式"><a class="anchor" href="#解构表达式">#</a> 解构表达式</h3><h4 id="数组解构"><a class="anchor" href="#数组解构">#</a> 数组解构</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 以前我们想获取其中的值，只能通过角标。ES6 可以这样：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">;</span><span class="token comment">//x，y，z 将与 arr 中的每个位置对应来取值</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 然后打印</span></pre></td></tr><tr><td data-num="5"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="对象结构"><a class="anchor" href="#对象结构">#</a> 对象结构</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>name<span class="token operator">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>age<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>language<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 解构表达式获取值，将 person 里面每一个属性和左边对应赋值</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> language <span class="token punctuation">&#125;</span> <span class="token operator">=</span> person<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 等价于下面</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// const name = person.name;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// const age = person.age;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// const language = person.language;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 可以分别打印</span></pre></td></tr><tr><td data-num="13"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 扩展：如果想要将 name 的值赋值给其他变量，可以如下，nn 是新的变量名</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> nn<span class="token punctuation">,</span> age<span class="token punctuation">,</span> language <span class="token punctuation">&#125;</span> <span class="token operator">=</span> person<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>language<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="字符串扩展"><a class="anchor" href="#字符串扩展">#</a> 字符串扩展</h3><h4 id="几个新的-api"><a class="anchor" href="#几个新的-api">#</a> 几个新的 API</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token constant">ES6</span> 为字符串扩展了几个新的 <span class="token constant">API</span>：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">-</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">includes()</span><span class="token template-punctuation string">`</span></span>：返回布尔值，表示是否找到了参数字符串。</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">-</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">startsWith()</span><span class="token template-punctuation string">`</span></span>：返回布尔值，表示参数字符串是否在原字符串的头部。</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">-</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">endsWith()</span><span class="token template-punctuation string">`</span></span>：返回布尔值，表示参数字符串是否在原字符串的尾部。</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">"hello.vue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span></pre></td></tr><tr><td data-num="7"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".vue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span></pre></td></tr><tr><td data-num="8"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"e"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//true</span></pre></td></tr></table></figure><h4 id="字符串模板"><a class="anchor" href="#字符串模板">#</a> 字符串模板</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>模板字符串相当于加强版的字符串，用反引号 <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,除了作为普通字符串，还可以用来定义多行</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>字符串，还可以在字符串中加入变量和表达式。</pre></td></tr><tr><td data-num="3"></td><td><pre>// 1、多行字符串</pre></td></tr><tr><td data-num="4"></td><td><pre>let ss = <span class="token template-punctuation string">`</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span>div<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span>span<span class="token operator">></span>hello world<span class="token operator">&lt;</span>span<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>`</pre></td></tr><tr><td data-num="9"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 2、字符串插入变量和表达式。变量名写在 $&#123;&#125; 中，$&#123;&#125; 中可以放</span></pre></td></tr><tr><td data-num="11"></td><td><pre>入 JavaScript 表达式。</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">let</span> info <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">我是</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，今年</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>age<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 3、字符串中调用函数</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">return</span> <span class="token string">"这是一个函数"</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">let</span> sss <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">O(∩_∩)O 哈哈~，</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sss<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// O (∩_∩) O 哈哈～，这是一个函数</span></pre></td></tr></table></figure><h3 id="函数优化"><a class="anchor" href="#函数优化">#</a> 函数优化</h3><h4 id="函数参数默认值"><a class="anchor" href="#函数参数默认值">#</a> 函数参数默认值</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 在 ES6 以前，我们无法给一个函数参数设置默认值，只能采用变通写法：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 判断 b 是否为空，为空就给默认值 1</span></pre></td></tr><tr><td data-num="4"></td><td><pre>b <span class="token operator">=</span> b <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 传一个参数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 现在可以这么写：直接给参数写上默认值，没传就会自动使用默认值</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">function</span> <span class="token function">add2</span><span class="token punctuation">(</span><span class="token parameter">a <span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// 传一个参数</span></pre></td></tr><tr><td data-num="14"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">add2</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="不定参数"><a class="anchor" href="#不定参数">#</a> 不定参数</h4><p>不定参数用来表示不确定参数个数，形如，... 变量名，由... 加上一个具名参数标识符组成。 具名参数只能放在参数列表的最后，并且有且只有一个不定参数</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>values</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>values<span class="token punctuation">.</span>length<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">//2</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">fun</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token comment">//</span></pre></td></tr></table></figure><h4 id="箭头函数"><a class="anchor" href="#箭头函数">#</a> 箭头函数</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 以前声明一个方法</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// var print = function (obj) &#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// console.log(obj);</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// &#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 可以简写为：</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token parameter">obj</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 测试调用</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">print</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 两个参数的情况：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 简写为：</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 当只有一行语句，并且需要返回结果时，可以省略 &#123;&#125; , 结果会自动返回。</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">sum2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">// 测试调用</span></pre></td></tr><tr><td data-num="9"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum2</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//20</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 代码不止一行，可以用 `&#123;&#125;` 括起来</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">sum3</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">return</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 测试调用</span></pre></td></tr><tr><td data-num="16"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">sum3</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//30</span></pre></td></tr></table></figure><h4 id="实战箭头函数结合解构表达式"><a class="anchor" href="#实战箭头函数结合解构表达式">#</a> 实战：箭头函数结合解构表达式</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 需求，声明一个对象，hello 方法需要对象的个别属性</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 以前的方式：</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>name<span class="token operator">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>age<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>language<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token parameter">person</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello,"</span> <span class="token operator">+</span> person<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">// 现在的方式</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">hello2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> name <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"hello,"</span> <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 测试</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">hello2</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="对象优化"><a class="anchor" href="#对象优化">#</a> 对象优化</h3><h4 id="新增的-api"><a class="anchor" href="#新增的-api">#</a> 新增的 API</h4><pre><code>ES6 给 Object 拓展了许多新的方法，如：
- keys(obj)：获取对象的所有 key 形成的数组
- values(obj)：获取对象的所有 value 形成的数组
- entries(obj)：获取对象的所有 key 和 value 形成的二维数组。格式：`[[k1,v1],[k2,v2],...]` - assign(dest, ...src) ：将多个 src 对象的值 拷贝到 dest 中。（第一层为深拷贝，第二层为浅
拷贝）
</code></pre><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>name<span class="token operator">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>age<span class="token operator">:</span> <span class="token number">21</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>language<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//["name", "age", "language"]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//["jack", 21, Array(3)]</span></pre></td></tr><tr><td data-num="8"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//[Array(2), Array(2), Array(2)]</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">&#123;</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">const</span> source1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> b<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">const</span> source2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> c<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//Object.assign 方法的第一个参数是目标对象，后面的参数都是源对象。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> source1<span class="token punctuation">,</span> source2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token comment">//&#123;a: 1, b: 2, c: 3&#125;</span></pre></td></tr></table></figure><h4 id="声明对象简写"><a class="anchor" href="#声明对象简写">#</a> 声明对象简写</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token number">23</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">"张三"</span><span class="token comment">// 传统</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> person1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> age<span class="token operator">:</span> age<span class="token punctuation">,</span> name<span class="token operator">:</span> name <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// ES6：属性名和属性值变量名一样，可以省略</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> person2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> age<span class="token punctuation">,</span> name <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">//&#123;age: 23, name: "张三"&#125;</span></pre></td></tr></table></figure><h4 id="对象的函数属性简写"><a class="anchor" href="#对象的函数属性简写">#</a> 对象的函数属性简写</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">let</span> person <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      name<span class="token operator">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token comment">// 以前：</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token function-variable function">eat</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"在吃"</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment">// 箭头函数版：这里拿不到 this</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token function-variable function">eat2</span><span class="token operator">:</span> <span class="token parameter">food</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"在吃"</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">// 简写版：</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token function">eat3</span><span class="token punctuation">(</span><span class="token parameter">food</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">"在吃"</span> <span class="token operator">+</span> food<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    person<span class="token punctuation">.</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="对象拓展运算符"><a class="anchor" href="#对象拓展运算符">#</a> 对象拓展运算符</h4><p>拓展运算符（...）用于取出参数对象所有可遍历属性然后拷贝到当前对象。</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 1、拷贝对象（深拷贝）</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">let</span> person1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">"Amy"</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">let</span> someone <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>person1 <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someone<span class="token punctuation">)</span> <span class="token comment">//&#123;name: "Amy", age: 15&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 2、合并对象</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">let</span> age <span class="token operator">=</span> <span class="token punctuation">&#123;</span> age<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token punctuation">&#123;</span> name<span class="token operator">:</span> <span class="token string">"Amy"</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">let</span> person2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span>age<span class="token punctuation">,</span> <span class="token operator">...</span>name <span class="token punctuation">&#125;</span> <span class="token comment">// 如果两个对象的字段名重复，后面对象字</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 段值会覆盖前面对象的字段值</span></pre></td></tr><tr><td data-num="10"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person2<span class="token punctuation">)</span> <span class="token comment">//&#123;age: 15, name: "Amy"&#125;</span></pre></td></tr></table></figure><h3 id="map-和-reduce"><a class="anchor" href="#map-和-reduce">#</a> map 和 reduce</h3><p>数组中新增了 map 和 reduce 方法。</p><h4 id="map"><a class="anchor" href="#map">#</a> map:</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>：接收一个函数，将原数组中的所有元素用这个函数处理后放入新数组返回。</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'20'</span><span class="token punctuation">,</span> <span class="token string">'-5'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>arr <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=></span> <span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="reduce"><a class="anchor" href="#reduce">#</a> <strong>reduce:</strong></h4><pre><code>语法：
arr.reduce(callback,[initialValue])
reduce 为数组中的每一个元素依次执行回调函数，不包括数组中被删除或从未被赋值的元
素，接受四个参数：初始值（或者上一次回调函数的返回值），当前元素值，当前索引，调
用 reduce 的数组。
callback （执行数组中每个值的函数，包含四个参数）
1、previousValue （上一次调用回调返回的值，或者是提供的初始值（initialValue））
2、currentValue （数组中当前被处理的元素）
3、index （当前元素在数组中的索引）
4、array （调用 reduce 的数组）
initialValue （作为第一次调用 callback 的第一个参数。）
</code></pre><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 没有初始值：</span></pre></td></tr><tr><td data-num="3"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//19</span></pre></td></tr><tr><td data-num="4"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//-300// 指定初始值：</span></pre></td></tr><tr><td data-num="5"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">+</span>b<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//20</span></pre></td></tr><tr><td data-num="6"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token operator">=></span>a<span class="token operator">*</span>b<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//-0</span></pre></td></tr></table></figure><h3 id="promise-语法"><a class="anchor" href="#promise-语法">#</a> Promise 语法</h3><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 执行异步操作</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 异步操作成功 */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用 resolve，代表 Promise 将返回成功的结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用 reject，代表 Promise 会返回失败结果</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="使用箭头函数可以简写为"><a class="anchor" href="#使用箭头函数可以简写为">#</a> 使用箭头函数可以简写为：</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 执行异步操作</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">/* 异步操作成功 */</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用 resolve，代表 Promise 将返回成功的结果</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调用 reject，代表 Promise 会返回失败结果</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="promise-改造以前嵌套方"><a class="anchor" href="#promise-改造以前嵌套方">#</a> Promise 改造以前嵌套方</h4><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        url<span class="token operator">:</span> <span class="token string">"mock/user.json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询用户："</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>          <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"出现异常了："</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mock/user_corse_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>userId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询到课程："</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"出现异常了："</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">corseId</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>corseId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mock/corse_score_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>corseId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询到分数："</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"出现异常了："</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h4 id="优化处理"><a class="anchor" href="#优化处理">#</a> 优化处理</h4><p>优化：通常在企业开发中，会把 promise 封装成通用方法，如下：封装了一个通用的 get 请 求方法；</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">let</span> <span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 实际开发中会单独放到 common.js 中</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>          url<span class="token operator">:</span> url<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          type<span class="token operator">:</span> <span class="token string">"GET"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>          data<span class="token operator">:</span> data<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token comment">// 使用封装的 get 方法，实现查询分数</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"mock/user.json"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询用户："</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mock/user_corse_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询到课程："</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">mock/corse_score_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>result<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.json</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"查询到分数："</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"出现异常了："</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>通过比较，我们知道了 Promise 的扁平化设计理念，也领略了这种 <code>上层设计</code> 带来的好处。 我们的项目中会使用到这种异步处理的方式；</p><h3 id="模块化"><a class="anchor" href="#模块化">#</a> 模块化</h3><h4 id="什么是模块化"><a class="anchor" href="#什么是模块化">#</a> 什么是模块化</h4><p>模块化就是把代码进行拆分，方便重复利用。类似 java 中的导包：要使用一个包，必须先<br>导包。而 JS 中没有包的概念，换来的是 模块。<br>模块功能主要由两个命令构成： <code>export</code> 和 <code>import</code> 。</p><ul><li><code>export</code> 命令用于规定模块的对外接口。</li><li><code>import</code> 命令用于导入其他模块提供的功能。</li></ul><h4 id="export"><a class="anchor" href="#export">#</a> export</h4><p>比如我定义一个 js 文件:hello.js，里面有一个对象</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我可以使用 export 将这个对象导出：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">export</span> <span class="token punctuation">&#123;</span>util<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>当然，也可以简写为：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>export</code> 不仅可以导出对象，一切 JS 变量都可以导出。比如：基本类型变量、函数、数组、对象。</p><p>当要导出多个值时，还可以简写。比如我有一个文件：user.js：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> name <span class="token operator">=</span> <span class="token string">"jack"</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> age <span class="token operator">=</span> <span class="token number">21</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">export</span> <span class="token punctuation">&#123;</span>name<span class="token punctuation">,</span>age<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>省略名称</strong><br>上面的导出代码中，都明确指定了导出的变量名，这样其它人在导入使用时就必须准确写出<br>变量名，否则就会出错。<br>因此 js 提供了 <code>default</code> 关键字，可以对导出的变量名进行省略</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>例如：</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 无需声明对象的名字</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sum</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这样，当使用者导入时，可以任意起名字</p><h4 id="3-import"><a class="anchor" href="#3-import">#</a> 3）、import</h4><p>使用 <code>export</code> 命令定义了模块的对外接口以后，其他 JS 文件就可以通过 <code>import</code> 命令加载这<br>个模块。<br>例如我要使用上面导出的 util：</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 导入 utilimport util from 'hello.js'</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 调用 util 中的属性</span></pre></td></tr><tr><td data-num="3"></td><td><pre>util<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 要批量导入前面导出的 name 和 age：</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>name<span class="token punctuation">,</span> age<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'user.js'</span></pre></td></tr><tr><td data-num="6"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">" , 今年"</span><span class="token operator">+</span> age <span class="token operator">+</span><span class="token string">"岁了"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>但是上面的代码暂时无法测试，因为浏览器目前还不支持 ES6 的导入和导出功能。除非借<br>助于工具，把 ES6 的语法进行编译降级到 ES5，比如 <code>Babel-cli</code> 工具</p><h2 id="商品服务-api"><a class="anchor" href="#商品服务-api">#</a> 商品服务 - API</h2><h3 id="获取分类树利用递归"><a class="anchor" href="#获取分类树利用递归">#</a> <strong>获取分类树，利用递归</strong></h3><p><strong>方法一：普通方法，首先找到所有顶层分类，然后利用递归获取子集分类</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> <span class="token function">listTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> entityList <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> <span class="token function">getChildren</span><span class="token punctuation">(</span>entityList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> collect<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> entityList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> resList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> entity <span class="token operator">:</span> entityList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> entity<span class="token punctuation">.</span><span class="token function">getCatLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                resList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getChildrens</span><span class="token punctuation">(</span>entity<span class="token punctuation">,</span> entityList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> resList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">CategoryEntity</span> <span class="token function">getChildrens</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> entity<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> entityList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> resList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> en <span class="token operator">:</span> entityList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>entity<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> en<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                resList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getChildrens</span><span class="token punctuation">(</span>en<span class="token punctuation">,</span> entityList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        entity<span class="token punctuation">.</span><span class="token function">setChildrens</span><span class="token punctuation">(</span>resList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> entity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>方法二：利用 java8 流处理</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> <span class="token function">listTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> entityList <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> entityList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>category <span class="token operator">-></span> category<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>menu <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                    menu<span class="token punctuation">.</span><span class="token function">setChildrens</span><span class="token punctuation">(</span><span class="token function">getChildrenJava8</span><span class="token punctuation">(</span>menu<span class="token punctuation">,</span>entityList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token keyword">return</span> menu<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span> collect<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> <span class="token function">getChildrenJava8</span><span class="token punctuation">(</span><span class="token class-name">CategoryEntity</span> menu<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> entityList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> entityList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>e <span class="token operator">-></span> e<span class="token punctuation">.</span><span class="token function">getParentCid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> menu<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>e <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">setChildrens</span><span class="token punctuation">(</span><span class="token function">getChildrenJava8</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>entityList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">return</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="整合前端分类管理"><a class="anchor" href="#整合前端分类管理">#</a> 整合前端分类管理</h3><p>前端使用的人人 fast，可以在系统管理中添加商品分类，添加就是向数据库添加，前端动态获取，renren-fast 已经帮我们做好了。</p><p>根据人人路径规则新增路径为 product/category 对应 url product-category 对应着去建 vue 页面也就是先建 product 文件夹下面创建 category.vue</p><p>更改地址为网关地址</p><p>然后把人人后端注册到 nacos 注册中心</p><h3 id="配置网关"><a class="anchor" href="#配置网关">#</a> <strong>配置网关</strong></h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> admin_routes</pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//renren<span class="token punctuation">-</span>fast  <span class="token punctuation">-</span><span class="token punctuation">-</span> lb<span class="token punctuation">:</span>负载均衡</pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">-</span> Path=/api/<span class="token important">**</span>   <span class="token punctuation">-</span><span class="token punctuation">-</span> 只要请求路径带api后面路径随意</pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token key atrule">filters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">-</span> RewritePath=/api/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">></span>.<span class="token important">*)</span><span class="token punctuation">,</span>/renren<span class="token punctuation">-</span>fast/$\<span class="token punctuation">&#123;</span>segment<span class="token punctuation">&#125;</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> 拦截路径对路径进行替换</pre></td></tr></table></figure><h3 id="网关解决统一-跨域问题"><a class="anchor" href="#网关解决统一-跨域问题">#</a> <strong>网关解决统一 跨域问题</strong></h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">CorsWebFilter</span> <span class="token function">corsWebFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">UrlBasedCorsConfigurationSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlBasedCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">CorsConfiguration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorsConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 配置跨域</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 允许所有请求头</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        configuration<span class="token punctuation">.</span><span class="token function">addAllowedHeader</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 允许所有请求方式</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        configuration<span class="token punctuation">.</span><span class="token function">addAllowedMethod</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 允许哪个来源</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        configuration<span class="token punctuation">.</span><span class="token function">addAllowedOrigin</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 允许带 cookie</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        configuration<span class="token punctuation">.</span><span class="token function">setAllowCredentials</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        configuration<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">3600l</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 配置多久来一次预检请求</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        source<span class="token punctuation">.</span><span class="token function">registerCorsConfiguration</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CorsWebFilter</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="微服务整合swagger文档"><a class="anchor" href="#微服务整合swagger文档">#</a> <strong>微服务整合 swagger 文档</strong></h4><p><a href="https://oxyzen-wxf.github.io/worknote/swagger-1/">https://oxyzen-wxf.github.io/worknote/swagger-1/</a></p><h3 id="配置product服务的网关"><a class="anchor" href="#配置product服务的网关">#</a> 配置 Product 服务的网关</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> product_routes</pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>prodcut</pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">-</span> Path=/api/product/<span class="token important">**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token key atrule">filters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">-</span> RewritePath=/api/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">></span>.<span class="token important">*)</span><span class="token punctuation">,</span>/$\<span class="token punctuation">&#123;</span>segment<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          // 注意格式，模糊匹配放后面，精准度高的放在前面，要不然会被模糊匹配的拦截导致路由失败</pre></td></tr><tr><td data-num="8"></td><td><pre>    //访问路径：http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>88/api/product/category/listTree</pre></td></tr><tr><td data-num="9"></td><td><pre>    //转换路径：http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>10000/product/category/listTree</pre></td></tr><tr><td data-num="10"></td><td><pre>    //匹配表达：<span class="token punctuation">-</span> RewritePath=/api/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">></span>.<span class="token important">*)</span><span class="token punctuation">,</span>/$\<span class="token punctuation">&#123;</span>segment<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="商品增删改查等前端后端操作"><a class="anchor" href="#商品增删改查等前端后端操作">#</a> 商品增删改查等前端后端操作</h3><h4 id="拖拽功能"><a class="anchor" href="#拖拽功能">#</a> 拖拽功能：</h4><p><strong>实现不同分类拖拽换分类的操作</strong></p><table><thead><tr><th style="text-align:center">参数</th><th style="text-align:center">说明</th><th style="text-align:center">类型</th><th style="text-align:center">可选值</th><th style="text-align:center">默认值</th></tr></thead><tbody><tr><td style="text-align:center">allow-drop</td><td style="text-align:center">拖拽时判定目标节点能否被放置。 <code>type</code> 参数有三种情况：'prev'、'inner' 和 'next'，分别表示放置在目标节点前、插入至目标节点和放置在目标节点后</td><td style="text-align:center">Function(draggingNode, dropNode, type)</td><td style="text-align:center">—</td><td style="text-align:center">—</td></tr><tr><td style="text-align:center">draggable</td><td style="text-align:center">是否开启拖拽节点功能</td><td style="text-align:center">boolean</td><td style="text-align:center">—</td><td style="text-align:center">false</td></tr></tbody><tbody><tr><td style="text-align:center">事件名称</td><td style="text-align:center">说明</td><td style="text-align:center">回调参数</td></tr><tr><td style="text-align:center">:-----------:</td><td style="text-align:center">:--------------------------------:</td><td style="text-align:center">:----------------------------------------------------------:</td></tr><tr><td style="text-align:center">node-drag-end</td><td style="text-align:center">拖拽结束时（可能未成功）触发的事件</td><td style="text-align:center">共四个参数，依次为：被拖拽节点对应的 Node、结束拖拽时最后进入的节点（可能为空）、被拖拽节点的放置位置（before、after、inner）、event</td></tr></tbody></table><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">allowDrop</span><span class="token punctuation">(</span><span class="token parameter">draggingNode<span class="token punctuation">,</span> dropNode<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token comment">//1、被拖动的当前节点以及所在的父节点总层数不能大于 3</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token comment">//1）、被拖动的当前节点总层数</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"allowDrop:"</span><span class="token punctuation">,</span> draggingNode<span class="token punctuation">,</span> dropNode<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token comment">//</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countNodeLevel</span><span class="token punctuation">(</span>draggingNode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token comment">// 当前正在拖动的节点 + 父节点所在的深度不大于 3 即可</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">let</span> deep <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>maxLevel <span class="token operator">-</span> draggingNode<span class="token punctuation">.</span>level<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"深度："</span><span class="token punctuation">,</span> deep<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token comment">//   this.maxLevel</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token string">"inner"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// console.log(</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">//   `this.maxLevel：$&#123;this.maxLevel&#125;；draggingNode.data.catLevel：$&#123;draggingNode.data.catLevel&#125;；dropNode.level：$&#123;dropNode.level&#125;`</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// );</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> deep <span class="token operator">+</span> dropNode<span class="token punctuation">.</span>level <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> deep <span class="token operator">+</span> dropNode<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>level <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token function">countNodeLevel</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token comment">// 找到所有子节点，求出最大深度</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>level <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxLevel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>maxLevel <span class="token operator">=</span> node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>level<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countNodeLevel</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr></table></figure><p><strong>拖拽添加数组看源码</strong></p><p><strong>批量勾选删除</strong></p><table><thead><tr><th>方法名</th><th>说明</th><th>参数</th></tr></thead><tbody><tr><td>getCheckedNodes</td><td>若节点可被选择（即 <code>show-checkbox</code> 为 <code>true</code> ），则返回目前被选中的节点所组成的数组</td><td>(leafOnly, includeHalfChecked) 接收两个 boolean 类型的参数，1. 是否只是叶子节点，默认值为 <code>false</code> 2. 是否包含半选节点，默认值为 <code>false</code></td></tr></tbody></table><h3 id="品牌管理"><a class="anchor" href="#品牌管理">#</a> 品牌管理</h3><h4 id="利用人人自动生成工具生成前端代码"><a class="anchor" href="#利用人人自动生成工具生成前端代码">#</a> 利用人人自动生成工具生成前端代码</h4><p>优化生成的页面</p><p>滑动按钮监听 change 时间进行更新</p><table><thead><tr><th>参数</th><th>说明</th><th>类型</th><th>可选值</th><th>默认值</th></tr></thead><tbody><tr><td>active-value</td><td>switch 打开时的值</td><td>boolean / string / number</td><td>—</td><td>true</td></tr><tr><td>inactive-value</td><td>switch 关闭时的值</td><td>boolean / string / number</td><td>—</td><td>false</td></tr></tbody></table><h3 id="云存储-文件存储"><a class="anchor" href="#云存储-文件存储">#</a> 云存储 - 文件存储</h3><p>创建 bucket</p><p><img data-src="../../assets/image-20210713095759050.png" alt="image-20210713095759050"></p><p><strong>使用下面方式进行文件云存储</strong></p><p><img data-src="../../assets/image-20210713100138907.png" alt="image-20210713100138907"></p><p><strong>阿里云 oss 坐标</strong></p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.aliyun.oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>aliyun-sdk-oss<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.10.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><strong>这里使用 springcloudalibaba 里面的坐标</strong></p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvc3ByaW5nLWNsb3VkLWFsaWJhYmEvYmxvYi9tYXN0ZXIvUkVBRE1FLXpoLm1k">https://github.com/alibaba/spring-cloud-alibaba/blob/master/README-zh.md</span></p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.1.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span> </pre></td></tr><tr><td data-num="12"></td><td><pre>// 根据选定的阿里微服务管理的坐标点进去去找对应的oss坐标，版本对不上则找不到对应的坐标</pre></td></tr></table></figure><p><strong>不配置如下配置测试将会报错</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token key atrule">alicloud</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token key atrule">oss</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing.aliyuncs.com</pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">access-key</span><span class="token punctuation">:</span> key</pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">secret-key</span><span class="token punctuation">:</span> secret</pre></td></tr></table></figure><p><strong>测试代码</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">OSSClient</span> ossClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">FileNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"D:\\img\\study\\帅气.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 上传文件流</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        ossClient<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span><span class="token string">"guli-wxf"</span><span class="token punctuation">,</span> <span class="token string">"ceshi.jpg"</span><span class="token punctuation">,</span> inputStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 关闭客户端</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        ossClient<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"上传成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>存储方式采用前端直穿 oss，管后端要签名认证，如果 oss 放在 common 里面所有的服务即使不用 oss 也要配置，所以创建新的服务专门提供第三方服务</strong></p><p><strong>阿里文档地址：<span class="exturl" data-url="aHR0cHM6Ly9oZWxwLmFsaXl1bi5jb20vZG9jdW1lbnRfZGV0YWlsLzMxOTI2Lmh0bWw/c3BtPWEyYzRnLjExMTg2NjIzLjYuMTc0Ni4xNDc4NmUwMjNsenNSdQ==">https://help.aliyun.com/document_detail/31926.html?spm=a2c4g.11186623.6.1746.14786e023lzsRu</span></strong></p><p><strong>获取签名代码</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>gulimall<span class="token punctuation">.</span>thirdparty<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span></span>OSS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">BinaryUtil</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">MatchMode</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>oss<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">PolicyConditions</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">R</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">LocalDate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>format<span class="token punctuation">.</span></span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">LinkedHashMap</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre> * @author WangXuefeng</pre></td></tr><tr><td data-num="25"></td><td><pre> * @version 1.0</pre></td></tr><tr><td data-num="26"></td><td><pre> * @date 2021/7/13 11:46</pre></td></tr><tr><td data-num="27"></td><td><pre> * @description</pre></td></tr><tr><td data-num="28"></td><td><pre> */</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OssController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token class-name">OSS</span> ossClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.cloud.alicloud.access-key&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> accessId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.cloud.alicloud.oss.endpoint&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> endpoint<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;spring.cloud.alicloud.bucket&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> bucket<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/oss/policy"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">R</span> <span class="token function">policy</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">String</span> host <span class="token operator">=</span> <span class="token string">"https://"</span> <span class="token operator">+</span> bucket <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> endpoint<span class="token punctuation">;</span> <span class="token comment">//host 的格式为 bucketname.endpoint</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">//callbackUrl 为 上传回调服务器的 URL，请将下面的 IP 和 Port 配置为您自己的真实信息。</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token class-name">String</span> callbackUrl <span class="token operator">=</span> <span class="token string">"http://88.88.88.88:8888"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token class-name">DateTimeFormatter</span> formatter <span class="token operator">=</span> <span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span><span class="token function">ofPattern</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token class-name">String</span> format <span class="token operator">=</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>formatter<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token class-name">String</span> dir <span class="token operator">=</span> format <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">;</span> <span class="token comment">// 用户上传文件时指定的前缀。</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">long</span> expireTime <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">long</span> expireEndTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token class-name">Date</span> expiration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>expireEndTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token comment">// PostObject 请求最大可支持的文件大小为 5 GB，即 CONTENT_LENGTH_RANGE 为 5*1024*1024*1024。</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token class-name">PolicyConditions</span> policyConds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_CONTENT_LENGTH_RANGE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1048576000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            policyConds<span class="token punctuation">.</span><span class="token function">addConditionItem</span><span class="token punctuation">(</span><span class="token class-name">MatchMode<span class="token punctuation">.</span>StartWith</span><span class="token punctuation">,</span> <span class="token class-name">PolicyConditions</span><span class="token punctuation">.</span>COND_KEY<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token class-name">String</span> postPolicy <span class="token operator">=</span> ossClient<span class="token punctuation">.</span><span class="token function">generatePostPolicy</span><span class="token punctuation">(</span>expiration<span class="token punctuation">,</span> policyConds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> binaryData <span class="token operator">=</span> postPolicy<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token class-name">String</span> encodedPolicy <span class="token operator">=</span> <span class="token class-name">BinaryUtil</span><span class="token punctuation">.</span><span class="token function">toBase64String</span><span class="token punctuation">(</span>binaryData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token class-name">String</span> postSignature <span class="token operator">=</span> ossClient<span class="token punctuation">.</span><span class="token function">calculatePostSignature</span><span class="token punctuation">(</span>postPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> respMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"accessid"</span><span class="token punctuation">,</span> accessId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"policy"</span><span class="token punctuation">,</span> encodedPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">,</span> postSignature<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"dir"</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            respMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"expire"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>expireEndTime <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token comment">// respMap.put("expire", formatISO8601Date(expiration));</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> respMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token comment">// Assert.fail(e.getMessage());</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            ossClient<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>配置网关</strong></p><p>需要地址形式：localhost:88/api/thirdparty/oss/policy</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> third_party_routes</pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>third<span class="token punctuation">-</span>party</pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">-</span> Path=/api/thirdparty/<span class="token important">**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token key atrule">filters</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token punctuation">-</span> RewritePath=/api/thirdparty/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">></span>.<span class="token important">*)</span><span class="token punctuation">,</span>/$\<span class="token punctuation">&#123;</span>segment<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>前端上传</strong></p><p>设置阿里 oss 跨域访问</p><p><img data-src="../../assets/image-20210713123532380.png" alt="image-20210713123532380"></p><h3 id="前端表单检验规则"><a class="anchor" href="#前端表单检验规则">#</a> <strong>前端表单检验规则</strong></h3><p>** 自定义校验规则：自定义校验 callback 必须被调用。 **</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>rules<span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>          pass<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token punctuation">&#123;</span> validator<span class="token operator">:</span> validatePass<span class="token punctuation">,</span> trigger<span class="token operator">:</span> 'blur' <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>          <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>代码</strong></p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>firstLetter<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token function-variable function">validator</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> value<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"检索首字母不能为空！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-zA-Z]$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"检索首字母必须为a-z或者A-Z！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>              <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            trigger<span class="token operator">:</span> <span class="token string">"blur"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr></table></figure><p><strong>Js 里面为什么 0==“” 会是 true?</strong></p><p><strong><em>v-model</em>.<em>number</em></strong></p><p><code>number</code> 修饰符会把 <code>v-model</code> 的值转换成数值类型。</p><h3 id="后端校验jsr303"><a class="anchor" href="#后端校验jsr303">#</a> 后端校验 JSR303</h3><p><img data-src="../../assets/image-20210713161614806.png" alt="image-20210713161614806"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/save"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Valid</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BrandEntity</span> brand<span class="token punctuation">,</span> <span class="token class-name">BindingResult</span> result<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">// 获取校验错误结果</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>error <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token comment">// 错误消息的提示</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token class-name">String</span> message <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token comment">// 获取错误的属性的名字</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token class-name">String</span> field <span class="token operator">=</span> error<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span><span class="token string">"提交的数据不合法"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		brandService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>brand<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="统一处理异常"><a class="anchor" href="#统一处理异常">#</a> 统一处理异常</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 集中处理所有异常</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//@ResponseBody</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//@ControllerAdvice(basePackages = "com.atguigu.gulimall.product.controller")</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@RestControllerAdvice</span><span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.atguigu.gulimall.product.controller"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallExceptionControllerAdvice</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value<span class="token operator">=</span> <span class="token class-name">MethodArgumentNotValidException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">handleVaildException</span><span class="token punctuation">(</span><span class="token class-name">MethodArgumentNotValidException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"数据校验出现问题&#123;&#125;，异常类型：&#123;&#125;"</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">BindingResult</span> bindingResult <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">getBindingResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> errorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        bindingResult<span class="token punctuation">.</span><span class="token function">getFieldErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>fieldError<span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            errorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>fieldError<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fieldError<span class="token punctuation">.</span><span class="token function">getDefaultMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnume</span><span class="token punctuation">.</span>VAILD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">BizCodeEnume</span><span class="token punctuation">.</span>VAILD_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span>errorMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"错误："</span><span class="token punctuation">,</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">BizCodeEnume</span><span class="token punctuation">.</span>UNKNOW_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">BizCodeEnume</span><span class="token punctuation">.</span>UNKNOW_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="后端分组校验使用"><a class="anchor" href="#后端分组校验使用">#</a> 后端分组校验使用</h3><p>每个校验的注解中都有 groups 属性，我们只需要创建不同分组的接口就行，我们就可以使用接口名地 不同来区分分组，例如添加请求我们需要实体类 id 必须为空，更新时候 id 必须不为空，我就可以这样做</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">AddGroup</span>   <span class="token class-name">UpdateGroup</span> 这两个接口分别是添加与更新分组</pre></td></tr></table></figure><p><strong>例子</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//brandId 上面的 NotNull 和 Null 注解的 groups 就说明了在哪种分组的时候生效，那么怎么指定哪个生效呢？，看下面 controller 中的代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	 * 品牌 id</pre></td></tr><tr><td data-num="5"></td><td><pre>	 */</pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token annotation punctuation">@NotNull</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"修改必须指定品牌id"</span><span class="token punctuation">,</span>groups <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">UpdateGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	<span class="token annotation punctuation">@Null</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"新增不能指定id"</span><span class="token punctuation">,</span>groups <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">AddGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	<span class="token annotation punctuation">@TableId</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">Long</span> brandId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	 * 品牌名</pre></td></tr><tr><td data-num="12"></td><td><pre>	 */</pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token annotation punctuation">@NotBlank</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">"品牌名必须提交"</span><span class="token punctuation">,</span>groups <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">AddGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">UpdateGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Documented</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Validated</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 指定分组的接口 是数组形式的</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Validated</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">AddGroup</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">BrandEntity</span> brand <span class="token comment">/*BindingResult result*/</span><span class="token punctuation">)</span><span class="token comment">// 此保存接口明确指出校验使用 AddGroup 分组，也就是 Null 注解生效</span></pre></td></tr></table></figure><p><strong>注意：这个时候使用了分组，那么所有的校验注解都要使用分组否则不生效，有点麻烦呀～～</strong></p><h3 id="自定义校验"><a class="anchor" href="#自定义校验">#</a> 自定义校验</h3><p>模仿已写好的注解来实现，想要实现自定义校验就要遵循 JSR303 的规则，注解加校验器的联合使用。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> METHOD<span class="token punctuation">,</span> FIELD<span class="token punctuation">,</span> ANNOTATION_TYPE<span class="token punctuation">,</span> CONSTRUCTOR<span class="token punctuation">,</span> PARAMETER<span class="token punctuation">,</span> TYPE_USE <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Documented</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">NotNull</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 下面的这三个属性是自定义注解中默认的三个</span></pre></td></tr><tr><td data-num="7"></td><td><pre>	</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 配置错误提示消息，默认去指定配置文件中找，这里我们复制他的配置文件名来修改</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	<span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"&#123;javax.validation.constraints.NotNull.message&#125;"</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>    </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 支持分组</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 附带的</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>自定义注解</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Documented</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Constraint</span><span class="token punctuation">(</span>validatedBy <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token class-name">ListValueConstraintValidator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">// 需要指定我们自定的校验器</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> METHOD<span class="token punctuation">,</span> FIELD<span class="token punctuation">,</span> ANNOTATION_TYPE<span class="token punctuation">,</span> CONSTRUCTOR<span class="token punctuation">,</span> PARAMETER<span class="token punctuation">,</span> TYPE_USE <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ListValue</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> <span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"&#123;com.atguigu.common.valid.ListValue.message&#125;"</span><span class="token punctuation">;</span><span class="token comment">// 去我们的配置文件获取</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Payload</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">payload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">com.atguigu.common.valid.ListValue.message</span><span class="token punctuation">=</span><span class="token attr-value">必须提交指定的值</span></pre></td></tr></table></figure><p><strong>校验器：需要实现 ConstraintValidator 接口并将注解和指定类型作为泛型实现</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListValueConstraintValidator</span> <span class="token keyword">implements</span> <span class="token class-name">ConstraintValidator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ListValue</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 初始化方法</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token class-name">ListValue</span> constraintAnnotation<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vals <span class="token operator">=</span> constraintAnnotation<span class="token punctuation">.</span><span class="token function">vals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> val <span class="token operator">:</span> vals<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 判断是否校验成功</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     *</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @param value 需要校验的值</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @param context</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isValid</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> value<span class="token punctuation">,</span> <span class="token class-name">ConstraintValidatorContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> set<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="spu与sku编写前端添加分类属性等页面功能"><a class="anchor" href="#spu与sku编写前端添加分类属性等页面功能">#</a> spu 与 sku，编写前端添加分类属性等页面功能</h3><h4 id="父子组件传值的使用"><a class="anchor" href="#父子组件传值的使用">#</a> <strong>父子组件传值的使用</strong></h4><p>el<strong> 树形节点点击事件</strong></p><table><thead><tr><th style="text-align:left">事件名称</th><th style="text-align:left">说明</th><th style="text-align:left">回调参数</th></tr></thead><tbody><tr><td style="text-align:left">node-click</td><td style="text-align:left">节点被点击时的回调</td><td style="text-align:left">共三个参数，依次为：传递给 <code>data</code> 属性的数组中该节点所对应的对象、节点对应的 Node、节点组件本身。</td></tr></tbody></table><p>子组件给父组件传值</p><pre><code class="language-vue">this.$emit(&quot;tree-node-click&quot;, data, node, component);
</code></pre><p><strong>this.$emit (&quot;点击事件名称&quot;, 传递的数据)</strong></p><p>父组件使用，可以在使用子组件的时候填上子组件传递的事件，并监听事件获取传递地 数据</p><pre><code class="language-vue">&lt;category @tree-node-click=&quot;treeNodeClick&quot;&gt;&lt;/category&gt;
// 并在methods中监听该方法
</code></pre><p><strong>比如当子组件进行添加，或者任何操作，完成后需要告诉父组件，让父组件监听子组件，就可以达到子组件完成了任务，父组件根据子组件完成进行监听处理后续操作</strong></p><h3 id="后端对应有关联表的多对多情况在数据多的情况不建议进行连表查询入left-right-join-连接查询"><a class="anchor" href="#后端对应有关联表的多对多情况在数据多的情况不建议进行连表查询入left-right-join-连接查询">#</a> 后端对应有关联表的多对多情况，在数据多的情况不建议进行连表查询入 left right join 连接查询</h3><h3 id="平台属性"><a class="anchor" href="#平台属性">#</a> 平台属性</h3><h3 id="商品维护"><a class="anchor" href="#商品维护">#</a> 商品维护</h3><div class="note info"><p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZGZ6ai9wLzEzNjEwOTc1Lmh0bWw=">https://www.cnblogs.com/dfzj/p/13610975.html</span></p><p><strong>sync 语法糖：</strong></p><p>当遇到上面情况，子组件想改变父组件中的值，可以直接写成：</p><p>子组件中写成：this.$emit (&quot;'update:visable', false&quot;) ------ visable 是父组件中的值 'update:visable' 是固定写法，传 false 过去</p><p>父组件中写成：:visable.sync = &quot;visable&quot;</p><p><strong>总结：这样写虽然子组件看不出简化，但是使用父组件的人就用得很爽，不需要再 @自定义事件名 = 自定义函数名 ($event), 然后再父组件的 methons 去改变这个值</strong></p></div><h4 id="非父子组件传值"><a class="anchor" href="#非父子组件传值">#</a> <strong>非父子组件传值</strong></h4><p><strong>非父子组件（跨级组件和兄弟组件）通信时，使用了 <code>bus</code> （中央事件总线）的一个方法，用来触发和接收事件，进一步起到通信的作用。</strong></p><p>公共 js</p><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 公共 bus.js</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 非父子组件之间传值，需要定义个公共的公共实例文件 bus.js，作为中间仓库来传值，不然路由组件之间达不到传值的效果</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 组件 B</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 引入公共的 bug，来做为中间传达的工具</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> Bus <span class="token keyword">from</span> <span class="token string">'./bus.js'</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 在 mounted 进行监听</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 用 $on 事件来接收参数</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    Bus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'msgToB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment">//data 就是组件 A 传过来的值</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr></table></figure><figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre>组件<span class="token constant">A</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 引入公共的 bug，来做为中间传达的工具</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> Bus <span class="token keyword">from</span> <span class="token string">'./bus.js'</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 创建方法进行传递值</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// 用 $emit 事件来传递参数</span></pre></td></tr><tr><td data-num="7"></td><td><pre>Bus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'msgToB'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>msg<span class="token punctuation">)</span></pre></td></tr></table></figure><h4 id="vue组件间的通信pubsub-js实现步骤解析"><a class="anchor" href="#vue组件间的通信pubsub-js实现步骤解析">#</a> Vue 组件间的通信 pubsub-js 实现步骤解析</h4><h3 id="后端-当传给前端的属性为空的时候就指定告诉springmvc为空的属性不转为json传过去"><a class="anchor" href="#后端-当传给前端的属性为空的时候就指定告诉springmvc为空的属性不转为json传过去">#</a> 后端 当传给前端的属性为空的时候就指定告诉 springmvc 为空的属性不转为 json 传过去</h3><p>使用这个注解</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>annotation</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">ElementType</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Retention</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Target</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>ANNOTATION_TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>PARAMETER<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token annotation punctuation">@JacksonAnnotation</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">JsonInclude</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span>ALWAYS<span class="token punctuation">;</span> <span class="token comment">// 默认为 JsonInclude.Include.ALWAYS 总是转为 json，可以修改为为空不转 json</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@JsonInclude</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">JsonInclude<span class="token punctuation">.</span>Include</span><span class="token punctuation">.</span>NON_EMPTY<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> childrens<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="发布商品"><a class="anchor" href="#发布商品">#</a> 发布商品</h3><p><strong>VO: 前端后端传输模型</strong></p><p><strong>TO: 分布式之间传输数据模型</strong></p><h3 id="微服务idea内存过大设置每个服务占用的最大内存和统一重启方法"><a class="anchor" href="#微服务idea内存过大设置每个服务占用的最大内存和统一重启方法">#</a> 微服务 idea 内存过大设置每个服务占用的最大内存，和统一重启方法</h3><p><img data-src="../../assets/image-20210715115834734.png" alt="image-20210715115834734"></p><p><img data-src="../../assets/image-20210715120853298.png" alt="image-20210715120853298"></p><p><strong>-Xmx100m 最大内存 100</strong></p><h3 id="spu管理"><a class="anchor" href="#spu管理">#</a> spu 管理</h3><p>配置传送前端格式化事件配置</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">jackson</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">date-format</span><span class="token punctuation">:</span> yyyy<span class="token punctuation">-</span>MM<span class="token punctuation">-</span>dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss</pre></td></tr></table></figure><h3 id="仓储服务管理"><a class="anchor" href="#仓储服务管理">#</a> 仓储服务管理</h3><ul><li>添加注册中心</li><li>配置服务名称</li><li>开启服务注册发现</li><li>开启 mybatisplus 包扫描</li><li>开启事务注解</li><li>添加网关路径</li></ul><h3 id="配置打印sql语句"><a class="anchor" href="#配置打印sql语句">#</a> 配置打印 sql 语句</h3><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">logging</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">level</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">com.atguigu</span><span class="token punctuation">:</span> debug 指定哪个包</pre></td></tr></table></figure><h3 id="分布式基础总结"><a class="anchor" href="#分布式基础总结">#</a> 分布式基础总结</h3><p><img data-src="../../assets/image-20210716100153871.png" alt="image-20210716100153871"></p><h1 id="分布式高级"><a class="anchor" href="#分布式高级">#</a> 分布式高级</h1><h3 id="elasticsearch"><a class="anchor" href="#elasticsearch">#</a> Elasticsearch</h3><p>** 笔记地址：**<a href="https://oxyzen-wxf.github.io/database/elasticsearch/es-1/">https://oxyzen-wxf.github.io/database/elasticsearch/es-1/</a></p><p><img data-src="../../assets/image-20210719111953469.png" alt="image-20210719111953469"></p><h3 id="商城业务"><a class="anchor" href="#商城业务">#</a> 商城业务</h3><p>ES 嵌入需要指定属性为 nested 类型，要不然就会发生错误查询</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT my-index<span class="token number">-000001</span>/_doc/<span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"group"</span> <span class="token operator">:</span> <span class="token string">"fans"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"user"</span> <span class="token operator">:</span> <span class="token punctuation">[</span> </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"first"</span> <span class="token operator">:</span> <span class="token string">"John"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"last"</span> <span class="token operator">:</span>  <span class="token string">"Smith"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token property">"first"</span> <span class="token operator">:</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"last"</span> <span class="token operator">:</span>  <span class="token string">"White"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 能查到数据，不应该查到</span></pre></td></tr><tr><td data-num="18"></td><td><pre>GET my-index<span class="token number">-000001</span>/_search</pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"user.first"</span><span class="token operator">:</span> <span class="token string">"Alice"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#123;</span> <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"user.last"</span><span class="token operator">:</span>  <span class="token string">"Smith"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="创建商品上架的es"><a class="anchor" href="#创建商品上架的es">#</a> 创建商品上架的 es</h4><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>PUT product</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"skuId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token property">"spuId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"skuTitle"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token property">"analyzer"</span><span class="token operator">:</span> <span class="token string">"ik_smart"</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token property">"skuPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token property">"skuImg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token property">"saleCount"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token property">"hasStock"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"boolean"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token property">"hotScore"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token property">"brandId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token property">"catalogId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token property">"brandName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token property">"brandImg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token property">"catalogName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token property">"attrs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"nested"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>          <span class="token property">"attrId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token property">"attrName"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token property">"index"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>          <span class="token property">"attrValue"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span></pre></td></tr><tr><td data-num="66"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建对应的实体类</p><h4 id="上架实现"><a class="anchor" href="#上架实现">#</a> 上架实现</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">up</span><span class="token punctuation">(</span><span class="token class-name">Long</span> spuId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">// 查询 spu 规格属性</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProductAttrValueEntity</span><span class="token punctuation">></span></span> valueEntities <span class="token operator">=</span> attrValueService<span class="token punctuation">.</span><span class="token function">baseAttrlistforspu</span><span class="token punctuation">(</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> attrIds <span class="token operator">=</span> valueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-></span> v<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrEntity</span><span class="token punctuation">></span></span> attrWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        attrWrapper<span class="token punctuation">.</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AttrEntity</span><span class="token operator">::</span><span class="token function">getSearchType</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>attrIds<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">AttrEntity</span><span class="token operator">::</span><span class="token function">getAttrId</span><span class="token punctuation">,</span>attrIds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrEntity</span><span class="token punctuation">></span></span> attrEntities <span class="token operator">=</span> attrService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>attrWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> attrIds2 <span class="token operator">=</span> attrEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-></span> attr<span class="token punctuation">.</span><span class="token function">getAttrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> idSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>attrIds2<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">></span></span> attrsList <span class="token operator">=</span> valueEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>v <span class="token operator">-></span> idSet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>attrIds2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span> attrs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel<span class="token punctuation">.</span>Attrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">return</span> attrs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 查询当前 spuid 对应的所有 sku 信息品牌名字</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">></span></span> wrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        wrapper<span class="token punctuation">.</span><span class="token function">lambda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSpuId</span><span class="token punctuation">,</span>spuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">></span></span> skuInfoEntityList <span class="token operator">=</span> skuInfoService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> longList <span class="token operator">=</span> skuInfoEntityList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SkuInfoEntity</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// TODO 远程调用，库存系统查询是否有库存</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">></span></span> stockMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> skuHasStock <span class="token operator">=</span> wareFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>longList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuHasStockVo</span><span class="token punctuation">></span></span> data <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            stockMap <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> <span class="token class-name">SkuHasStockVo</span><span class="token operator">::</span><span class="token function">getHasStock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"库存服务查询异常：原因&#123;&#125;"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 封装每个 sku 信息</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">></span></span> finalStockMap <span class="token operator">=</span> stockMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">></span></span> uoProducts <span class="token operator">=</span> skuInfoEntityList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>sku <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 组装需要的数据</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sku<span class="token punctuation">,</span> esModel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setSkuPrice</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setSkuImg</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuDefaultImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// TODO 热度评分。</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setHotScore</span><span class="token punctuation">(</span><span class="token number">0l</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token class-name">BrandEntity</span> brandEntity <span class="token operator">=</span> brandService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>esModel<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandEntity<span class="token punctuation">.</span><span class="token function">getLogo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token class-name">CategoryEntity</span> categoryEntity <span class="token operator">=</span> categoryService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>esModel<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>categoryEntity<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>            esModel<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrsList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>finalStockMap <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                esModel<span class="token punctuation">.</span><span class="token function">setHasStock</span><span class="token punctuation">(</span>finalStockMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sku<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">return</span> esModel<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 存到 es</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">R</span> r <span class="token operator">=</span> searchFeignService<span class="token punctuation">.</span><span class="token function">productStatusUp</span><span class="token punctuation">(</span>uoProducts<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre><span class="token comment">//            成功 修改 spu 的状态</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            baseMapper<span class="token punctuation">.</span><span class="token function">updateSpuStatus</span><span class="token punctuation">(</span>spuId<span class="token punctuation">,</span> <span class="token class-name">ProductConstant<span class="token punctuation">.</span>StatusEnum</span><span class="token punctuation">.</span>SPU_UP<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token comment">// 远程失败</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token comment">// TODO 重复调用？接口幂等性</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>保存 es 接口</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">productStatusUp</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">></span></span> skuEsModels<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//1. 在 es 中建立索引，建立号映射关系（doc/json/product-mapping.json）</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">//2. 在 ES 中保存这些数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuEsModel</span> skuEsModel <span class="token operator">:</span> skuEsModels<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token comment">// 构造保存请求</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            indexRequest<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token class-name">String</span> jsonString <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>skuEsModel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            indexRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token class-name">XContentType</span><span class="token punctuation">.</span>JSON<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            bulkRequest<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">BulkResponse</span> bulk <span class="token operator">=</span> esRestClient<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">,</span> <span class="token class-name">MyElasticSearchConfig</span><span class="token punctuation">.</span>COMMON_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">//TODO 如果批量错误</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">boolean</span> hasFailures <span class="token operator">=</span> bulk<span class="token punctuation">.</span><span class="token function">hasFailures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>bulk<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"商品上架完成：&#123;&#125;"</span><span class="token punctuation">,</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> hasFailures<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="首页整合thyemleaf模板"><a class="anchor" href="#首页整合thyemleaf模板">#</a> 首页整合 thyemleaf 模板</h4><h4 id="nginx搭建域名"><a class="anchor" href="#nginx搭建域名">#</a> nginx 搭建域名</h4><p><img data-src="../../assets/image-20210720101757402.png" alt="image-20210720101757402"></p><p><img data-src="../../assets/image-20210720102322050.png" alt="image-20210720102322050"></p><p><strong>配置 nginx 反向代理直接代理对应服务</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>server <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>		listen       <span class="token number">9001</span>;</pre></td></tr><tr><td data-num="3"></td><td><pre>		server_name	 localhost;</pre></td></tr><tr><td data-num="4"></td><td><pre>		</pre></td></tr><tr><td data-num="5"></td><td><pre>		location ~ /eduservice/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8001;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		</pre></td></tr><tr><td data-num="9"></td><td><pre>		location ~ /eduoss/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8002;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>		</pre></td></tr><tr><td data-num="13"></td><td><pre>		location ~ /eduvod/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8003;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>		</pre></td></tr><tr><td data-num="17"></td><td><pre>		location ~ /educms/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8004;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>				</pre></td></tr><tr><td data-num="21"></td><td><pre>		location ~ /edumsm/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8005;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>						</pre></td></tr><tr><td data-num="25"></td><td><pre>		location ~ /educenter/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8150;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>								</pre></td></tr><tr><td data-num="29"></td><td><pre>		location ~ /eduorder/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8007;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>										</pre></td></tr><tr><td data-num="33"></td><td><pre>		location ~ /staservice/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            proxy_pass   http<span class="token operator">:</span><span class="token comment">//127.0.0.1:8008;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="配置nginx代理网关"><a class="anchor" href="#配置nginx代理网关">#</a> 配置 nginx 代理网关</h4><p>首先配置上游服务器配置配置网关地址，可以配置多个，在总配置文件的 http 里面配置</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>upstream gulimall<span class="token punctuation">&#123;</span><span class="token comment">// 组名 gulimall</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       server <span class="token number">192.168</span>.<span class="token number">1.5</span><span class="token operator">:</span><span class="token number">88</span>; <span class="token comment">// 可配置多个网关地址</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>修改 conf.d 下面的.conf 的动态代理 改为上游服务器的组名</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>upstream gulimall<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>       server <span class="token number">192.168</span>.<span class="token number">1.5</span><span class="token operator">:</span><span class="token number">88</span>;</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>配置网关</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_host_routes</pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>prodcut</pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">-</span> Host=<span class="token important">**.gulimall.com</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> 对应主机匹配</pre></td></tr></table></figure><p><img data-src="../../assets/image-20210720110239463.png" alt="image-20210720110239463"></p><p>nginx 反向代理不配置默认会丢失很多请求信息在转发给网关的时候</p><p><strong>设置代理的时候带上 header 的主机头</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>location / <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        proxy_set_header Host $host;-- 带上请求头</pre></td></tr><tr><td data-num="3"></td><td><pre>        proxy_pass http<span class="token operator">:</span><span class="token comment">//gulimall;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="压力测试"><a class="anchor" href="#压力测试">#</a> 压力测试</h3><h4 id="性能指标"><a class="anchor" href="#性能指标">#</a> 性能指标</h4><ul><li><p>响应时间（Response Time: RT）</p></li><li><p>响应时间指用户从客户端发起一个请求开始，到客户端接收到从服务器端返回的响</p></li><li><p>应结束，整个过程所耗费的时间。</p></li><li><p>HPS（Hits Per Second） ：每秒点击次数，单位是次 / 秒。</p></li><li><p>TPS（Transaction per Second）：系统每秒处理交易数，单位是笔 / 秒。</p></li><li><p>QPS（Query per Second）：系统每秒处理查询次数，单位是次 / 秒。</p></li><li><p>对于互联网业务中，如果某些业务有且仅有一个请求连接，那么 TPS=QPS=HPS，一<br>般情况下用 TPS 来衡量整个业务流程，用 QPS 来衡量接口查询次数，用 HPS 来表<br>示对服务器单击请求。</p></li><li><p>无论 TPS、QPS、HPS, 此指标是衡量系统处理能力非常重要的指标，越大越好，根据经<br>验，一般情况下：</p><ul><li><p>金融行业：1000TPS~50000TPS，不包括互联网化的活动</p></li><li><p>保险行业：100TPS~100000TPS，不包括互联网化的活动</p></li><li><p>制造行业：10TPS~5000TPS</p></li><li><p>互联网电子商务：10000TPS~1000000TPS</p></li><li><p>互联网中型网站：1000TPS~50000TPS</p></li><li><p>互联网小型网站：500TPS~10000TPS</p></li></ul></li><li><p>最大响应时间（Max Response Time） 指用户发出请求或者指令到系统做出反应（响应）<br>的最大时间。</p></li><li><p>最少响应时间（Mininum ResponseTime） 指用户发出请求或者指令到系统做出反应（响<br>应）的最少时间。</p></li><li><p>90% 响应时间（90% Response Time） 是指所有用户的响应时间进行排序，第 90% 的响<br>应时间。</p></li><li><p>从外部看，性能测试主要关注如下三个指标</p><ul><li>吞吐量：每秒钟系统能够处理的请求数、任务数。</li><li>响应时间：服务处理一个请求或一个任务的耗时。</li><li>错误率：一批请求中结果出错的请求所占比例。</li></ul></li></ul><h4 id="jmeter"><a class="anchor" href="#jmeter">#</a> JMeter</h4><h5 id="1-jmeter-安装"><a class="anchor" href="#1-jmeter-安装">#</a> 1、JMeter 安装</h5><p><span class="exturl" data-url="aHR0cHM6Ly9qbWV0ZXIuYXBhY2hlLm9yZy9kb3dubG9hZF9qbWV0ZXIuY2dp">https://jmeter.apache.org/download_jmeter.cgi</span></p><p>下载对应的压缩包，解压运行 jmeter.bat 即可</p><h5 id="2-jmeter-压测示例"><a class="anchor" href="#2-jmeter-压测示例">#</a> 2、JMeter 压测示例</h5><p><img data-src="../../assets/image-20210720114650078.png" alt="image-20210720114650078"></p><p>性能简单优化，调优 jvm 内存，设置 tomcat 最大连接数等等</p><p><strong>启动压测 &amp; 查看分析结果</strong></p><ul><li><p>有错误率同开发确认，确定是否允许错误的发生或者错误率允许在多大的范围内；</p></li><li><p>Throughput 吞吐量每秒请求的数大于并发数，则可以慢慢的往上面增加；若在压测的机<br>器性能很好的情况下，出现吞吐量小于并发数，说明并发数不能再增加了，可以慢慢的<br>往下减，找到最佳的并发数；</p></li><li><p>压测结束，登陆相应的 web 服务器查看 CPU 等性能指标，进行数据的分析；</p></li><li><p>最大的 tps，不断的增加并发数，加到 tps 达到一定值开始出现下降，那么那个值就是<br>最大的 tps。</p></li><li><p>最大的并发数：最大的并发数和最大的 tps 是不同的概率，一般不断增加并发数，达到<br>一个值后，服务器出现请求超时，则可认为该值为最大的并发数。</p></li><li><p>压测过程出现性能瓶颈，若压力机任务管理器查看到的 cpu、网络和 cpu 都正常，未达到 90% 以上，则可以说明服务器有问题，压力机没有问题。</p></li></ul><p><strong>影响性能考虑点包括：</strong><br>数据库、应用程序、中间件（tomact、Nginx）、网络和操作系统等方面</p><p>首先考虑自己的应用属于 CPU 密集型还是 IO 密集型</p><h5 id="3-jmeter-address-already-in-use-错误解决"><a class="anchor" href="#3-jmeter-address-already-in-use-错误解决">#</a> 3、JMeter Address Already in use 错误解决</h5><p>windows 本身提供的端口访问机制的问题。<br>Windows 提供给 TCP/IP 链接的端口为 1024-5000，并且要四分钟来循环回收他们。就导致<br>我们在短时间内跑大量的请求时将端口占满了。</p><ol><li><p>cmd 中，用 regedit 命令打开注册表</p></li><li><p>在 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters 下，<br>1 . 右击 parameters，添加一个新的 DWORD，名字为 MaxUserPort<br>2 . 然后双击 MaxUserPort，输入数值数据为 65534，基数选择十进制（如果是分布式运<br>行的话，控制机器和负载机器都需要这样操作哦）</p></li><li><p>修改配置完毕之后记得重启机器才会生效<br><span class="exturl" data-url="aHR0cHM6Ly9zdXBwb3J0Lm1pY3Jvc29mdC5jb20vemgtY24vaGVscC8xOTYyNzEvd2hlbi15b3UtdHJ5LXRvLWNvbm5lY3QtZnJvbS10Y3AtcG9ydHMtZ3JlYQ==">https://support.microsoft.com/zh-cn/help/196271/when-you-try-to-connect-from-tcp-ports-grea</span><br>ter-than-5000-you-receive-t<br>TCPTimedWaitDelay：30</p></li></ol><h3 id="性能监控"><a class="anchor" href="#性能监控">#</a> 性能监控</h3><p><strong>3、jconsole 与 jvisualvm</strong></p><p>Jdk 的两个小工具 jconsole、jvisualvm（升级版的 jconsole）; 通过命令行启动，可监控本地和 远程应用。远程应用需要配置</p><h5 id="1-jvisualvm-能干什么"><a class="anchor" href="#1-jvisualvm-能干什么">#</a> 1、jvisualvm 能干什么</h5><p>监控内存泄露，跟踪垃圾回收，执行时内存、cpu 分析，线程分析...<img data-src="../../assets/image-20210720140407062.png" alt="image-20210720140407062"></p><p>运行：正在运行的<br>休眠：sleep<br>等待：wait<br>驻留：线程池里面的空闲线程<br>监视：阻塞的线程，正在等待锁</p><h5 id="2-安装插件方便查看-gc"><a class="anchor" href="#2-安装插件方便查看-gc">#</a> 2、安装插件方便查看 gc</h5><p><img data-src="../../assets/image-20210720141252787.png" alt="image-20210720141252787"></p><p><img data-src="../../assets/image-20210720141303042.png" alt="image-20210720141303042"></p><h5 id="4-监控指标"><a class="anchor" href="#4-监控指标">#</a> 4、监控指标</h5><p><strong>1、中间件指标</strong></p><p><img data-src="../../assets/image-20210720145953970.png" alt="image-20210720145953970"></p><ul><li>当前正在运行的线程数不能超过设定的最大值。一般情况下系统性能较好的情况下，线<br>程数最小值设置 50 和最大值设置 200 比较合适。</li><li>当前运行的 JDBC 连接数不能超过设定的最大值。一般情况下系统性能较好的情况下，<br>JDBC 最小值设置 50 和最大值设置 200 比较合适。</li><li>ＧＣ频率不能频繁，特别是 FULL GC 更不能频繁，一般情况下系统性能较好的情况下，<br>JVM 最小堆大小和最大堆大小分别设置 1024M 比较合适。</li></ul><p><strong>2、数据库指标</strong></p><p><img data-src="../../assets/image-20210720150036381.png" alt="image-20210720150036381"></p><ul><li>SQL 耗时越小越好，一般情况下微秒级别。</li><li>命中率越高越好，一般情况下不能低于 95%。</li><li>锁等待次数越低越好，等待时间越短越好。</li></ul><p><img data-src="../../assets/image-20210720150110977.png" alt="image-20210720150110977"></p><ul><li>中间件越多，性能损失越大，大多都损失在网络交互了；</li><li>业务：<ul><li>Db（MySQL 优化）</li><li>模板的渲染速度（缓存）</li><li>静态资源</li></ul></li></ul><p><strong>性能优化：数据库，中间件，jvm 堆内存，缓存，</strong></p><h5 id="5-jvm-分析调优"><a class="anchor" href="#5-jvm-分析调优">#</a> 5、JVM 分析 &amp; 调优</h5><p>jvm 调优，调的是稳定，并不能带给你性能的大幅提升。服务稳定的重要性就不用多说了， 保证服务的稳定，gc 永远会是 Java 程序员需要考虑的不稳定因素之一。复杂和高并发下的 服务，必须保证每次 gc 不会出现性能下降，各种性能指标不会出现波动，gc 回收规律而且 干净，找到合适的 jvm 设置。Full gc 最会影响性能，根据代码问题，避免 full gc 频率。可以 适当调大年轻代容量，让大对象可以在年轻代触发 yong gc，调整大对象在年轻代的回收频 次，尽可能保证大对象在年轻代回收，减小老年代缩短回收时间；</p><p><strong>可以增大老年代新生代的内存来减少内存溢出和频繁的 gc</strong></p><p><img data-src="../../assets/image-20210720185050237.png" alt="image-20210720185050237"></p><h4 id="nginx动静分离"><a class="anchor" href="#nginx动静分离">#</a> <strong>Nginx 动静分离</strong></h4><p><img data-src="../../assets/image-20210720152500563.png" alt="image-20210720152500563"></p><p>将静态文件导入 nginx 中，配置好对应配置，比如在 nginx 下面创建 static 目录，页面中引用的所有静态资源访问 /static 下面的静态资源。</p><p><strong>nginx 配置</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>location /static/ <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	root   /usr/share/nginx/html; --页面中的html页面访问/static下面的静态文件</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="缓存"><a class="anchor" href="#缓存">#</a> 缓存</h3><h4 id="整合redis"><a class="anchor" href="#整合redis">#</a> 整合 Redis</h4><ul><li>添加依赖</li><li>简单配置</li><li>使用配置好的 Template</li></ul><h4 id="修改为redis缓存后进行压力测试"><a class="anchor" href="#修改为redis缓存后进行压力测试">#</a> 修改为 Redis 缓存后进行压力测试</h4><p><strong>报错：产生堆外内存溢出：OutOfDirectMemoryError</strong></p><p><strong>原因：springboot 2.0 默认使用 lettuce 作为操作 redis 的客户端。使用 netty 进行网络通信，lettuce 的 bug 导致 netty 堆外内存溢出，netty 如果没有指定堆外内存，则选择默认使用 idea 上面设置的 jvm 内存 - Xmx300m</strong></p><p><strong>解决方案：1、升级 lettuce 客户端。2、使用 jedis 客户端</strong></p><p>改为 jedis</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.lettuce<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>					<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lettuce-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="缓存穿透"><a class="anchor" href="#缓存穿透">#</a> 缓存穿透</h3><p><img data-src="../../assets/image-20210721112822369.png" alt="image-20210721112822369"></p><p><img data-src="../../assets/image-20210721113250622.png" alt=""></p><p><img data-src="../../assets/image-20210721113309325.png" alt="image-20210721113309325"></p><p><strong>解决：</strong></p><ul><li>空结果缓存：解决缓存穿透</li><li>设置过期时间（加随机值）：解决缓存雪崩</li><li>枷锁：解决缓存击穿</li></ul><h4 id="单体枷锁"><a class="anchor" href="#单体枷锁">#</a> <strong>单体枷锁</strong></h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> dataJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"getCatalogJson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"缓存命中....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getCatalogJsonDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJsonDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token class-name">String</span> dataJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"getCatalogJson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询了数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// 将数据库的多次查询变为一次</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> selectList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">//1、查出所有分类</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token comment">//1、1）查出所有一级分类</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> level1Categorys <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token comment">// 封装数据</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> parentCid <span class="token operator">=</span> level1Categorys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-></span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token comment">//1、每一个的一级分类，查到这个一级分类的二级分类</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> categoryEntities <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token comment">//2、封装上面的结果</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span></span> catelog2Vos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>categoryEntities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    catelog2Vos <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                        <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token comment">//1、找当前二级分类的三级分类封装成 vo</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> level3Catelog <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>level3Catelog <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">></span></span> category3Vos <span class="token operator">=</span> level3Catelog<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                                <span class="token comment">//2、封装成指定格式</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                                <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span> category3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>                                <span class="token keyword">return</span> category3Vo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                            catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>category3Vos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>                        <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token keyword">return</span> catelog2Vos<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token class-name">String</span> s <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>parentCid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"getCatalogJson"</span><span class="token punctuation">,</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token keyword">return</span> parentCid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分布式下加锁"><a class="anchor" href="#分布式下加锁">#</a> <strong>分布式下加锁</strong></h4><p><img data-src="../../assets/image-20210721113926133.png" alt="image-20210721113926133"></p><p><img data-src="../../assets/image-20210721114525059.png" alt="image-20210721114525059"></p><p><img data-src="../../assets/image-20210721123207150.png" alt="image-20210721123207150"></p><p>使用 Redis NX 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">// 占分布式锁。。。执行业务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token comment">// 枷锁成功 执行业务</span></pre></td></tr><tr><td data-num="6"></td><td><pre>             <span class="token comment">// 枷锁成功 执行业务</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataFromDb <span class="token operator">=</span> <span class="token function">getDataFromDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除锁别人可以继续进入</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getDataFromDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ops <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">String</span> dataJson <span class="token operator">=</span> ops<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"getCatalogJson"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> result <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>dataJson<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"查询了数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 将数据库的多次查询变为一次</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> selectList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">//1、查出所有分类</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">//1、1）查出所有一级分类</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> level1Categorys <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token comment">// 封装数据</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> parentCid <span class="token operator">=</span> level1Categorys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-></span> k<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">//1、每一个的一级分类，查到这个一级分类的二级分类</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> categoryEntities <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">//2、封装上面的结果</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span></span> catelog2Vos <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>categoryEntities <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                catelog2Vos <span class="token operator">=</span> categoryEntities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l2 <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token class-name">Catelog2Vo</span> catelog2Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token comment">//1、找当前二级分类的三级分类封装成 vo</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryEntity</span><span class="token punctuation">></span></span> level3Catelog <span class="token operator">=</span> <span class="token function">getParent_cid</span><span class="token punctuation">(</span>selectList<span class="token punctuation">,</span> l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>level3Catelog <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">></span></span> category3Vos <span class="token operator">=</span> level3Catelog<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>l3 <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                            <span class="token comment">//2、封装成指定格式</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                            <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span> category3Vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Catelog2Vo<span class="token punctuation">.</span>Category3Vo</span><span class="token punctuation">(</span>l2<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getCatId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> l3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>                            <span class="token keyword">return</span> category3Vo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        catelog2Vo<span class="token punctuation">.</span><span class="token function">setCatalog3List</span><span class="token punctuation">(</span>category3Vos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>                    <span class="token keyword">return</span> catelog2Vo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token keyword">return</span> catelog2Vos<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token class-name">String</span> s <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>parentCid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        ops<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"getCatalogJson"</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">return</span> parentCid<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="问题"><a class="anchor" href="#问题">#</a> <strong>问题</strong></h4><p><strong>如果 getDataFromDb 出现问题那么将会出现死锁</strong></p><p><img data-src="../../assets/image-20210721123608799.png" alt="image-20210721123608799"></p><p><img data-src="../../assets/image-20210721123626920.png" alt="image-20210721123626920"></p><p><strong>防止死锁</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">// 占分布式锁。。。执行业务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token comment">// 设置过期时间</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//            redisTemplate.ex</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token comment">// 枷锁成功 执行业务</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataFromDb <span class="token operator">=</span> <span class="token function">getDataFromDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除锁别人可以继续进入</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="../../assets/image-20210721124041029.png" alt="image-20210721124041029"></p><p><strong>防止因为设置过期，业务时间长，导致失效，然后删掉了其他人的锁，导致很多人都能进入抢锁</strong></p><p><strong>解决方法：设置当前令牌，删除的时候去查询对应令牌是否是自己的再去删除</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">// 占分布式锁。。。执行业务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">// 设置过期时间</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//            redisTemplate.ex</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// 枷锁成功 执行业务</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataFromDb <span class="token operator">=</span> <span class="token function">getDataFromDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token class-name">String</span> lockV <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>uuid<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>lockV<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token comment">// 删除自己的锁</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 删除锁别人可以继续进入</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="../../assets/image-20210721124815220.png" alt="image-20210721124815220"></p><p><strong>上面代码问题：在获取 lock 值进行匹配的时候，网络通信造成的时间导致值传过来的时候正好 redis 中的 lock 值过期了，这边获取到值进行比对肯定成功则删除的时候很可能删除别人的 lock，导致很多人都可以占到坑，所以再加一层，需要保证查询对比与删除是原子性的。</strong></p><p><img data-src="../../assets/image-20210721125128908.png" alt="image-20210721125128908"></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5yZWRpcy5jbi9jb21tYW5kcy9zZXQuaHRtbA==">http://www.redis.cn/commands/set.html</span></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">getCatalogJsonDBWithRedisLockFinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token comment">// 占分布式锁。。。执行业务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">Boolean</span> lock <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token comment">// 设置过期时间</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//            redisTemplate.ex</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// 枷锁成功 执行业务</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Catelog2Vo</span><span class="token punctuation">></span><span class="token punctuation">></span></span> dataFromDb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                dataFromDb <span class="token operator">=</span> <span class="token function">getDataFromDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token comment">// 确保删除对比为原子性使用 redis 解锁脚本</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token class-name">String</span> script <span class="token operator">=</span> <span class="token string">"if redis.call(\"get\",KEYS[1]) == ARGV[1]\n"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                        <span class="token string">"then\n"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token string">"    return redis.call(\"del\",KEYS[1])\n"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                        <span class="token string">"else\n"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token string">"    return 0\n"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                        <span class="token string">"end"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token class-name">Integer</span> lock1 <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"lock"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">return</span> dataFromDb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">getCatalogJsonDBWithRedisLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>redis 分布式锁，看官网，使用 set ex nx 设置占坑，使用 uuid 随机做值，删除使用解锁脚本保证原子性。</strong></p><p><strong>分布式锁：<a href="https://oxyzen-wxf.github.io/computer-science/java/microservice/lock-1/">https://oxyzen-wxf.github.io/computer-science/java/microservice/lock-1/</a></strong></p><h2 id="检索服务"><a class="anchor" href="#检索服务">#</a> 检索服务</h2><h3 id="搭建环境"><a class="anchor" href="#搭建环境">#</a> 搭建环境</h3><p><span class="exturl" data-url="aHR0cDovL3huLS1zZWFyY2gtOWU0ajkyNmszZ2Q0cTFlY3h6Ymp5ZC5ndWxpbWFsbC5jb20=">检索服务跳转 search.gulimall.com</span>: 首先在本地配置好域名映射同样映射到虚拟机地址，让该域名可以访问虚拟机，并上传静态文件到 nginx，修改 nginx 监听地址改为 *.gulimall.com，并配置网关对该域名转发对应得检索服务。</p><p><strong>监听</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>listen  <span class="token number">80</span>;</pre></td></tr><tr><td data-num="2"></td><td><pre>server_name  gulimall.com *.gulimall.com;   所有访问nginx服务器，域名匹配都将进行监听 这里可以多配置域名 空格隔开</pre></td></tr></table></figure><p><strong>转发</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>location / <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    proxy_set_header Host $host;    -- nginx转发网关的时候带上主机地址</pre></td></tr><tr><td data-num="3"></td><td><pre>	proxy_pass http<span class="token operator">:</span><span class="token comment">//gulimall;   	</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     -- 因为总配置中设置了上游网关地址并且名字是gulimall，所以这里是配置告诉nginx转发给谁，统一转发给网关</pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>网关配置</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_host_routes</pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>prodcut</pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">-</span> Host=gulimall.com</pre></td></tr><tr><td data-num="5"></td><td><pre>              </pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> gulimall_search_routes</pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//gulimall<span class="token punctuation">-</span>search</pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token key atrule">predicates</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token punctuation">-</span> Host=search.gulimall.com</pre></td></tr></table></figure><p><img data-src="../../assets/image-20210722093601805.png" alt="image-20210722093601805"></p><h3 id="检索"><a class="anchor" href="#检索">#</a> 检索</h3><p><strong>封装检索条件交给 es 处理然后返回给前端</strong></p><h4 id="es检索语句"><a class="anchor" href="#es检索语句">#</a> Es 检索语句</h4><div class="note info"><p>模糊匹配 (match)，过滤 (filter)（按照属性、分类、品牌、价格区间，库存），排序 (sort)，分页 (from,size)，高亮</p><p>最难是聚合分析，根据查询出来的数据进行聚合分析出对应的属性分类品牌等等...</p></div><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>GET product/_search</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>          <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token property">"skuTitle"</span><span class="token operator">:</span> <span class="token string">"xiaomi"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token property">"brandId"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="16"></td><td><pre>              <span class="token string">"4"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>              <span class="token string">"2"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>          <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token property">"catalogId"</span><span class="token operator">:</span> <span class="token string">"1439"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"attrs"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>              <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                      <span class="token property">"attrs.attrId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                        <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                      <span class="token property">"attrs.attrValue"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                        <span class="token string">"250"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token string">"250"</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>          <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token property">"hasStock"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="55"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>          <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token property">"skuPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>              <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>              <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">4500</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token property">"skuPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token property">"skuTitle"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;b style='color:red'>"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/b>"</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="es聚合语句"><a class="anchor" href="#es聚合语句">#</a> Es 聚合语句</h4><p>上面查询嵌套属性需要指定 nested，同样聚合的时候也需要指定</p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 聚合查询</pre></td></tr><tr><td data-num="2"></td><td><pre>GET gulimall_product/_search</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token property">"match_all"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token property">"brand_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token property">"brand_name_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"brand_img_agg"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandImg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token property">"catalog_agg"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"catalogId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token property">"catalog_name_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"catalogName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="38"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token property">"attr_agg"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"attrs"</span></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token property">"attrId_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="51"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token property">"attrName_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>              <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="57"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token property">"attrValue_agg"</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>              <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrValue"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="63"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>完整查询</strong></p><figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre># 模糊匹配，过滤（按照属性、分类、品牌、价格区间，库存），排序，分页，高亮</pre></td></tr><tr><td data-num="2"></td><td><pre># 最难是聚合分析，根据查询出来的数据进行聚合分析出对应的属性分类品牌等等...</pre></td></tr><tr><td data-num="3"></td><td><pre>GET gulimall_product/_search</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token property">"skuTitle"</span><span class="token operator">:</span> <span class="token string">"xiaomi"</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token property">"brandId"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="18"></td><td><pre>              <span class="token string">"4"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token string">"2"</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token property">"catalogId"</span><span class="token operator">:</span> <span class="token string">"1439"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"attrs"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>              <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token property">"must"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                      <span class="token property">"attrs.attrId"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                        <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"2"</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                      <span class="token property">"attrs.attrValue"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                        <span class="token string">"250"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                        <span class="token string">"250"</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>          <span class="token property">"term"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token property">"hasStock"</span><span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="57"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>          <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token property">"skuPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>              <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="63"></td><td><pre>              <span class="token property">"lte"</span><span class="token operator">:</span> <span class="token number">4500</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token property">"sort"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token property">"skuPrice"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token property">"order"</span><span class="token operator">:</span> <span class="token string">"desc"</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>  <span class="token property">"from"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token property">"highlight"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token property">"skuTitle"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token property">"pre_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;b style='color:red'>"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token property">"post_tags"</span><span class="token operator">:</span> <span class="token string">"&lt;/b>"</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token property">"brand_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="92"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token property">"brand_name_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="97"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token property">"brand_img_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"brandImg"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="102"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="103"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token property">"catalog_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>      <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"catalogId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="111"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="112"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token property">"catalog_name_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"catalogName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="116"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="117"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    <span class="token property">"attr_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>      <span class="token property">"nested"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"attrs"</span></pre></td></tr><tr><td data-num="124"></td><td><pre>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token property">"attrId_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>          <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>            <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrId"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>            <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="130"></td><td><pre>          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="131"></td><td><pre>          <span class="token property">"aggs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>            <span class="token property">"attrName_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>              <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>                <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrName"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="135"></td><td><pre>                <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="136"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            <span class="token property">"attrValue_agg"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>              <span class="token property">"terms"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>                <span class="token property">"field"</span><span class="token operator">:</span> <span class="token string">"attrs.attrValue"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="141"></td><td><pre>                <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">10</span></pre></td></tr><tr><td data-num="142"></td><td><pre>              <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>          <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="149"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="es代码"><a class="anchor" href="#es代码">#</a> Es 代码</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//1、动态构建出查询需要的 DSL 语句</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">//1、准备检索请求</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token function">buildSearchRequest</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token comment">//2、执行检索请求</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token class-name">SearchResponse</span> response <span class="token operator">=</span> esRestClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">MyElasticSearchConfig</span><span class="token punctuation">.</span>COMMON_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token comment">//3、分析响应数据，封装成我们需要的格式</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            result <span class="token operator">=</span> <span class="token function">buildSearchResult</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 构建结果数据</pre></td></tr><tr><td data-num="25"></td><td><pre>     * 模糊匹配，过滤（按照属性、分类、品牌，价格区间，库存），完成排序、分页、高亮，聚合分析功能</pre></td></tr><tr><td data-num="26"></td><td><pre>     * @param response</pre></td></tr><tr><td data-num="27"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="28"></td><td><pre>     */</pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SearchResult</span> <span class="token function">buildSearchResult</span><span class="token punctuation">(</span><span class="token class-name">SearchResponse</span> response<span class="token punctuation">,</span><span class="token class-name">SearchParam</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">//1、返回的所有查询到的商品</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token class-name">SearchHits</span> hits <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuEsModel</span><span class="token punctuation">></span></span> esModels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token comment">// 遍历所有商品信息</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> hits<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token class-name">String</span> sourceAsString <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token class-name">SkuEsModel</span> esModel <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>sourceAsString<span class="token punctuation">,</span> <span class="token class-name">SkuEsModel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token comment">// 判断是否按关键字检索，若是就显示高亮，否则不显示</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                    <span class="token comment">// 拿到高亮信息显示标题</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                    <span class="token class-name">HighlightField</span> skuTitle <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"skuTitle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    <span class="token class-name">String</span> skuTitleValue <span class="token operator">=</span> skuTitle<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                    esModel<span class="token punctuation">.</span><span class="token function">setSkuTitle</span><span class="token punctuation">(</span>skuTitleValue<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                esModels<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>esModel<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setProduct</span><span class="token punctuation">(</span>esModels<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">//2、当前商品涉及到的所有属性信息</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">></span></span> attrVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">// 获取属性信息的聚合</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token class-name">ParsedNested</span> attrsAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"attr_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token class-name">ParsedLongTerms</span> attrIdAgg <span class="token operator">=</span> attrsAgg<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"attr_id_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> attrIdAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span> attrVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>AttrVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token comment">//1、得到属性的 id</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token keyword">long</span> attrId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            attrVo<span class="token punctuation">.</span><span class="token function">setAttrId</span><span class="token punctuation">(</span>attrId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token comment">//2、得到属性的名字</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token class-name">ParsedStringTerms</span> attrNameAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"attr_name_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token class-name">String</span> attrName <span class="token operator">=</span> attrNameAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            attrVo<span class="token punctuation">.</span><span class="token function">setAttrName</span><span class="token punctuation">(</span>attrName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token comment">//3、得到属性的所有值</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token class-name">ParsedStringTerms</span> attrValueAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"attr_value_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> attrValues <span class="token operator">=</span> attrValueAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">-></span> item<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            attrVo<span class="token punctuation">.</span><span class="token function">setAttrValue</span><span class="token punctuation">(</span>attrValues<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>            attrVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>attrVo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setAttrs</span><span class="token punctuation">(</span>attrVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token comment">//3、当前商品涉及到的所有品牌信息</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">></span></span> brandVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">// 获取到品牌的聚合</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token class-name">ParsedLongTerms</span> brandAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> brandAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>            <span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span> brandVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>BrandVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>            <span class="token comment">//1、得到品牌的 id</span></pre></td></tr><tr><td data-num="89"></td><td><pre>            <span class="token keyword">long</span> brandId <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>            brandVo<span class="token punctuation">.</span><span class="token function">setBrandId</span><span class="token punctuation">(</span>brandId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token comment">//2、得到品牌的名字</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token class-name">ParsedStringTerms</span> brandNameAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brand_name_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>            <span class="token class-name">String</span> brandName <span class="token operator">=</span> brandNameAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            brandVo<span class="token punctuation">.</span><span class="token function">setBrandName</span><span class="token punctuation">(</span>brandName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>            <span class="token comment">//3、得到品牌的图片</span></pre></td></tr><tr><td data-num="98"></td><td><pre>            <span class="token class-name">ParsedStringTerms</span> brandImgAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"brand_img_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>            <span class="token class-name">String</span> brandImg <span class="token operator">=</span> brandImgAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>            brandVo<span class="token punctuation">.</span><span class="token function">setBrandImg</span><span class="token punctuation">(</span>brandImg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>            brandVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brandVo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setBrands</span><span class="token punctuation">(</span>brandVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre>        <span class="token comment">//4、当前商品涉及到的所有分类信息</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token comment">// 获取到分类的聚合</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">></span></span> catalogVos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token class-name">ParsedLongTerms</span> catalogAgg <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"catalog_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Terms<span class="token punctuation">.</span>Bucket</span> bucket <span class="token operator">:</span> catalogAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>            <span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span> catalogVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>CatalogVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>            <span class="token comment">// 得到分类 id</span></pre></td></tr><tr><td data-num="113"></td><td><pre>            <span class="token class-name">String</span> keyAsString <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>            catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogId</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>keyAsString<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>            <span class="token comment">// 得到分类名</span></pre></td></tr><tr><td data-num="117"></td><td><pre>            <span class="token class-name">ParsedStringTerms</span> catalogNameAgg <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">getAggregations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"catalog_name_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>            <span class="token class-name">String</span> catalogName <span class="token operator">=</span> catalogNameAgg<span class="token punctuation">.</span><span class="token function">getBuckets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKeyAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>            catalogVo<span class="token punctuation">.</span><span class="token function">setCatalogName</span><span class="token punctuation">(</span>catalogName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>            catalogVos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>catalogVo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre></pre></td></tr><tr><td data-num="123"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setCatalogs</span><span class="token punctuation">(</span>catalogVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token comment">//=============== 以上可以从聚合信息中获取 ====================//</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token comment">//5、分页信息 - 页码</span></pre></td></tr><tr><td data-num="126"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token comment">//5、1 分页信息、总记录数</span></pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token keyword">long</span> total <span class="token operator">=</span> hits<span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token comment">//5、2 分页信息 - 总页码 - 计算</span></pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token keyword">int</span> totalPages <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>total <span class="token operator">%</span> <span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>total <span class="token operator">/</span> <span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>total <span class="token operator">/</span> <span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setTotalPages</span><span class="token punctuation">(</span>totalPages<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> pageNavs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> totalPages<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>            pageNavs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">setPageNavs</span><span class="token punctuation">(</span>pageNavs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token comment">//6、构建面包屑导航</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>attr <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>                <span class="token comment">//1、分析每一个 attrs 传过来的参数值</span></pre></td></tr><tr><td data-num="147"></td><td><pre>                <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span> navVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult<span class="token punctuation">.</span>NavVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>                navVo<span class="token punctuation">.</span><span class="token function">setNavValue</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>                <span class="token class-name">R</span> r <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">attrInfo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>                    <span class="token class-name">AttrResponseVo</span> data <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AttrResponseVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>                    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>                    navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getAttrName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>                    navVo<span class="token punctuation">.</span><span class="token function">setNavName</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="158"></td><td><pre></pre></td></tr><tr><td data-num="159"></td><td><pre>                <span class="token comment">//2、取消了这个面包屑以后，我们要跳转到哪个地方，将请求的地址 url 里面的当前置空</span></pre></td></tr><tr><td data-num="160"></td><td><pre>                <span class="token comment">// 拿到所有的查询条件，去掉当前</span></pre></td></tr><tr><td data-num="161"></td><td><pre>                <span class="token class-name">String</span> encode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>                    encode <span class="token operator">=</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>                    encode<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"+"</span><span class="token punctuation">,</span><span class="token string">"%20"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 浏览器对空格的编码和 Java 不一样，差异化处理</span></pre></td></tr><tr><td data-num="165"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>                <span class="token class-name">String</span> replace <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">get_queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"&amp;attrs="</span> <span class="token operator">+</span> attr<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>                navVo<span class="token punctuation">.</span><span class="token function">setLink</span><span class="token punctuation">(</span><span class="token string">"http://search.gulimall.com/list.html?"</span> <span class="token operator">+</span> replace<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre>                <span class="token keyword">return</span> navVo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre>            result<span class="token punctuation">.</span><span class="token function">setNavs</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="180"></td><td><pre></pre></td></tr><tr><td data-num="181"></td><td><pre></pre></td></tr><tr><td data-num="182"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="183"></td><td><pre>     * 准备检索请求</pre></td></tr><tr><td data-num="184"></td><td><pre>     * 模糊匹配，过滤（按照属性，分类，品牌，价格区间，库存），排序，分页，高亮，聚合分析</pre></td></tr><tr><td data-num="185"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="186"></td><td><pre>     */</pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SearchRequest</span> <span class="token function">buildSearchRequest</span><span class="token punctuation">(</span><span class="token class-name">SearchParam</span> param<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="188"></td><td><pre></pre></td></tr><tr><td data-num="189"></td><td><pre>        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre></pre></td></tr><tr><td data-num="191"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="192"></td><td><pre>         * 模糊匹配，过滤（按照属性，分类，品牌，价格区间，库存）</pre></td></tr><tr><td data-num="193"></td><td><pre>         */</pre></td></tr><tr><td data-num="194"></td><td><pre>        <span class="token comment">//1. 构建 bool-query</span></pre></td></tr><tr><td data-num="195"></td><td><pre>        <span class="token class-name">BoolQueryBuilder</span> boolQueryBuilder<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">BoolQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre></pre></td></tr><tr><td data-num="197"></td><td><pre>        <span class="token comment">//1.1 bool-must</span></pre></td></tr><tr><td data-num="198"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">matchQuery</span><span class="token punctuation">(</span><span class="token string">"skuTitle"</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="201"></td><td><pre></pre></td></tr><tr><td data-num="202"></td><td><pre>        <span class="token comment">//1.2 bool-fiter</span></pre></td></tr><tr><td data-num="203"></td><td><pre>        <span class="token comment">//1.2.1 catelogId</span></pre></td></tr><tr><td data-num="204"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> param<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="205"></td><td><pre>            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"catalogId"</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getCatalog3Id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="207"></td><td><pre></pre></td></tr><tr><td data-num="208"></td><td><pre>        <span class="token comment">//1.2.2 brandId</span></pre></td></tr><tr><td data-num="209"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">"brandId"</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getBrandId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="212"></td><td><pre></pre></td></tr><tr><td data-num="213"></td><td><pre>        <span class="token comment">//1.2.3 attrs</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="215"></td><td><pre></pre></td></tr><tr><td data-num="216"></td><td><pre>            param<span class="token punctuation">.</span><span class="token function">getAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>                <span class="token comment">//attrs=1_5 寸：8 寸 & amp;2_16G:8G</span></pre></td></tr><tr><td data-num="218"></td><td><pre>                <span class="token class-name">BoolQueryBuilder</span> boolQuery <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">boolQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="219"></td><td><pre></pre></td></tr><tr><td data-num="220"></td><td><pre></pre></td></tr><tr><td data-num="221"></td><td><pre>                <span class="token comment">//attrs=1_5 寸：8 寸</span></pre></td></tr><tr><td data-num="222"></td><td><pre>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> s <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>                <span class="token class-name">String</span> attrId<span class="token operator">=</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre>                <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> attrValues <span class="token operator">=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 这个属性检索用的值</span></pre></td></tr><tr><td data-num="225"></td><td><pre>                boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"attrs.attrId"</span><span class="token punctuation">,</span>attrId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>                boolQuery<span class="token punctuation">.</span><span class="token function">must</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termsQuery</span><span class="token punctuation">(</span><span class="token string">"attrs.attrValue"</span><span class="token punctuation">,</span>attrValues<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="227"></td><td><pre></pre></td></tr><tr><td data-num="228"></td><td><pre>                <span class="token class-name">NestedQueryBuilder</span> nestedQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">nestedQuery</span><span class="token punctuation">(</span><span class="token string">"attrs"</span><span class="token punctuation">,</span>boolQuery<span class="token punctuation">,</span> <span class="token class-name">ScoreMode<span class="token punctuation">.</span>None</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre>                boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>nestedQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre></pre></td></tr><tr><td data-num="232"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="233"></td><td><pre></pre></td></tr><tr><td data-num="234"></td><td><pre>        <span class="token comment">//1.2.4 hasStock</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> param<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="236"></td><td><pre>            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">termQuery</span><span class="token punctuation">(</span><span class="token string">"hasStock"</span><span class="token punctuation">,</span>param<span class="token punctuation">.</span><span class="token function">getHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="237"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="238"></td><td><pre></pre></td></tr><tr><td data-num="239"></td><td><pre></pre></td></tr><tr><td data-num="240"></td><td><pre>        <span class="token comment">//1.2.5 skuPrice</span></pre></td></tr><tr><td data-num="241"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>            <span class="token comment">//skuPrice 形式为：1_500 或_500 或 500_</span></pre></td></tr><tr><td data-num="243"></td><td><pre>            <span class="token class-name">RangeQueryBuilder</span> rangeQueryBuilder <span class="token operator">=</span> <span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">rangeQuery</span><span class="token punctuation">(</span><span class="token string">"skuPrice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="244"></td><td><pre>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> price <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>price<span class="token punctuation">.</span>length<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="246"></td><td><pre>                rangeQueryBuilder<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>price<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>price<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="247"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>price<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>                    rangeQueryBuilder<span class="token punctuation">.</span><span class="token function">lte</span><span class="token punctuation">(</span>price<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>                <span class="token keyword">if</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>                    rangeQueryBuilder<span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span>price<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="253"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>            boolQueryBuilder<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rangeQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="257"></td><td><pre></pre></td></tr><tr><td data-num="258"></td><td><pre>        <span class="token comment">// 封装所有的查询条件</span></pre></td></tr><tr><td data-num="259"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>boolQueryBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="260"></td><td><pre></pre></td></tr><tr><td data-num="261"></td><td><pre></pre></td></tr><tr><td data-num="262"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="263"></td><td><pre>         * 排序，分页，高亮</pre></td></tr><tr><td data-num="264"></td><td><pre>         */</pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre>        <span class="token comment">// 排序</span></pre></td></tr><tr><td data-num="267"></td><td><pre>        <span class="token comment">// 形式为 sort=hotScore_asc/desc</span></pre></td></tr><tr><td data-num="268"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>            <span class="token class-name">String</span> sort <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sortFileds <span class="token operator">=</span> sort<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre></pre></td></tr><tr><td data-num="272"></td><td><pre>            <span class="token class-name">SortOrder</span> sortOrder<span class="token operator">=</span><span class="token string">"asc"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>sortFileds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>ASC<span class="token operator">:</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="273"></td><td><pre></pre></td></tr><tr><td data-num="274"></td><td><pre>            searchSourceBuilder<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sortFileds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>sortOrder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="275"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="276"></td><td><pre></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token comment">// 分页</span></pre></td></tr><tr><td data-num="278"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getPageNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_PAGESIZE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="280"></td><td><pre></pre></td></tr><tr><td data-num="281"></td><td><pre>        <span class="token comment">// 高亮</span></pre></td></tr><tr><td data-num="282"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getKeyword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="283"></td><td><pre></pre></td></tr><tr><td data-num="284"></td><td><pre>            <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>            highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"skuTitle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="286"></td><td><pre>            highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">"&lt;b style='color:red'>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>            highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">"&lt;/b>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre></pre></td></tr><tr><td data-num="289"></td><td><pre>            searchSourceBuilder<span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="290"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="291"></td><td><pre></pre></td></tr><tr><td data-num="292"></td><td><pre></pre></td></tr><tr><td data-num="293"></td><td><pre></pre></td></tr><tr><td data-num="294"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="295"></td><td><pre>         * 聚合分析</pre></td></tr><tr><td data-num="296"></td><td><pre>         */</pre></td></tr><tr><td data-num="297"></td><td><pre>        <span class="token comment">//1. 按照品牌进行聚合</span></pre></td></tr><tr><td data-num="298"></td><td><pre>        <span class="token class-name">TermsAggregationBuilder</span> brand_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brand_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="299"></td><td><pre>        brand_agg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brandId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre></pre></td></tr><tr><td data-num="301"></td><td><pre></pre></td></tr><tr><td data-num="302"></td><td><pre>        <span class="token comment">//1.1 品牌的子聚合 - 品牌名聚合</span></pre></td></tr><tr><td data-num="303"></td><td><pre>        brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brand_name_agg"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="304"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brandName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="305"></td><td><pre>        <span class="token comment">//1.2 品牌的子聚合 - 品牌图片聚合</span></pre></td></tr><tr><td data-num="306"></td><td><pre>        brand_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"brand_img_agg"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="307"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"brandImg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre></pre></td></tr><tr><td data-num="309"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>brand_agg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre></pre></td></tr><tr><td data-num="311"></td><td><pre>        <span class="token comment">//2. 按照分类信息进行聚合</span></pre></td></tr><tr><td data-num="312"></td><td><pre>        <span class="token class-name">TermsAggregationBuilder</span> catalog_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"catalog_agg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="313"></td><td><pre>        catalog_agg<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"catalogId"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="314"></td><td><pre></pre></td></tr><tr><td data-num="315"></td><td><pre>        catalog_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"catalog_name_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"catalogName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="316"></td><td><pre></pre></td></tr><tr><td data-num="317"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>catalog_agg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre></pre></td></tr><tr><td data-num="319"></td><td><pre>        <span class="token comment">//2. 按照属性信息进行聚合</span></pre></td></tr><tr><td data-num="320"></td><td><pre>        <span class="token class-name">NestedAggregationBuilder</span> attr_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">nested</span><span class="token punctuation">(</span><span class="token string">"attr_agg"</span><span class="token punctuation">,</span> <span class="token string">"attrs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="321"></td><td><pre>        <span class="token comment">//2.1 按照属性 ID 进行聚合</span></pre></td></tr><tr><td data-num="322"></td><td><pre>        <span class="token class-name">TermsAggregationBuilder</span> attr_id_agg <span class="token operator">=</span> <span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"attr_id_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"attrs.attrId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>        attr_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span>attr_id_agg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>        <span class="token comment">//2.1.1 在每个属性 ID 下，按照属性名进行聚合</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"attr_name_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"attrs.attrName"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="326"></td><td><pre>        <span class="token comment">//2.1.1 在每个属性 ID 下，按照属性值进行聚合</span></pre></td></tr><tr><td data-num="327"></td><td><pre>        attr_id_agg<span class="token punctuation">.</span><span class="token function">subAggregation</span><span class="token punctuation">(</span><span class="token class-name">AggregationBuilders</span><span class="token punctuation">.</span><span class="token function">terms</span><span class="token punctuation">(</span><span class="token string">"attr_value_agg"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"attrs.attrValue"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>        searchSourceBuilder<span class="token punctuation">.</span><span class="token function">aggregation</span><span class="token punctuation">(</span>attr_agg<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="329"></td><td><pre></pre></td></tr><tr><td data-num="330"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"构建的DSL语句 &#123;&#125;"</span><span class="token punctuation">,</span>searchSourceBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="331"></td><td><pre></pre></td></tr><tr><td data-num="332"></td><td><pre>        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span><span class="token class-name">EsConstant</span><span class="token punctuation">.</span>PRODUCT_INDEX<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre></pre></td></tr><tr><td data-num="334"></td><td><pre>        <span class="token keyword">return</span> searchRequest<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="页面渲染"><a class="anchor" href="#页面渲染">#</a> 页面渲染</h3><h2 id="异步复习"><a class="anchor" href="#异步复习">#</a> 异步复习</h2><p><strong>复习连接：<a href="https://oxyzen-wxf.github.io/review/java/javahigh/async-1/">https://oxyzen-wxf.github.io/review/java/javahigh/async-1/</a></strong></p><h2 id="商品详情"><a class="anchor" href="#商品详情">#</a> 商品详情</h2><h3 id="业务异步编排"><a class="anchor" href="#业务异步编排">#</a> 业务异步编排</h3><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- 配置文件提示工具 --></span></pre></td></tr><tr><td data-num="2"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-configuration-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h4 id="绑定线程池配置类"><a class="anchor" href="#绑定线程池配置类">#</a> 绑定线程池配置类</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"gulimall.thread"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfigProperties</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> coreSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> keepAliveTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="配置文件"><a class="anchor" href="#配置文件">#</a> 配置文件</h4><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">gulimall</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">thread</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">core-size</span><span class="token punctuation">:</span> <span class="token number">20</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">max-size</span><span class="token punctuation">:</span> <span class="token number">200</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">keep-alive-time</span><span class="token punctuation">:</span> <span class="token number">10</span></pre></td></tr></table></figure><h4 id="配置线程池加入到容器"><a class="anchor" href="#配置线程池加入到容器">#</a> 配置线程池加入到容器</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">threadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolConfigProperties</span> pool<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>pool<span class="token punctuation">.</span><span class="token function">getCoreSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                pool<span class="token punctuation">.</span><span class="token function">getMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                pool<span class="token punctuation">.</span><span class="token function">getKeepAliveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">defaultThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="代码"><a class="anchor" href="#代码">#</a> 代码</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Resource</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">ThreadPoolExecutor</span> executor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@SneakyThrows</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">SkuItemVo</span> <span class="token function">item</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">SkuItemVo</span> skuItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuInfoEntity</span><span class="token punctuation">></span></span> infoFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">//1、sku 基本信息的获取  pms_sku_info</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">SkuInfoEntity</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            skuItemVo<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">return</span> info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> saleAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">//3、获取 spu 的销售属性组合</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuItemSaleAttrVo</span><span class="token punctuation">></span></span> saleAttrVos <span class="token operator">=</span> skuSaleAttrValueService<span class="token punctuation">.</span><span class="token function">getSaleAttrBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            skuItemVo<span class="token punctuation">.</span><span class="token function">setSaleAttr</span><span class="token punctuation">(</span>saleAttrVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> descFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">//4、获取 spu 的介绍    pms_spu_info_desc</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token class-name">SpuInfoDescEntity</span> spuInfoDescEntity <span class="token operator">=</span> spuInfoDescService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            skuItemVo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span>spuInfoDescEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> baseAttrFuture <span class="token operator">=</span> infoFuture<span class="token punctuation">.</span><span class="token function">thenAcceptAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">//5、获取 spu 的规格参数信息</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpuItemAttrGroupVo</span><span class="token punctuation">></span></span> attrGroupVos <span class="token operator">=</span> attrGroupService<span class="token punctuation">.</span><span class="token function">getAttrGroupWithAttrsBySpuId</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getSpuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            skuItemVo<span class="token punctuation">.</span><span class="token function">setGroupAttrs</span><span class="token punctuation">(</span>attrGroupVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// Long spuId = info.getSpuId();</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// Long catalogId = info.getCatalogId();</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">//2、sku 的图片信息    pms_sku_images</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> imageFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuImagesEntity</span><span class="token punctuation">></span></span> imagesEntities <span class="token operator">=</span> skuImagesService<span class="token punctuation">.</span><span class="token function">getImagesBySkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            skuItemVo<span class="token punctuation">.</span><span class="token function">setImages</span><span class="token punctuation">(</span>imagesEntities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> seckillFuture <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">//            3、远程调用查询当前 sku 是否参与秒杀优惠活动</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token class-name">R</span> skuSeckilInfo <span class="token operator">=</span> seckillFeignService<span class="token punctuation">.</span><span class="token function">getSkuSeckilInfo</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>skuSeckilInfo<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token comment">// 查询成功</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token class-name">SeckillSkuVo</span> seckilInfoData <span class="token operator">=</span> skuSeckilInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SeckillSkuVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                skuItemVo<span class="token punctuation">.</span><span class="token function">setSeckillSkuVo</span><span class="token punctuation">(</span>seckilInfoData<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>seckilInfoData <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">></span> seckilInfoData<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        skuItemVo<span class="token punctuation">.</span><span class="token function">setSeckillSkuVo</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 等到所有任务都完成</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>saleAttrFuture<span class="token punctuation">,</span>descFuture<span class="token punctuation">,</span>baseAttrFuture<span class="token punctuation">,</span>imageFuture<span class="token punctuation">,</span>seckillFuture<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">return</span> skuItemVo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="认证服务"><a class="anchor" href="#认证服务">#</a> 认证服务</h2><h2 id="购物车"><a class="anchor" href="#购物车">#</a> 购物车</h2><h3 id="购物车vo"><a class="anchor" href="#购物车vo">#</a> 购物车 vo</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartItemVo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> check <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="12"></td><td><pre>     * 商品套餐属性</pre></td></tr><tr><td data-num="13"></td><td><pre>     */</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> skuAttrValues<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalPrice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> skuId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSkuId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>skuId <span class="token operator">=</span> skuId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">return</span> check<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCheck</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span> check<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>check <span class="token operator">=</span> check<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">return</span> title<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token class-name">String</span> title<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> image<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setImage</span><span class="token punctuation">(</span><span class="token class-name">String</span> image<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>image <span class="token operator">=</span> image<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getSkuAttrValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">return</span> skuAttrValues<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSkuAttrValues</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> skuAttrValues<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>skuAttrValues <span class="token operator">=</span> skuAttrValues<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">return</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> price<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="79"></td><td><pre>     * 计算当前购物项总价</pre></td></tr><tr><td data-num="80"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="81"></td><td><pre>     */</pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>price<span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">""</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTotalPrice</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> totalPrice<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>totalPrice <span class="token operator">=</span> totalPrice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartVo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     * 购物车子项信息</pre></td></tr><tr><td data-num="5"></td><td><pre>     */</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">></span></span> items<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     * 商品数量</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> countNum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 商品类型数量</pre></td></tr><tr><td data-num="15"></td><td><pre>     */</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> countType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="19"></td><td><pre>     * 商品总价</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> totalAmount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>     * 减免价格</pre></td></tr><tr><td data-num="25"></td><td><pre>     */</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> reduce <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0.00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">></span></span> <span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">return</span> items<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setItems</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CartItemVo</span><span class="token punctuation">></span></span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>items <span class="token operator">=</span> items<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCountNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                count <span class="token operator">+=</span> item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCountType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotalAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token class-name">BigDecimal</span> amount <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 计算购物项总价</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CartItemVo</span> cartItem <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                    amount <span class="token operator">=</span> amount<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cartItem<span class="token punctuation">.</span><span class="token function">getTotalPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token comment">// 计算优惠后的价格</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">return</span> amount<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span><span class="token function">getReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getReduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token keyword">return</span> reduce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setReduce</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span> reduce<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>reduce <span class="token operator">=</span> reduce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="配置拦截器"><a class="anchor" href="#配置拦截器">#</a> 配置拦截器</h3><pre><code>* 去购物车页面的请求
* 浏览器有一个cookie:user-key 标识用户的身份，一个月过期
* 如果第一次使用jd的购物车功能，都会给一个临时的用户身份:
* 浏览器以后保存，每次访问都会带上这个cookie；
* 登录：session有
* 没登录：按照cookie里面带来user-key来做
* 第一次，如果没有临时用户，自动创建一个临时用户
</code></pre><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * @Description: 在执行目标方法之前，判断用户的登录状态。并封装传递给 controller 目标请求</pre></td></tr><tr><td data-num="3"></td><td><pre> * @Created: with IntelliJ IDEA.</pre></td></tr><tr><td data-num="4"></td><td><pre> * @author: 夏沫止水</pre></td></tr><tr><td data-num="5"></td><td><pre> * @createTime: 2020-06-30 17:31</pre></td></tr><tr><td data-num="6"></td><td><pre> **/</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CartInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 存对应线程的数据，多线程之间数据独享 原理就是 map  key 为线程 value 是值</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoTo</span><span class="token punctuation">></span></span> toThreadLocal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/***</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 目标方法执行之前</pre></td></tr><tr><td data-num="16"></td><td><pre>     * @param request</pre></td></tr><tr><td data-num="17"></td><td><pre>     * @param response</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @param handler</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="20"></td><td><pre>     * @throws Exception</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserInfoTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">HttpSession</span> session <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 获得当前登录用户的信息</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">MemberResponseVo</span> memberResponseVo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">)</span> session<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>LOGIN_USER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>memberResponseVo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 用户登录了</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">Cookie</span><span class="token punctuation">[</span><span class="token punctuation">]</span> cookies <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cookies <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cookies<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Cookie</span> cookie <span class="token operator">:</span> cookies<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token comment">//user-key</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token class-name">String</span> name <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_NAME<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token comment">// 标记为已是临时用户</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                    userInfoTo<span class="token punctuation">.</span><span class="token function">setTempUser</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 如果没有临时用户一定分配一个临时用户</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token class-name">String</span> uuid <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            userInfoTo<span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token comment">// 目标方法执行之前</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        toThreadLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userInfoTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="62"></td><td><pre>     * 业务执行之后，分配临时用户来浏览器保存</pre></td></tr><tr><td data-num="63"></td><td><pre>     * @param request</pre></td></tr><tr><td data-num="64"></td><td><pre>     * @param response</pre></td></tr><tr><td data-num="65"></td><td><pre>     * @param handler</pre></td></tr><tr><td data-num="66"></td><td><pre>     * @param modelAndView</pre></td></tr><tr><td data-num="67"></td><td><pre>     * @throws Exception</pre></td></tr><tr><td data-num="68"></td><td><pre>     */</pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 获取当前用户的值</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token class-name">UserInfoTo</span> userInfoTo <span class="token operator">=</span> toThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 如果没有临时用户一定保存一个临时用户</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfoTo<span class="token punctuation">.</span><span class="token function">getTempUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token comment">// 创建一个 cookie</span></pre></td></tr><tr><td data-num="78"></td><td><pre>            <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_NAME<span class="token punctuation">,</span> userInfoTo<span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token comment">// 扩大作用域</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            cookie<span class="token punctuation">.</span><span class="token function">setDomain</span><span class="token punctuation">(</span><span class="token string">"gulimall.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>            <span class="token comment">// 设置过期时间</span></pre></td></tr><tr><td data-num="82"></td><td><pre>            cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>TEMP_USER_COOKIE_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>拦截器要生效就需要实现 WebMvcConfigurer 来添加自定义拦截器并指定拦截那些路径</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GulimallWebConfig</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CartInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 注册拦截器</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="mq消息队列"><a class="anchor" href="#mq消息队列">#</a> MQ 消息队列</h2><h2 id="订单服务"><a class="anchor" href="#订单服务">#</a> 订单服务</h2><p><strong>库存服务调用订单服务的时候，因为订单服务有拦截器，库存远程调用的时候需要配置不拦截该远程请求</strong></p><h2 id="feign远程丢失请求头"><a class="anchor" href="#feign远程丢失请求头">#</a> Feign 远程丢失请求头</h2><p><img data-src="../../assets/image-20210726105056341.png" alt="image-20210726105056341"></p><p><img data-src="../../assets/image-20210726105108618.png" alt="image-20210726105108618"></p><p><strong>解决：配置类</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFeignConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     * 配置 feign 拦截器，添加 RequestInterceptor，把传过来的请求头</pre></td></tr><tr><td data-num="6"></td><td><pre>     * 转给 feign 远程调用带过去，源码会遍历 RequestInterceptor 集合调用 apply（）方法</pre></td></tr><tr><td data-num="7"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="8"></td><td><pre>     */</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> requestTemplate <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token class-name">ServletRequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="feign异步模式丢失上下文"><a class="anchor" href="#feign异步模式丢失上下文">#</a> Feign 异步模式丢失上下文</h2><p><strong>原因：因为开启异步多线程，当前请求走的是一个请求的线程，路过 feign 调用开启的异步线程与请求线程不一样，所以我们可以通过传递请求的方式解决，否则 feign 拦截的 request 请求将为 null</strong></p><p><strong>解决</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取请求</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 2 远程调用查询收货地址列表</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">></span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="幂等性"><a class="anchor" href="#幂等性">#</a> 幂等性</h2><p><span class="exturl" data-url="aHR0cHM6Ly9zZXJ2ZXJsZXNzLXBhZ2UtYnVja2V0LWRwcmVrczVjLTEzMDU5NDE5MTcuY29zLXdlYnNpdGUuYXAtaG9uZ2tvbmcubXlxY2xvdWQuY29tL3dvcmtub3RlL25vdGUtMi8=">https://serverless-page-bucket-dpreks5c-1305941917.cos-website.ap-hongkong.myqcloud.com/worknote/note-2/</span></p><h2 id="秒杀"><a class="anchor" href="#秒杀">#</a> 秒杀</h2><h1 id="分布式集群"><a class="anchor" href="#分布式集群">#</a> 分布式集群</h1><h2 id="错误记录"><a class="anchor" href="#错误记录">#</a> 错误记录</h2><h3 id="微服务使用模块化时候导入公共模块导致maven更新依赖错误问题"><a class="anchor" href="#微服务使用模块化时候导入公共模块导致maven更新依赖错误问题">#</a> 微服务使用模块化时候导入公共模块导致 maven 更新依赖错误问题</h3><p>问题：在使用微服务分模块化开发的时候导入公共模块的时候，公共模块频繁更新 pom 坐标导致服务模块更新坐标出现下面异常，并且无论怎么样注释公共模块的坐标也无法把公共模块给剔除出去，也可能是自己误操作的原因导致 maven 刷新坐标不起作用，但是错误原因很明显，所以根据报错去解决问题</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>io.renren:renren-fast:jar:3.0.0 构建有效模型时遇到的一些问题</pre></td></tr><tr><td data-num="2"></td><td><pre>POM io.renren:renren-fast:3.0.0 <span class="token punctuation">(</span>D:<span class="token punctuation">\</span>workspace<span class="token punctuation">\</span>java<span class="token punctuation">\</span>gulimall<span class="token punctuation">\</span>renren-fast<span class="token punctuation">\</span>pom.xml<span class="token punctuation">)</span> 的 <span class="token string">'parent.relativePath'</span> 指向 com.atguigu.gulimall:gulimall 而不是 org.springframework .boot:spring-boot-starter-parent，请验证您的项目结构@第11行，第10列</pre></td></tr><tr><td data-num="3"></td><td><pre>io.renren:renren-generator:jar:1.0.0 构建有效模型时遇到的一些问题</pre></td></tr><tr><td data-num="4"></td><td><pre>POM io.renren:renren-generator:1.0.0 <span class="token punctuation">(</span>D:<span class="token punctuation">\</span>workspace<span class="token punctuation">\</span>java<span class="token punctuation">\</span>gulimall<span class="token punctuation">\</span>renren-generator<span class="token punctuation">\</span>pom.xml<span class="token punctuation">)</span> 的 <span class="token string">'parent.relativePath'</span> 指向 com.atguigu.gulimall:gulimall 而不是 org.springframework .boot:spring-boot-starter-parent，请验证您的项目结构@第11行，第10列</pre></td></tr><tr><td data-num="5"></td><td><pre>com.atguigu.gulimall:gulimall-common:jar:0.0.1-SNAPSHOT构建有效模型时遇到一些问题</pre></td></tr><tr><td data-num="6"></td><td><pre>缺少 org.apache.maven.plugins:maven-compiler-plugin 的“build.plugins.plugin.version”。 @ com.atguigu.gulimall:gulimall-common:<span class="token punctuation">[</span>未知版本<span class="token punctuation">]</span>，D:<span class="token punctuation">\</span>workspace<span class="token punctuation">\</span>java<span class="token punctuation">\</span>gulimall<span class="token punctuation">\</span>gulimall-common<span class="token punctuation">\</span>pom.xml，第16行，第21列</pre></td></tr><tr><td data-num="7"></td><td><pre>强烈建议修复这些问题，因为它们会威胁到您构建的稳定性。</pre></td></tr><tr><td data-num="8"></td><td><pre>出于这个原因，未来的 Maven 版本可能不再支持构建这种格式错误的项目。</pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>问题描述翻译的意思是，本来本服务模块使用的父工程是 springboot，但是却指向了导入 common 公共模块为父工程，解决办法就是在 &lt;parent&gt; 中添加</p><figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- lookup parent from repository --></span></pre></td></tr></table></figure><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><pre><code class="language-XML">	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.2.4.RELEASE&lt;/version&gt;
		&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
	&lt;/parent&gt;
</code></pre><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>下面对 relativePath 解释来自 https://blog.csdn.net/gzt19881123/article/details/105255138</p><ol><li>relativePath 是 Maven 为了寻找父模块 pom.xml 所额外增加的一个寻找路径</li><li>relativePath 默认值为 …/pom.xml</li><li><strong>Maven 寻找父模块 pom.xml 的顺序如下：</strong></li></ol><pre><code>    (1)  first in the reactor of currently building projects
          这里一个maven概念 反应堆（reactor ），
          意思就是先从工程里面有依赖相关的模块中找你引入的
          parent 的pom.xml，
        
    (2) then in this location on the filesystem
         然后从 你定义的  &lt;relativePath &gt; 路径中找，
         当然你如果只是 /  即空值，则跳过该步骤，  
         默认值 ../pom.xml 则是从上级目录中找啦。

    (3)  then the local repository
       这个就不说了，如果 （1） （2） 步骤没有则从 本地仓库找啦。

    (4) and lastly in the remote repo
     这个还用说吗，上面都找不到了，最后只能从远程仓库找啦，再找不到就报错给你看 
</code></pre><p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="远程调用服务超时报错"><a class="anchor" href="#远程调用服务超时报错">#</a> 远程调用服务超时报错</h3><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>feign.RetryableException: Read timed out executing POST http://gulimall-coupon/coupon/spubounds/save</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token number">1</span>.出现错误原理fegin 调用服务有个默认的时间超过这个时间会出现服务调用超时</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>因为fegin 默认整合了ribbon和 hystrix 解决办法如下</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#hystrix 的超时时间</span></pre></td></tr><tr><td data-num="9"></td><td><pre>hystrix:</pre></td></tr><tr><td data-num="10"></td><td><pre>  command:</pre></td></tr><tr><td data-num="11"></td><td><pre>    default:</pre></td></tr><tr><td data-num="12"></td><td><pre>      execution:</pre></td></tr><tr><td data-num="13"></td><td><pre>        timeout:</pre></td></tr><tr><td data-num="14"></td><td><pre>          enabled: <span class="token boolean">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        isolation:</pre></td></tr><tr><td data-num="16"></td><td><pre>          thread:</pre></td></tr><tr><td data-num="17"></td><td><pre>            timeoutInMilliseconds: <span class="token number">9000</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">#ribbon 的超时时间</span></pre></td></tr><tr><td data-num="19"></td><td><pre>ribbon:</pre></td></tr><tr><td data-num="20"></td><td><pre>  ReadTimeout: <span class="token number">3000</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  ConnectTimeout: <span class="token number">3000</span></pre></td></tr></table></figure><h3 id="maven编译乱码问题"><a class="anchor" href="#maven编译乱码问题">#</a> maven 编译乱码问题</h3><p><img data-src="../../assets/image-20210719152645678.png" alt="image-20210719152645678"></p><p>设置 -<strong>Dfile.encoding=GB2312</strong></p><p><strong>Error:(3,35) java: 程序包 com.atguigu.common.constant 不存在</strong></p><p>因为修改了 common 包未能及时编译打包更新所以未能找到对应包，重新打包 common 重新引入 common 模块</p><p><strong>Error:(6,20) java: 编码 EUC_CN 的不可映射字符</strong>，添加下面配置原因编码问题</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="maven"><a class="anchor" href="#maven">#</a> maven</h3><p><strong>错误信息</strong>重新编译重新发布</p><pre><code>Some problems were encountered while building the effective model for com.atguigu.gulimall:gulimall-common:jar:0.0.1-SNAPSHOT
'build.plugins.plugin.version' for org.apache.maven.plugins:maven-compiler-plugin is missing. @ com.atguigu.gulimall:gulimall-common:[unknown-version], D:\workspace\java\gulimall\gulimall-common\pom.xml, line 16, column 21
It is highly recommended to fix these problems because they threaten the stability of your build.
For this reason, future Maven versions might no longer support building such malformed projects.
</code></pre><h1 id="异常解决javalangillegalstateexception-failed-to-introspect-class"><a class="anchor" href="#异常解决javalangillegalstateexception-failed-to-introspect-class">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vanBmc3MvcC8xMTA4OTA4My5odG1s">异常解决：java.lang.IllegalStateException: Failed to introspect Class</span></h1><hr><h3 id="javalangillegalstateexception-failed-to-introspect-class"><a class="anchor" href="#javalangillegalstateexception-failed-to-introspect-class">#</a> java.lang.IllegalStateException: Failed to introspect Class</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vanBmc3MvcC8xMTA4OTA4My5odG1sI18x">异常详情</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vanBmc3MvcC8xMTA4OTA4My5odG1sI182">原因</span></li><li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vanBmc3MvcC8xMTA4OTA4My5odG1sI18xMA==">解决办法</span></li></ul><h1 id="异常详情"><a class="anchor" href="#异常详情">#</a> 异常详情</h1><p>Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name xxxxx</p><p>Lookup method resolution failed; nested exception is java.lang.IllegalStateException: Failed to introspect Class [classA] from ClassLoader [sun.misc.Launcher$AppClassLoader@14dad5dc]</p><h1 id="原因"><a class="anchor" href="#原因">#</a> 原因</h1><p>此异常原因是因为 classA 中使用了项目没有导入的类，从而导致类加载失败。一般来说如果使用了没有依赖的类应该会报 ClassNotFindException 的错误，但是如果只是导入却没有使用的使用可能就会报此错误。<br>通常此错误见与使用 maven 框架配置了第三方类的 scope 是 provided 的情况下。笔者在使用 spring boot、maven 时导致此错误。</p><h1 id="解决办法"><a class="anchor" href="#解决办法">#</a> 解决办法</h1><p>检查 classA 类中可能存在的没有依赖的类或者包，将之导入（或者加入 maven 依赖、或调整依赖的包中的依赖的 scope），总之使其类加载器能够在当期 classPath 找到此类即可。</p><p>原文地址：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h1aXRvdWtlc3QvYXJ0aWNsZS9kZXRhaWxzLzg4MDEzNzYzaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2h1aXRvdWtlc3QvYXJ0aWNsZS9kZXRhaWxzLzg4MDEzNzYz">https://blog.csdn.net/huitoukest/article/details/88013763https://blog.csdn.net/huitoukest/article/details/88013763</span></p><h2 id="seata错误异常"><a class="anchor" href="#seata错误异常">#</a> Seata 错误异常</h2><pre><code>org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'globalTransactionScanner' defined in class path resource [com/alibaba/cloud/seata/GlobalTransactionAutoConfiguration.class]: Bean instantiation via factory method failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [io.seata.spring.annotation.GlobalTransactionScanner]: Factory method 'globalTransactionScanner' threw exception; nested exception is io.seata.common.exception.NotSupportYetException: not support register type: null
</code></pre><p><strong>服务模块引入公共模块的 Seata 启动报错</strong></p><h2 id="循环依赖问题"><a class="anchor" href="#循环依赖问题">#</a> 循环依赖问题</h2><p>Description:</p><p>The dependencies of some of the beans in the application context form a cycle:</p><p>servletEndpointRegistrar defined in class path resource [org/springframework/boot/actuate/autoconfigure/endpoint/web/ServletEndpointManagementContextConfiguration<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mi>e</mi><mi>b</mi><mi>M</mi><mi>v</mi><mi>c</mi><mi>S</mi><mi>e</mi><mi>r</mi><mi>v</mi><mi>l</mi><mi>e</mi><mi>t</mi><mi>E</mi><mi>n</mi><mi>d</mi><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>M</mi><mi>a</mi><mi>n</mi><mi>a</mi><mi>g</mi><mi>e</mi><mi>m</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo stretchy="false">]</mo><mo>↓</mo><mi>h</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi>E</mi><mi>n</mi><mi>d</mi><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>d</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">[</mo><mi>o</mi><mi>r</mi><mi>g</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>h</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi mathvariant="normal">/</mi><mi>H</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi>E</mi><mi>n</mi><mi>d</mi><mi>p</mi><mi>o</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo stretchy="false">]</mo><mo>↓</mo><mi>h</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>R</mi><mi>e</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>r</mi><mi>y</mi><mi>d</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">[</mo><mi>o</mi><mi>r</mi><mi>g</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>h</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi mathvariant="normal">/</mi><mi>H</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mo stretchy="false">]</mo><mo>↓</mo><mi>o</mi><mi>r</mi><mi>g</mi><mi mathvariant="normal">.</mi><mi>s</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi mathvariant="normal">.</mi><mi>b</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>c</mi><mi>t</mi><mi>u</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">.</mi><mi>a</mi><mi>m</mi><mi>q</mi><mi>p</mi><mi mathvariant="normal">.</mi><mi>R</mi><mi>a</mi><mi>b</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>H</mi><mi>e</mi><mi>a</mi><mi>l</mi><mi>t</mi><mi>h</mi><mi>I</mi><mi>n</mi><mi>d</mi><mi>i</mi><mi>c</mi><mi>a</mi><mi>t</mi><mi>o</mi><mi>r</mi><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">┌</mo><mtext>─────</mtext><mo stretchy="false">┐</mo><mi mathvariant="normal">∣</mi><mi>r</mi><mi>a</mi><mi>b</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>T</mi><mi>e</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>d</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">[</mo><mi>o</mi><mi>r</mi><mi>g</mi><mi mathvariant="normal">/</mi><mi>s</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>f</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>a</mi><mi>m</mi><mi>q</mi><mi>p</mi><mi mathvariant="normal">/</mi><mi>R</mi><mi>a</mi><mi>b</mi><mi>b</mi><mi>i</mi><mi>t</mi><mi>A</mi><mi>u</mi><mi>t</mi><mi>o</mi><mi>C</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">WebMvcServletEndpointManagementContextConfiguration.class] ↓ healthEndpoint defined in class path resource [org/springframework/boot/actuate/autoconfigure/health/HealthEndpointConfiguration.class] ↓ healthIndicatorRegistry defined in class path resource [org/springframework/boot/actuate/autoconfigure/health/HealthIndicatorAutoConfiguration.class] ↓ org.springframework.boot.actuate.autoconfigure.amqp.RabbitHealthIndicatorAutoConfiguration ┌─────┐ | rabbitTemplate defined in class path resource [org/springframework/boot/autoconfigure/amqp/RabbitAutoConfiguration</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal" style="margin-right:.13889em">W</span><span class="mord mathnormal">e</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:.10903em">M</span><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">v</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.10903em">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">↓</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mopen">[</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord">/</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:.08125em">H</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.05764em">E</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">p</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">↓</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.00773em">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">y</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mopen">[</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord">/</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:.08125em">H</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mclose">]</span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">↓</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord">.</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mord">.</span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">u</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord">.</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:.03588em">q</span><span class="mord mathnormal">p</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:.00773em">R</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">b</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.08125em">H</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.07847em">I</span><span class="mord mathnormal">n</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen amsrm">┌</span><span class="mord">─</span><span class="mord">─</span><span class="mord">─</span><span class="mord">─</span><span class="mord">─</span><span class="mclose amsrm">┐</span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">b</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:.13889em">T</span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:.01968em">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">c</span><span class="mord mathnormal">e</span><span class="mopen">[</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord">/</span><span class="mord mathnormal">s</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal" style="margin-right:.03148em">k</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord mathnormal">o</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">e</span><span class="mord">/</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal" style="margin-right:.03588em">q</span><span class="mord mathnormal">p</span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:.00773em">R</span><span class="mord mathnormal">a</span><span class="mord mathnormal">b</span><span class="mord mathnormal">b</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal">A</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:.07153em">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:.03588em">g</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:.02778em">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span></span></span></span>RabbitTemplateConfiguration.class]<br>↑ ↓<br>| myRabbitConfig (field org.springframework.amqp.rabbit.core.RabbitTemplate com.atguigu.gulimall.gulimallseckill.config.MyRabbitConfig.rabbitTemplate)<br>└─────┘</p><p><strong>详细依赖见博客</strong></p><p>出现循环依赖之后，一定是双方都使用了依赖注入等待注入，这边我们可以自己创建</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 主要的</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@Primary</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">rabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>rabbitTemplate <span class="token operator">=</span> rabbitTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">ininRabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果这种方法无效，我们可以从错误信息中找到 rabbitmq (例子) 自动配置类，在其中查看循环依赖的 RabbitTemplate 是如何配置的，拿到参数连接工厂，我们可以直接 new 一个 RabbitTemplate 然后将连接工厂放进去，在将当前获得的 rabbitTemplate 赋值给 this.rabbitTemplate，缺点就是缺少了一些配置</p><div class="tags"><a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-03 16:55:51" itemprop="dateModified" datetime="2022-06-03T16:55:51+08:00">2022-06-03</time> </span><span id="worknote/gulinote/" class="item leancloud_visitors" data-flag-title="谷粒商城笔记" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="WangXuefeng 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="WangXuefeng 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="WangXuefeng 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文博主： </strong>WangXuefeng <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://oxyzen-wxf.github.io/worknote/gulinote/" title="谷粒商城笔记">https://oxyzen-wxf.github.io/worknote/gulinote/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/worknote/order-1/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclwuom7cj20zk0m8dvn.jpg" title="尚硅谷订单服务笔记"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>尚硅谷订单服务笔记</h3></a></div><div class="item right"><a href="/worknote/order-3/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipex2cdtbj20zk0m8x6p.jpg" title="尚硅谷订单服务笔记之秒杀"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>尚硅谷订单服务笔记之秒杀</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%B7%E7%B2%92%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">谷粒商城笔记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">分布式基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E8%AE%BE%E7%BD%AEdocker%E5%AE%B9%E5%99%A8%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%87%8D%E5%90%AF%E5%AE%B9%E5%99%A8%E8%87%AA%E5%8A%A8%E9%87%8D%E5%90%AF"><span class="toc-number">2.1.</span> <span class="toc-text">1. 设置 docker 容器在服务器重启容器自动重启</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E5%BF%AB%E9%80%9F%E5%BC%80%E5%8F%91-%E4%BA%BA%E4%BA%BA%E5%BC%80%E6%BA%90"><span class="toc-number">2.2.</span> <span class="toc-text">2. 快速开发 - 人人开源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E4%BA%BA%E5%BC%80%E6%BA%90%E5%90%8E%E5%8F%B0%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.1.</span> <span class="toc-text">人人开源后台搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%BA%E4%BA%BA%E5%BC%80%E6%BA%90%E5%89%8D%E5%8F%B0%E6%90%AD%E5%BB%BA"><span class="toc-number">2.2.2.</span> <span class="toc-text">人人开源前台搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E4%BA%BA%E4%BA%BA%E5%BC%80%E6%BA%90%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.3.</span> <span class="toc-text">3. 人人开源逆向工程搭建使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">步骤</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E5%88%9B%E5%BB%BA%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97gulimall-common"><span class="toc-number">2.3.</span> <span class="toc-text">4. 创建公共模块 gulimall-common</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5gulimall-prodcut%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">2.4.</span> <span class="toc-text">5.gulimall-prodcut 启动测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E4%BA%BA%E4%BA%BA%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E7%94%9F%E6%88%90%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">2.5.</span> <span class="toc-text">用人人逆向工程生成所有服务的代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%87%E8%A7%81%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD%E4%B8%BB%E7%B1%BB%E6%8A%A5%E9%94%99"><span class="toc-number">2.5.1.</span> <span class="toc-text">遇见无法加载主类报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E8%BE%93%E5%85%A5netstat-ano%E5%B9%B6%E5%9B%9E%E8%BD%A6%E6%9F%A5%E7%9C%8B%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="toc-number">2.5.2.</span> <span class="toc-text">一：输入 netstat -ano 并回车查看在运行的端口号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E9%80%9A%E8%BF%87%E7%AB%AF%E5%8F%A3%E5%8F%B7%E6%9F%A5%E7%9C%8B%E7%9B%B8%E5%BA%94%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="toc-number">2.5.3.</span> <span class="toc-text">三：通过端口号查看相应端口号</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#netstat-ano-findstr-%E7%AB%AF%E5%8F%A3%E5%8F%B7"><span class="toc-number">2.5.3.0.1.</span> <span class="toc-text">netstat -ano | findstr “端口号”</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E9%80%9A%E8%BF%87%E7%AB%AF%E5%8F%A3pid%E6%9F%A5%E7%9C%8B%E7%AB%AF%E5%8F%A3%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.5.4.</span> <span class="toc-text">四：通过端口 PID 查看端口运行程序</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#tasklist-findstr-pid"><span class="toc-number">2.5.4.0.0.1.</span> <span class="toc-text">tasklist | findstr “PID”</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E6%8A%8Aspringboot-%E4%BB%8E251%E6%9B%B4%E6%8D%A2%E4%B8%BA218release%E7%9A%84%E6%97%B6%E5%80%99%E7%9A%84%E6%8A%A5%E9%94%99"><span class="toc-number">2.6.</span> <span class="toc-text">6. 把 Springboot 从 2.5.1 更换为 2.1.8.Release 的时候的报错</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%8E%9F%E5%9B%A0%E5%B0%B1%E6%98%AF251%E5%AF%B9%E5%BA%94%E7%9A%84springcloud%E7%89%88%E6%9C%AC%E6%98%AF3x%E8%80%8C%E6%9B%BF%E6%8D%A2%E4%B8%BAspringboot21x%E7%89%88%E6%9C%AC%E7%9A%84%E6%97%B6%E5%80%99%E5%BA%94%E8%AF%A5%E5%AF%B9%E5%BA%94%E6%9B%BF%E6%8D%A2springcloud%E7%9A%84%E7%89%88%E6%9C%AC"><span class="toc-number">2.6.1.</span> <span class="toc-text">错误原因就是 2.5.1 对应的 springcloud 版本是 3.x，而替换为 springboot2.1.x 版本的时候应该对应替换 springcloud 的版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E6%B7%BB%E5%8A%A0spring-cloud-alibaba%E4%BE%9D%E8%B5%96"><span class="toc-number">2.7.</span> <span class="toc-text">7. 添加 Spring Cloud Alibaba 依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%88%E6%9C%AC%E9%80%89%E6%8B%A9"><span class="toc-number">2.7.1.</span> <span class="toc-text">版本选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E5%8A%A0%E5%85%A5%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%E5%9D%90%E6%A0%87"><span class="toc-number">2.7.2.</span> <span class="toc-text">首先加入依赖管理坐标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0"><span class="toc-number">2.7.3.</span> <span class="toc-text">添加服务注册发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%9C%E7%A8%8B%E6%9C%8D%E5%8A%A1%E8%B0%83%E7%94%A8"><span class="toc-number">2.7.4.</span> <span class="toc-text">测试远程服务调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E5%81%9A%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">2.7.5.</span> <span class="toc-text">Nacos 做配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-pomxml-%E5%BC%95%E5%85%A5-nacos-config-starter"><span class="toc-number">2.7.5.1.</span> <span class="toc-text">1、pom.xml 引入 Nacos Config Starter。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9C%A8%E9%9C%80%E8%A6%81%E7%94%A8%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8%E7%9A%84-srcmainresourcesbootstrapproperties-%E9%85%8D-%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E9%85%8D%E7%BD%AE-nacos"><span class="toc-number">2.7.5.2.</span> <span class="toc-text">2、在需要用配置中心管理服务应用的 &#x2F;src&#x2F;main&#x2F;resources&#x2F;bootstrap.properties 配 置文件中配置 Nacos</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%9C%A8-nacos-%E4%B8%AD%E6%B7%BB%E5%8A%A0%E9%85%8D%E7%BD%AE"><span class="toc-number">2.7.6.</span> <span class="toc-text">3、在 nacos 中添加配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api%E7%BD%91%E5%85%B3gateway"><span class="toc-number">2.7.7.</span> <span class="toc-text">API 网关 Gateway</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E7%AE%80%E5%8D%95%E5%A4%8D%E4%B9%A0"><span class="toc-number">2.8.</span> <span class="toc-text">前端简单复习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es6-%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-number">2.9.</span> <span class="toc-text">ES6 新特性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#let-%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F"><span class="toc-number">2.9.1.</span> <span class="toc-text">let 声明变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#const-%E5%A3%B0%E6%98%8E%E5%B8%B8%E9%87%8F%E5%8F%AA%E8%AF%BB%E5%8F%98%E9%87%8F"><span class="toc-number">2.9.2.</span> <span class="toc-text">const 声明常量（只读变量）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%84%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.9.3.</span> <span class="toc-text">解构表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E8%A7%A3%E6%9E%84"><span class="toc-number">2.9.3.1.</span> <span class="toc-text">数组解构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%BB%93%E6%9E%84"><span class="toc-number">2.9.3.2.</span> <span class="toc-text">对象结构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%89%A9%E5%B1%95"><span class="toc-number">2.9.4.</span> <span class="toc-text">字符串扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E6%96%B0%E7%9A%84-api"><span class="toc-number">2.9.4.1.</span> <span class="toc-text">几个新的 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%A8%A1%E6%9D%BF"><span class="toc-number">2.9.4.2.</span> <span class="toc-text">字符串模板</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E4%BC%98%E5%8C%96"><span class="toc-number">2.9.5.</span> <span class="toc-text">函数优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0%E9%BB%98%E8%AE%A4%E5%80%BC"><span class="toc-number">2.9.5.1.</span> <span class="toc-text">函数参数默认值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E5%AE%9A%E5%8F%82%E6%95%B0"><span class="toc-number">2.9.5.2.</span> <span class="toc-text">不定参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%AD%E5%A4%B4%E5%87%BD%E6%95%B0"><span class="toc-number">2.9.5.3.</span> <span class="toc-text">箭头函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E7%AE%AD%E5%A4%B4%E5%87%BD%E6%95%B0%E7%BB%93%E5%90%88%E8%A7%A3%E6%9E%84%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.9.5.4.</span> <span class="toc-text">实战：箭头函数结合解构表达式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BC%98%E5%8C%96"><span class="toc-number">2.9.6.</span> <span class="toc-text">对象优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E7%9A%84-api"><span class="toc-number">2.9.6.1.</span> <span class="toc-text">新增的 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%AF%B9%E8%B1%A1%E7%AE%80%E5%86%99"><span class="toc-number">2.9.6.2.</span> <span class="toc-text">声明对象简写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%87%BD%E6%95%B0%E5%B1%9E%E6%80%A7%E7%AE%80%E5%86%99"><span class="toc-number">2.9.6.3.</span> <span class="toc-text">对象的函数属性简写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E6%8B%93%E5%B1%95%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">2.9.6.4.</span> <span class="toc-text">对象拓展运算符</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map-%E5%92%8C-reduce"><span class="toc-number">2.9.7.</span> <span class="toc-text">map 和 reduce</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#map"><span class="toc-number">2.9.7.1.</span> <span class="toc-text">map:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#reduce"><span class="toc-number">2.9.7.2.</span> <span class="toc-text">reduce:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promise-%E8%AF%AD%E6%B3%95"><span class="toc-number">2.9.8.</span> <span class="toc-text">Promise 语法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%AE%AD%E5%A4%B4%E5%87%BD%E6%95%B0%E5%8F%AF%E4%BB%A5%E7%AE%80%E5%86%99%E4%B8%BA"><span class="toc-number">2.9.8.1.</span> <span class="toc-text">使用箭头函数可以简写为：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#promise-%E6%94%B9%E9%80%A0%E4%BB%A5%E5%89%8D%E5%B5%8C%E5%A5%97%E6%96%B9"><span class="toc-number">2.9.8.2.</span> <span class="toc-text">Promise 改造以前嵌套方</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%A4%84%E7%90%86"><span class="toc-number">2.9.8.3.</span> <span class="toc-text">优化处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="toc-number">2.9.9.</span> <span class="toc-text">模块化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="toc-number">2.9.9.1.</span> <span class="toc-text">什么是模块化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#export"><span class="toc-number">2.9.9.2.</span> <span class="toc-text">export</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-import"><span class="toc-number">2.9.9.3.</span> <span class="toc-text">3）、import</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E6%9C%8D%E5%8A%A1-api"><span class="toc-number">2.10.</span> <span class="toc-text">商品服务 - API</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB%E6%A0%91%E5%88%A9%E7%94%A8%E9%80%92%E5%BD%92"><span class="toc-number">2.10.1.</span> <span class="toc-text">获取分类树，利用递归</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E5%90%88%E5%89%8D%E7%AB%AF%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86"><span class="toc-number">2.10.2.</span> <span class="toc-text">整合前端分类管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BD%91%E5%85%B3"><span class="toc-number">2.10.3.</span> <span class="toc-text">配置网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E5%85%B3%E8%A7%A3%E5%86%B3%E7%BB%9F%E4%B8%80-%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">2.10.4.</span> <span class="toc-text">网关解决统一 跨域问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88swagger%E6%96%87%E6%A1%A3"><span class="toc-number">2.10.4.1.</span> <span class="toc-text">微服务整合 swagger 文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEproduct%E6%9C%8D%E5%8A%A1%E7%9A%84%E7%BD%91%E5%85%B3"><span class="toc-number">2.10.5.</span> <span class="toc-text">配置 Product 服务的网关</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5%E7%AD%89%E5%89%8D%E7%AB%AF%E5%90%8E%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-number">2.10.6.</span> <span class="toc-text">商品增删改查等前端后端操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%96%E6%8B%BD%E5%8A%9F%E8%83%BD"><span class="toc-number">2.10.6.1.</span> <span class="toc-text">拖拽功能：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%81%E7%89%8C%E7%AE%A1%E7%90%86"><span class="toc-number">2.10.7.</span> <span class="toc-text">品牌管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E4%BA%BA%E4%BA%BA%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E5%B7%A5%E5%85%B7%E7%94%9F%E6%88%90%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">2.10.7.1.</span> <span class="toc-text">利用人人自动生成工具生成前端代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%91%E5%AD%98%E5%82%A8-%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8"><span class="toc-number">2.10.8.</span> <span class="toc-text">云存储 - 文件存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E8%A1%A8%E5%8D%95%E6%A3%80%E9%AA%8C%E8%A7%84%E5%88%99"><span class="toc-number">2.10.9.</span> <span class="toc-text">前端表单检验规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%A0%A1%E9%AA%8Cjsr303"><span class="toc-number">2.10.10.</span> <span class="toc-text">后端校验 JSR303</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%A4%84%E7%90%86%E5%BC%82%E5%B8%B8"><span class="toc-number">2.10.11.</span> <span class="toc-text">统一处理异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%88%86%E7%BB%84%E6%A0%A1%E9%AA%8C%E4%BD%BF%E7%94%A8"><span class="toc-number">2.10.12.</span> <span class="toc-text">后端分组校验使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%A1%E9%AA%8C"><span class="toc-number">2.10.13.</span> <span class="toc-text">自定义校验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spu%E4%B8%8Esku%E7%BC%96%E5%86%99%E5%89%8D%E7%AB%AF%E6%B7%BB%E5%8A%A0%E5%88%86%E7%B1%BB%E5%B1%9E%E6%80%A7%E7%AD%89%E9%A1%B5%E9%9D%A2%E5%8A%9F%E8%83%BD"><span class="toc-number">2.10.14.</span> <span class="toc-text">spu 与 sku，编写前端添加分类属性等页面功能</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BC%A0%E5%80%BC%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">2.10.14.1.</span> <span class="toc-text">父子组件传值的使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E5%AF%B9%E5%BA%94%E6%9C%89%E5%85%B3%E8%81%94%E8%A1%A8%E7%9A%84%E5%A4%9A%E5%AF%B9%E5%A4%9A%E6%83%85%E5%86%B5%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%A4%9A%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8D%E5%BB%BA%E8%AE%AE%E8%BF%9B%E8%A1%8C%E8%BF%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2%E5%85%A5left-right-join-%E8%BF%9E%E6%8E%A5%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.10.15.</span> <span class="toc-text">后端对应有关联表的多对多情况，在数据多的情况不建议进行连表查询入 left right join 连接查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B3%E5%8F%B0%E5%B1%9E%E6%80%A7"><span class="toc-number">2.10.16.</span> <span class="toc-text">平台属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%93%81%E7%BB%B4%E6%8A%A4"><span class="toc-number">2.10.17.</span> <span class="toc-text">商品维护</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E4%BC%A0%E5%80%BC"><span class="toc-number">2.10.17.1.</span> <span class="toc-text">非父子组件传值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vue%E7%BB%84%E4%BB%B6%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1pubsub-js%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4%E8%A7%A3%E6%9E%90"><span class="toc-number">2.10.17.2.</span> <span class="toc-text">Vue 组件间的通信 pubsub-js 实现步骤解析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF-%E5%BD%93%E4%BC%A0%E7%BB%99%E5%89%8D%E7%AB%AF%E7%9A%84%E5%B1%9E%E6%80%A7%E4%B8%BA%E7%A9%BA%E7%9A%84%E6%97%B6%E5%80%99%E5%B0%B1%E6%8C%87%E5%AE%9A%E5%91%8A%E8%AF%89springmvc%E4%B8%BA%E7%A9%BA%E7%9A%84%E5%B1%9E%E6%80%A7%E4%B8%8D%E8%BD%AC%E4%B8%BAjson%E4%BC%A0%E8%BF%87%E5%8E%BB"><span class="toc-number">2.10.18.</span> <span class="toc-text">后端 当传给前端的属性为空的时候就指定告诉 springmvc 为空的属性不转为 json 传过去</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%95%86%E5%93%81"><span class="toc-number">2.10.19.</span> <span class="toc-text">发布商品</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1idea%E5%86%85%E5%AD%98%E8%BF%87%E5%A4%A7%E8%AE%BE%E7%BD%AE%E6%AF%8F%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%8D%A0%E7%94%A8%E7%9A%84%E6%9C%80%E5%A4%A7%E5%86%85%E5%AD%98%E5%92%8C%E7%BB%9F%E4%B8%80%E9%87%8D%E5%90%AF%E6%96%B9%E6%B3%95"><span class="toc-number">2.10.20.</span> <span class="toc-text">微服务 idea 内存过大设置每个服务占用的最大内存，和统一重启方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#spu%E7%AE%A1%E7%90%86"><span class="toc-number">2.10.21.</span> <span class="toc-text">spu 管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%93%E5%82%A8%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="toc-number">2.10.22.</span> <span class="toc-text">仓储服务管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%89%93%E5%8D%B0sql%E8%AF%AD%E5%8F%A5"><span class="toc-number">2.10.23.</span> <span class="toc-text">配置打印 sql 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80%E6%80%BB%E7%BB%93"><span class="toc-number">2.10.24.</span> <span class="toc-text">分布式基础总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%AB%98%E7%BA%A7"><span class="toc-number">3.</span> <span class="toc-text">分布式高级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch"><span class="toc-number">3.0.1.</span> <span class="toc-text">Elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1"><span class="toc-number">3.0.2.</span> <span class="toc-text">商城业务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6%E7%9A%84es"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">创建商品上架的 es</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E6%9E%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.0.2.2.</span> <span class="toc-text">上架实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E9%A1%B5%E6%95%B4%E5%90%88thyemleaf%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.0.2.3.</span> <span class="toc-text">首页整合 thyemleaf 模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D"><span class="toc-number">3.0.2.4.</span> <span class="toc-text">nginx 搭建域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnginx%E4%BB%A3%E7%90%86%E7%BD%91%E5%85%B3"><span class="toc-number">3.0.2.5.</span> <span class="toc-text">配置 nginx 代理网关</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">3.0.3.</span> <span class="toc-text">压力测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">3.0.3.1.</span> <span class="toc-text">性能指标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jmeter"><span class="toc-number">3.0.3.2.</span> <span class="toc-text">JMeter</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-jmeter-%E5%AE%89%E8%A3%85"><span class="toc-number">3.0.3.2.1.</span> <span class="toc-text">1、JMeter 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-jmeter-%E5%8E%8B%E6%B5%8B%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.0.3.2.2.</span> <span class="toc-text">2、JMeter 压测示例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-jmeter-address-already-in-use-%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span class="toc-number">3.0.3.2.3.</span> <span class="toc-text">3、JMeter Address Already in use 错误解决</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="toc-number">3.0.4.</span> <span class="toc-text">性能监控</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-jvisualvm-%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">3.0.4.0.1.</span> <span class="toc-text">1、jvisualvm 能干什么</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6%E6%96%B9%E4%BE%BF%E6%9F%A5%E7%9C%8B-gc"><span class="toc-number">3.0.4.0.2.</span> <span class="toc-text">2、安装插件方便查看 gc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87"><span class="toc-number">3.0.4.0.3.</span> <span class="toc-text">4、监控指标</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-jvm-%E5%88%86%E6%9E%90%E8%B0%83%E4%BC%98"><span class="toc-number">3.0.4.0.4.</span> <span class="toc-text">5、JVM 分析 &amp; 调优</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">3.0.4.1.</span> <span class="toc-text">Nginx 动静分离</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">3.0.5.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%90%88redis"><span class="toc-number">3.0.5.1.</span> <span class="toc-text">整合 Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BAredis%E7%BC%93%E5%AD%98%E5%90%8E%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">3.0.5.2.</span> <span class="toc-text">修改为 Redis 缓存后进行压力测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">3.0.6.</span> <span class="toc-text">缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B7%E9%94%81"><span class="toc-number">3.0.6.1.</span> <span class="toc-text">单体枷锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%8B%E5%8A%A0%E9%94%81"><span class="toc-number">3.0.6.2.</span> <span class="toc-text">分布式下加锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">3.0.6.3.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">检索服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-number">3.1.1.</span> <span class="toc-text">搭建环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2"><span class="toc-number">3.1.2.</span> <span class="toc-text">检索</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#es%E6%A3%80%E7%B4%A2%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Es 检索语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#es%E8%81%9A%E5%90%88%E8%AF%AD%E5%8F%A5"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">Es 聚合语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#es%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">Es 代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E6%B8%B2%E6%9F%93"><span class="toc-number">3.1.3.</span> <span class="toc-text">页面渲染</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E4%B9%A0"><span class="toc-number">3.2.</span> <span class="toc-text">异步复习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%95%86%E5%93%81%E8%AF%A6%E6%83%85"><span class="toc-number">3.3.</span> <span class="toc-text">商品详情</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%BC%82%E6%AD%A5%E7%BC%96%E6%8E%92"><span class="toc-number">3.3.1.</span> <span class="toc-text">业务异步编排</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">绑定线程池配置类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8A%A0%E5%85%A5%E5%88%B0%E5%AE%B9%E5%99%A8"><span class="toc-number">3.3.1.3.</span> <span class="toc-text">配置线程池加入到容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.3.1.4.</span> <span class="toc-text">代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.4.</span> <span class="toc-text">认证服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6"><span class="toc-number">3.5.</span> <span class="toc-text">购物车</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%AD%E7%89%A9%E8%BD%A6vo"><span class="toc-number">3.5.1.</span> <span class="toc-text">购物车 vo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.5.2.</span> <span class="toc-text">配置拦截器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mq%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">3.6.</span> <span class="toc-text">MQ 消息队列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.7.</span> <span class="toc-text">订单服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#feign%E8%BF%9C%E7%A8%8B%E4%B8%A2%E5%A4%B1%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.8.</span> <span class="toc-text">Feign 远程丢失请求头</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#feign%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B8%A2%E5%A4%B1%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.9.</span> <span class="toc-text">Feign 异步模式丢失上下文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">3.10.</span> <span class="toc-text">幂等性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A7%92%E6%9D%80"><span class="toc-number">3.11.</span> <span class="toc-text">秒杀</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4"><span class="toc-number">4.</span> <span class="toc-text">分布式集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95"><span class="toc-number">4.1.</span> <span class="toc-text">错误记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BD%BF%E7%94%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E6%97%B6%E5%80%99%E5%AF%BC%E5%85%A5%E5%85%AC%E5%85%B1%E6%A8%A1%E5%9D%97%E5%AF%BC%E8%87%B4maven%E6%9B%B4%E6%96%B0%E4%BE%9D%E8%B5%96%E9%94%99%E8%AF%AF%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.1.</span> <span class="toc-text">微服务使用模块化时候导入公共模块导致 maven 更新依赖错误问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E8%B6%85%E6%97%B6%E6%8A%A5%E9%94%99"><span class="toc-number">4.1.2.</span> <span class="toc-text">远程调用服务超时报错</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven%E7%BC%96%E8%AF%91%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98"><span class="toc-number">4.1.3.</span> <span class="toc-text">maven 编译乱码问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#maven"><span class="toc-number">4.1.4.</span> <span class="toc-text">maven</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E8%A7%A3%E5%86%B3javalangillegalstateexception-failed-to-introspect-class"><span class="toc-number">5.</span> <span class="toc-text">异常解决：java.lang.IllegalStateException: Failed to introspect Class</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#javalangillegalstateexception-failed-to-introspect-class"><span class="toc-number">5.0.1.</span> <span class="toc-text">java.lang.IllegalStateException: Failed to introspect Class</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E8%AF%A6%E6%83%85"><span class="toc-number">6.</span> <span class="toc-text">异常详情</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E5%9B%A0"><span class="toc-number">7.</span> <span class="toc-text">原因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">8.</span> <span class="toc-text">解决办法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#seata%E9%94%99%E8%AF%AF%E5%BC%82%E5%B8%B8"><span class="toc-number">8.1.</span> <span class="toc-text">Seata 错误异常</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98"><span class="toc-number">8.2.</span> <span class="toc-text">循环依赖问题</span></a></li></ol></li></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/worknote/security-jwt-vue/amdin-back/" rel="bookmark" title="开发SpringBoot+Jwt+Vue的前后端分离后台管理系统VueAdmin - 后端笔记">开发SpringBoot+Jwt+Vue的前后端分离后台管理系统VueAdmin - 后端笔记</a></li><li><a href="/worknote/easypoi-1/" rel="bookmark" title="easypoi导出大量数据">easypoi导出大量数据</a></li><li><a href="/worknote/javautil/util-1/" rel="bookmark" title="用于将汉语的数字转换为阿拉伯数字">用于将汉语的数字转换为阿拉伯数字</a></li><li><a href="/worknote/javautil/util-2/" rel="bookmark" title="JDBC增删改查">JDBC增删改查</a></li><li><a href="/worknote/javautil/util-3/" rel="bookmark" title="文件进行重命名">文件进行重命名</a></li><li><a href="/worknote/javautil/util-4/" rel="bookmark" title="JDBC连接工具">JDBC连接工具</a></li><li><a href="/worknote/javautil/util-5/" rel="bookmark" title="判断对象中属性值是否全为空">判断对象中属性值是否全为空</a></li><li><a href="/worknote/javautil/util-8/" rel="bookmark" title="驼峰转换工具">驼峰转换工具</a></li><li><a href="/worknote/javautil/util-7/" rel="bookmark" title="保留小数工具">保留小数工具</a></li><li><a href="/worknote/javautil/utli-6/" rel="bookmark" title="随机生成随机码工具">随机生成随机码工具</a></li><li><a href="/worknote/easypoi-2/" rel="bookmark" title="easypoi导出复杂表">easypoi导出复杂表</a></li><li><a href="/worknote/Interview-2/" rel="bookmark" title="面试题笔记记录(二)面试必考题（通俗易懂精华版）">面试题笔记记录(二)面试必考题（通俗易懂精华版）</a></li><li><a href="/worknote/digui-1/" rel="bookmark" title="递归解决权限树或多级联动的两种方法">递归解决权限树或多级联动的两种方法</a></li><li><a href="/worknote/interview-4/" rel="bookmark" title="面试总结之北京行">面试总结之北京行</a></li><li><a href="/worknote/interview-3/" rel="bookmark" title="面试题笔记记录(三)周阳尚硅谷版">面试题笔记记录(三)周阳尚硅谷版</a></li><li><a href="/worknote/note-1/" rel="bookmark" title="日常笔记之Spring Boot配置指定配置类">日常笔记之Spring Boot配置指定配置类</a></li><li><a href="/worknote/note-2/" rel="bookmark" title="日常笔记之幂等性">日常笔记之幂等性</a></li><li><a href="/worknote/order-3/" rel="bookmark" title="尚硅谷订单服务笔记之秒杀">尚硅谷订单服务笔记之秒杀</a></li><li class="active"><a href="/worknote/gulinote/" rel="bookmark" title="谷粒商城笔记">谷粒商城笔记</a></li><li><a href="/worknote/order-1/" rel="bookmark" title="尚硅谷订单服务笔记">尚硅谷订单服务笔记</a></li><li><a href="/worknote/order-2/" rel="bookmark" title="尚硅谷订单服务笔记之整合支付">尚硅谷订单服务笔记之整合支付</a></li><li><a href="/worknote/swagger-1/" rel="bookmark" title="微服务整合公共Swagger2以及微服务引用公共模块没有填进容器">微服务整合公共Swagger2以及微服务引用公共模块没有填进容器</a></li><li><a href="/worknote/Interview-1/" rel="bookmark" title="面试题笔记记录(一)">面试题笔记记录(一)</a></li><li><a href="/worknote/jvm-1/" rel="bookmark" title="JVM(一)">JVM(一)</a></li><li><a href="/worknote/spring-cycle-1/" rel="bookmark" title="Spring循环依赖">Spring循环依赖</a></li><li><a href="/worknote/timing-1/" rel="bookmark" title="定时任务">定时任务</a></li><li><a href="/worknote/interface-safety-1/" rel="bookmark" title="接口安全性">接口安全性</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="WangXuefeng" data-src="/images/avatar.jpg"><p class="name" itemprop="name">WangXuefeng</p><div class="description" itemprop="description">日常学习 & 复习记录</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">85</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">25</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">44</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL294eXplbi13eGY=" title="https:&#x2F;&#x2F;github.com&#x2F;oxyzen-wxf"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTYwNzA2MDI0MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;607060241"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjk2MzIxMDczOEBxcS5jb20=" title="mailto:963210738@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/worknote/order-1/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/worknote/order-3/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/designpattern/" title="分类于 设计模式">设计模式</a></div><span><a href="/computer-science/java/designpattern/desgin-3/" title="设计模式之单例模式">设计模式之单例模式</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/javaframe/" title="分类于 Java框架">Java框架</a></div><span><a href="/computer-science/java/javaframe/spring-aop-1/" title="Spring之AOP(一)">Spring之AOP(一)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/microservice/" title="分类于 微服务分布式">微服务分布式</a></div><span><a href="/computer-science/java/microservice/lock-1/" title="分布式锁（一）之Redis分布式锁">分布式锁（一）之Redis分布式锁</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/designpattern/" title="分类于 设计模式">设计模式</a></div><span><a href="/computer-science/java/designpattern/design-8/" title="设计模式之桥接模式(-)">设计模式之桥接模式(-)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/order-1/" title="尚硅谷订单服务笔记">尚硅谷订单服务笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/spring-cycle-1/" title="Spring循环依赖">Spring循环依赖</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/javautil/" title="分类于 Java常用工具">Java常用工具</a></div><span><a href="/computer-science/java/javautil/sms-1/" title="Ali短信验证码接收">Ali短信验证码接收</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/javahigh/" title="分类于 Java高级">Java高级</a></div><span><a href="/computer-science/java/javahigh/foreach-1/" title="Java8的forEach">Java8的forEach</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/microservice/" title="分类于 微服务分布式">微服务分布式</a></div><span><a href="/computer-science/java/microservice/sentinel-1/" title="Sentinel">Sentinel</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/mysql/" title="分类于 Mysql">Mysql</a></div><span><a href="/database/mysql/mysql-2/" title="Mysql高级优化之最左前缀匹配原则">Mysql高级优化之最左前缀匹配原则</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">WangXuefeng @ Oxygen Anoxia</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">631k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">9:34</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"worknote/gulinote/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:{placeholder:"1. 提问前请先仔细阅读本文档⚡\n2. 页面显示问题💥，请提供控制台截图📸或者您的测试网址\n3. 其他任何报错💣，请提供详细描述和截图📸，文章为个人见解，有问题请评论指出，及时修改🙅‍，祝食用愉快💪"},fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->