<!-- build time:Mon Jul 18 2022 22:16:35 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://oxyzen-wxf.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://oxyzen-wxf.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://oxyzen-wxf.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="java,Spring Boot"><link rel="canonical" href="https://oxyzen-wxf.github.io/worknote/order-1/"><title>尚硅谷订单服务笔记 - Java - 工作日常笔记 | Oxygen Anoxia = = 人生当苦无妨，良人当归即好!</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">尚硅谷订单服务笔记</h1><div class="meta"><span class="item" title="创建时间：2021-07-10 11:44:55"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-07-10T11:44:55+08:00">2021-07-10</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>29k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>26 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Oxygen Anoxia</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeu7txpzj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclwuom7cj20zk0m8dvn.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipevarprfj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclxxcb6rj20zk0m8b29.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/worknote/" itemprop="item" rel="index" title="分类于 工作日常笔记"><span itemprop="name">工作日常笔记</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/worknote/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://oxyzen-wxf.github.io/worknote/order-1/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="WangXuefeng"><meta itemprop="description" content="人生当苦无妨，良人当归即好!, 日常学习 & 复习记录"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><h2 id="订单"><a class="anchor" href="#订单">#</a> 订单</h2><h3 id="1-订单中心"><a class="anchor" href="#1-订单中心">#</a> 1、订单中心</h3><p>电商系统涉及到 3 流，分别时信息流，资金流，物流，而订单系统作为中枢将三者有机的集合起来。</p><p>订单模块是电商系统的枢纽，在订单这个环节上需求获取多个模块的数据和信息，同时对这些信息进行加工处理后流向下个环节，这一系列就构成了订单的信息流通。</p><h3 id="2-订单构成"><a class="anchor" href="#2-订单构成">#</a> 2、订单构成</h3><p><img data-src="../../assets/image-20210725160622479.png" alt="image-20210725160622479"></p><h4 id="1-用户信息"><a class="anchor" href="#1-用户信息">#</a> 1、用户信息</h4><p>用户信息包括用户账号、用户等级、用户的收货地址、收货人、收货人电话等组成，用户账 户需要绑定手机号码，但是用户绑定的手机号码不一定是收货信息上的电话。用户可以添加 多个收货信息，用户等级信息可以用来和促销系统进行匹配，获取商品折扣，同时用户等级 还可以获取积分的奖励等</p><h4 id="2-订单基础信息"><a class="anchor" href="#2-订单基础信息">#</a> 2、订单基础信息</h4><p>订单基础信息是订单流转的核心，其包括订单类型、父 / 子订单、订单编号、订单状态、订 单流转的时间等。</p><p>（1）订单类型包括实体商品订单和虚拟订单商品等，这个根据商城商品和服务类型进行区 分。</p><p>（2）同时订单都需要做父子订单处理，之前在初创公司一直只有一个订单，没有做父子订 单处理后期需要进行拆单的时候就比较麻烦，尤其是多商户商场，和不同仓库商品的时候， 父子订单就是为后期做拆单准备的。</p><p>（3）订单编号不多说了，需要强调的一点是父子订单都需要有订单编号，需要完善的时候 可以对订单编号的每个字段进行统一定义和诠释。</p><p>（4）订单状态记录订单每次流转过程，后面会对订单状态进行单独的说明。</p><p>（5）订单流转时间需要记录下单时间，支付时间，发货时间，结束时间 / 关闭时间等等</p><h4 id="3-商品信息"><a class="anchor" href="#3-商品信息">#</a> 3、商品信息</h4><p>商品信息从商品库中获取商品的 SKU 信息、图片、名称、属性规格、商品单价、商户信息 等，从用户下单行为记录的用户下单数量，商品合计价格等。</p><h4 id="4-优惠信息"><a class="anchor" href="#4-优惠信息">#</a> 4、优惠信息</h4><p>优惠信息记录用户参与的优惠活动，包括优惠促销活动，比如满减、满赠、秒杀等，用户使 用的优惠券信息，优惠券满足条件的优惠券需要默认展示出来，具体方式已在之前的优惠券 篇章做过详细介绍，另外还虚拟币抵扣信息等进行记录。</p><p>为什么把优惠信息单独拿出来而不放在支付信息里面呢？</p><p>因为优惠信息只是记录用户使用的条目，而支付信息需要加入数据进行计算，所以做为区分。</p><h4 id="5-支付信息"><a class="anchor" href="#5-支付信息">#</a> 5. 支付信息</h4><p>（1）支付流水单号，这个流水单号是在唤起网关支付后支付通道返回给电商业务平台的支 付流水号，财务通过订单号和流水单号与支付通道进行对账使用。</p><p>（2）支付方式用户使用的支付方式，比如微信支付、支付宝支付、钱包支付、快捷支付等。 支付方式有时候可能有两个 —— 余额支付 + 第三方支付。</p><p>（3）商品总金额，每个商品加总后的金额；运费，物流产生的费用；优惠总金额，包括促 销活动的优惠金额，优惠券优惠金额，虚拟积分或者虚拟币抵扣的金额，会员折扣的金额等 之和；实付金额，用户实际需要付款的金额。</p><p>​ 用户实付金额 = 商品总金额 + 运费 - 优惠总金额</p><h4 id="6-物流信息"><a class="anchor" href="#6-物流信息">#</a> 6. 物流信息</h4><p>物流信息包括配送方式，物流公司，物流单号，物流状态，物流状态可以通过第三方接口来 获取和向用户展示物流每个状态节点。</p><h3 id="3-订单状态"><a class="anchor" href="#3-订单状态">#</a> 3、订单状态</h3><h4 id="1-待付款"><a class="anchor" href="#1-待付款">#</a> 1. 待付款</h4><p>用户提交订单后，订单进行预下单，目前主流电商网站都会唤起支付，便于用户快速完成支 付，需要注意的是待付款状态下可以对库存进行锁定，锁定库存需要配置支付超时时间，超 时后将自动取消订单，订单变更关闭状态。</p><h4 id="2-已付款待发货"><a class="anchor" href="#2-已付款待发货">#</a> 2. 已付款 / 待发货</h4><p>用户完成订单支付，订单系统需要记录支付时间，支付流水单号便于对账，订单下放到 WMS 系统，仓库进行调拨，配货，分拣，出库等操作。</p><h4 id="3-待收货已发货"><a class="anchor" href="#3-待收货已发货">#</a> 3. 待收货 / 已发货</h4><p>仓储将商品出库后，订单进入物流环节，订单系统需要同步物流信息，便于用户实时知悉物 品物流状态</p><h4 id="4-已完成"><a class="anchor" href="#4-已完成">#</a> 4. 已完成</h4><p>用户确认收货后，订单交易完成。后续支付侧进行结算，如果订单存在问题进入售后状态</p><h4 id="5-已取消"><a class="anchor" href="#5-已取消">#</a> 5. 已取消</h4><p>付款之前取消订单。包括超时未付款或用户商户取消订单都会产生这种订单状态。</p><h4 id="6-售后中"><a class="anchor" href="#6-售后中">#</a> 6. 售后中</h4><p>用户在付款后申请退款，或商家发货后用户申请退换货。</p><p>售后也同样存在各种状态，当发起售后申请后生成售后订单，售后订单状态为待审核，等待 商家审核，商家审核通过后订单状态变更为待退货，等待用户将商品寄回，商家收货后订单 状态更新为待退款状态，退款到用户原账户后订单状态更新为售后成功。</p><h3 id="4-订单流程"><a class="anchor" href="#4-订单流程">#</a> 4、订单流程</h3><p>订单流程是指从订单产生到完成整个流转的过程，从而行程了一套标准流程规则。而不同的 产品类型或业务类型在系统中的流程会千差万别，比如上面提到的线上实物订单和虚拟订单 的流程，线上实物订单与 O2O 订单等，所以需要根据不同的类型进行构建订单流程。</p><p>不管类型如何订单都包括正向流程和逆向流程，对应的场景就是购买商品和退换货流程，正 向流程就是一个正常的网购步骤：订单生成–&gt; 支付订单–&gt; 卖家发货–&gt; 确认收货–&gt; 交易成功。 而每个步骤的背后，订单是如何在多系统之间交互流转的，可概括如下图</p><p><img data-src="../../assets/image-20210725161353440.png" alt="image-20210725161353440"></p><h4 id="1-订单创建与支付"><a class="anchor" href="#1-订单创建与支付">#</a> 1、订单创建与支付</h4><p>(1) 、订单创建前需要预览订单，选择收货信息等<br>(2) 、订单创建需要锁定库存，库存有才可创建，否则不能创建<br>(3) 、订单创建后超时未支付需要解锁库存<br>(4) 、支付成功后，需要进行拆单，根据商品打包方式，所在仓库，物流等进行拆单<br>(5) 、支付的每笔流水都需要记录，以待查账<br>(6) 、订单创建，支付成功等状态都需要给 MQ 发送消息，方便其他系统感知订阅</p><h4 id="2-逆向流程"><a class="anchor" href="#2-逆向流程">#</a> 2、逆向流程</h4><p>(1) 、修改订单，用户没有提交订单，可以对订单一些信息进行修改，比如配送信息，<br>优惠信息，及其他一些订单可修改范围的内容，此时只需对数据进行变更即可。<br>(2) 、订单取消，<strong>用户主动取消订单和用户超时未支付</strong>，两种情况下订单都会取消订<br>单，而超时情况是系统自动关闭订单，所以在订单支付的响应机制上面要做支付的<br>限时处理，尤其是在前面说的下单减库存的情形下面，可以保证快速的释放库存。<br>另外需要需要处理的是促销优惠中使用的优惠券，权益等视平台规则，进行相应补<br>回给用户。<br>(3) 、退款，在待发货订单状态下取消订单时，分为缺货退款和用户申请退款。如果是<br>全部退款则订单更新为关闭状态，若只是做部分退款则订单仍需进行进行，同时生<br>成一条退款的售后订单，走退款流程。退款金额需原路返回用户的账户。<br>(4) 、发货后的退款，发生在仓储货物配送，在配送过程中商品遗失，用户拒收，用户<br>收货后对商品不满意，这样情况下用户发起退款的售后诉求后，需要商户进行退款<br>的审核，双方达成一致后，系统更新退款状态，对订单进行退款操作，金额原路返<br>回用户的账户，同时关闭原订单数据。仅退款情况下暂不考虑仓库系统变化。如果<br>发生双方协调不一致情况下，可以申请平台客服介入。在退款订单商户不处理的情<br>况下，系统需要做限期判断，比如 5 天商户不处理，退款单自动变更同意退款。</p><h4 id="3-幂等性处理"><a class="anchor" href="#3-幂等性处理">#</a> 3、幂等性处理</h4><p>参照幂等性文档</p><h2 id="订单业务"><a class="anchor" href="#订单业务">#</a> 订单业务</h2><h2 id="代码"><a class="anchor" href="#代码">#</a> 代码</h2><h3 id="配置拦截器"><a class="anchor" href="#配置拦截器">#</a> 配置拦截器</h3><p><strong>因为没有用权限框架，所以获取判断是否登录，并把登录信息存到 ThreadLocal 中</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderWebConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">LoginUserInterceptor</span> loginUserInterceptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span><span class="token class-name">InterceptorRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span>loginUserInterceptor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginUserInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">></span></span> loginUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">MemberResponseVo</span> attribute <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberResponseVo</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">AuthServerConstant</span><span class="token punctuation">.</span>LOGIN_USER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>attribute <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token comment">// 只有登录了才能访问</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            loginUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 没登陆就去登录</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        request<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">"msg"</span><span class="token punctuation">,</span> <span class="token string">"请先登录！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"http://auth.gulimall.com/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="订单确认实体"><a class="anchor" href="#订单确认实体">#</a> 订单确认实体</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderConfirmVo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/** 会员收获地址列表 **/</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">></span></span> memberAddressVos<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/** 所有选中的购物项 **/</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> items<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/** 发票记录 **/</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/** 优惠券（会员积分） **/</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> integration<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/** 防止重复提交的令牌 **/</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderToken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Getter</span> <span class="token annotation punctuation">@Setter</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> stocks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">Integer</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                count <span class="token operator">+=</span> item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">return</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">/** 订单总额 **/</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">//BigDecimal total;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// 计算订单总额</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token class-name">BigDecimal</span> totalNum <span class="token operator">=</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>items <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> items<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemVo</span> item <span class="token operator">:</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token comment">// 计算当前商品的总价格</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token class-name">BigDecimal</span> itemPrice <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token comment">// 再计算全部商品的总价格</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                totalNum <span class="token operator">=</span> totalNum<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>itemPrice<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> totalNum<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/** 应付价格 **/</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">//BigDecimal payPrice;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">BigDecimal</span> <span class="token function">getPayPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="订单业务代码"><a class="anchor" href="#订单业务代码">#</a> 订单业务代码</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">OrderConfirmVo</span> confirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 1 获取登录人</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">MemberResponseVo</span> vo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取请求</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 2 远程调用查询收货地址列表</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">></span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 3 远程调用查询购物车所选购物项</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        confirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 4 查询用户积分</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    confirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 5 其他数据自动计算</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">// 6 todo 防重令牌</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span>f2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">return</span> confirmVo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="feign远程丢失请求头"><a class="anchor" href="#feign远程丢失请求头">#</a> Feign 远程丢失请求头</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFeignConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     * 配置 feign 拦截器，添加 RequestInterceptor，把传过来的请求头</pre></td></tr><tr><td data-num="6"></td><td><pre>     * 转给 feign 远程调用带过去，源码会遍历 RequestInterceptor 集合调用 apply（）方法</pre></td></tr><tr><td data-num="7"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="8"></td><td><pre>     */</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> requestTemplate <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token class-name">ServletRequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token class-name">String</span> cookie <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    </pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="feign异步模式丢失上下文"><a class="anchor" href="#feign异步模式丢失上下文">#</a> Feign 异步模式丢失上下文</h3><p><strong>原因：因为开启异步多线程，当前请求走的是一个请求的线程，路过 feign 调用开启的异步线程与请求线程不一样，所以我们可以通过传递请求的方式解决，否则 feign 拦截的 request 请求将为 null</strong></p><p><strong>解决</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取请求</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 2 远程调用查询收货地址列表</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">></span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="订单解决幂等性"><a class="anchor" href="#订单解决幂等性">#</a> 订单解决幂等性</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">OrderConfirmVo</span> <span class="token function">confirmOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ExecutionException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">OrderConfirmVo</span> confirmVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderConfirmVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 1 获取登录人</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">MemberResponseVo</span> vo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取请求</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">RequestAttributes</span> requestAttributes <span class="token operator">=</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f1 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 2 远程调用查询收货地址列表</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MemberAddressVo</span><span class="token punctuation">></span></span> address <span class="token operator">=</span> memberFeignService<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        confirmVo<span class="token punctuation">.</span><span class="token function">setMemberAddressVos</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span> f2 <span class="token operator">=</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">runAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 每个线程都共享之前过来的请求</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">setRequestAttributes</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 3 远程调用查询购物车所选购物项</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> items <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        confirmVo<span class="token punctuation">.</span><span class="token function">setItems</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenRunAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> items <span class="token operator">=</span> confirmVo<span class="token punctuation">.</span><span class="token function">getItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 获取全部商品的 id</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> skuIds <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>itemVo <span class="token operator">-></span> itemVo<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 远程查询商品库存信息</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">R</span> skuHasStock <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">getSkuHasStock</span><span class="token punctuation">(</span>skuIds<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuStockVo</span><span class="token punctuation">></span></span> skuStockVos <span class="token operator">=</span> skuHasStock<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">SkuStockVo</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>skuStockVos <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> skuStockVos<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 将 skuStockVos 集合转换为 map</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">></span></span> skuHasStockMap <span class="token operator">=</span> skuStockVos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">SkuStockVo</span><span class="token operator">::</span><span class="token function">getSkuId</span><span class="token punctuation">,</span> <span class="token class-name">SkuStockVo</span><span class="token operator">::</span><span class="token function">getHasStock</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            confirmVo<span class="token punctuation">.</span><span class="token function">setStocks</span><span class="token punctuation">(</span>skuHasStockMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 4 查询用户积分</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name">Integer</span> integration <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    confirmVo<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 5 其他数据自动计算</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token comment">// 6 todo 防重令牌 ---------------------</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token class-name">String</span> token <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">OrderConstant</span><span class="token punctuation">.</span>USER_ORDER_TOKEN_PREFIX<span class="token operator">+</span>vo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>DAYS<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    confirmVo<span class="token punctuation">.</span><span class="token function">setOrderToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token class-name">CompletableFuture</span><span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>f1<span class="token punctuation">,</span>f2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">return</span> confirmVo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="下单代码"><a class="anchor" href="#下单代码">#</a> 下单代码</h3><p><strong>提交订单实体</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSubmitVo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/** 收获地址的 id **/</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> addrId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/** 支付方式 **/</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> payType<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 无需提交要购买的商品，去购物车再获取一遍</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 优惠、发票</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">/** 防重令牌 **/</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderToken<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/** 应付价格 **/</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> payPrice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">/** 订单备注 **/</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> remarks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 用户相关的信息，直接去 session 中取出即可</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建订单实体</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreateTo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderEntity</span> order<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> orderItems<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">/** 订单计算的应付价格 **/</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> payPrice<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">/** 运费 **/</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">BigDecimal</span> fare<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="创建订单"><a class="anchor" href="#创建订单">#</a> 创建订单</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">OrderCreateTo</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">OrderCreateTo</span> createTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreateTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//1、生成订单号</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> <span class="token class-name">IdWorker</span><span class="token punctuation">.</span><span class="token function">getTimeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token function">builderOrder</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">//2、获取到所有的订单项</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> orderItemEntities <span class="token operator">=</span> <span class="token function">builderOrderItems</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//3、验价 (计算价格、积分等信息)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">computePrice</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">,</span>orderItemEntities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    createTo<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    createTo<span class="token punctuation">.</span><span class="token function">setOrderItems</span><span class="token punctuation">(</span>orderItemEntities<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> createTo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="构建订单数据"><a class="anchor" href="#构建订单数据">#</a> 构建订单数据</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 构建订单数据</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param orderSn</pre></td></tr><tr><td data-num="4"></td><td><pre> * @return</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">OrderEntity</span> <span class="token function">builderOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 获取当前用户登录信息</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">MemberResponseVo</span> memberResponseVo <span class="token operator">=</span> <span class="token class-name">LoginUserInterceptor</span><span class="token punctuation">.</span>loginUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">OrderEntity</span> orderEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setMemberId</span><span class="token punctuation">(</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setMemberUsername</span><span class="token punctuation">(</span>memberResponseVo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">OrderSubmitVo</span> orderSubmitVo <span class="token operator">=</span> confirmVoThreadLocal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 远程获取收货地址和运费信息</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name">R</span> fareAddressVo <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">getFare</span><span class="token punctuation">(</span>orderSubmitVo<span class="token punctuation">.</span><span class="token function">getAddrId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">FareVo</span> fareResp <span class="token operator">=</span> fareAddressVo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FareVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 获取到运费信息</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token class-name">BigDecimal</span> fare <span class="token operator">=</span> fareResp<span class="token punctuation">.</span><span class="token function">getFare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setFreightAmount</span><span class="token punctuation">(</span>fare<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">// 获取到收货地址信息</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">MemberAddressVo</span> address <span class="token operator">=</span> fareResp<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 设置收货人信息</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverName</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverPhone</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getPhone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverPostCode</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getPostCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverProvince</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverCity</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverRegion</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setReceiverDetailAddress</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">getDetailAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 设置订单相关的状态信息</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CREATE_NEW<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setAutoConfirmDay</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setConfirmStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">return</span> orderEntity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="构建订单项数据"><a class="anchor" href="#构建订单项数据">#</a> 构建订单项数据</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 构建所有订单项数据</pre></td></tr><tr><td data-num="3"></td><td><pre> * @return</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> <span class="token function">builderOrderItems</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderSn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> orderItemEntityList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 最后确定每个购物项的价格</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> currentCartItems <span class="token operator">=</span> cartFeignService<span class="token punctuation">.</span><span class="token function">getCurrentCartItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentCartItems <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> currentCartItems<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        orderItemEntityList <span class="token operator">=</span> currentCartItems<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token comment">// 构建订单项数据</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token class-name">OrderItemEntity</span> orderItemEntity <span class="token operator">=</span> <span class="token function">builderOrderItem</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            orderItemEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">return</span> orderItemEntity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">return</span> orderItemEntityList<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre> * 构建某一个订单项的数据</pre></td></tr><tr><td data-num="26"></td><td><pre> * @param items</pre></td></tr><tr><td data-num="27"></td><td><pre> * @return</pre></td></tr><tr><td data-num="28"></td><td><pre> */</pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">OrderItemEntity</span> <span class="token function">builderOrderItem</span><span class="token punctuation">(</span><span class="token class-name">OrderItemVo</span> items<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token class-name">OrderItemEntity</span> orderItemEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token comment">//1、商品的 spu 信息</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token class-name">Long</span> skuId <span class="token operator">=</span> items<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// 获取 spu 的信息</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token class-name">R</span> spuInfo <span class="token operator">=</span> productFeignService<span class="token punctuation">.</span><span class="token function">getSpuInfoBySkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token class-name">SpuInfoVo</span> spuInfoData <span class="token operator">=</span> spuInfo<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SpuInfoVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSpuId</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSpuName</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getSpuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSpuBrand</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getBrandName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setCategoryId</span><span class="token punctuation">(</span>spuInfoData<span class="token punctuation">.</span><span class="token function">getCatalogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">//2、商品的 sku 信息</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuName</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuPic</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuPrice</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuQuantity</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">// 使用 StringUtils.collectionToDelimitedString 将 list 集合转换为 String</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token class-name">String</span> skuAttrValues <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">collectionToDelimitedString</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getSkuAttrValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setSkuAttrsVals</span><span class="token punctuation">(</span>skuAttrValues<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">//3、商品的优惠信息</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">//4、商品的积分信息</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setGiftGrowth</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setGiftIntegration</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>items<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token comment">//5、订单项的价格信息</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setPromotionAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setCouponAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setIntegrationAmount</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span>ZERO<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token comment">// 当前订单项的实际金额。总额 - 各种优惠价格</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">// 原来的价格</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token class-name">BigDecimal</span> origin <span class="token operator">=</span> orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getSkuQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token comment">// 原价减去优惠价得到最终的价格</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token class-name">BigDecimal</span> subtract <span class="token operator">=</span> origin<span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getCouponAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getPromotionAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">subtract</span><span class="token punctuation">(</span>orderItemEntity<span class="token punctuation">.</span><span class="token function">getIntegrationAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    orderItemEntity<span class="token punctuation">.</span><span class="token function">setRealAmount</span><span class="token punctuation">(</span>subtract<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">return</span> orderItemEntity<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="计算价格"><a class="anchor" href="#计算价格">#</a> 计算价格</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 计算价格的方法</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param orderEntity</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param orderItemEntities</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">computePrice</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> orderItemEntities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 总价</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">BigDecimal</span> total <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 优惠价</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">BigDecimal</span> coupon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">BigDecimal</span> intergration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">BigDecimal</span> promotion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span><span class="token string">"0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 积分、成长值</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">Integer</span> integrationTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">Integer</span> growthTotal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 订单总额，叠加每一个订单项的总额信息</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderItemEntity</span> orderItem <span class="token operator">:</span> orderItemEntities<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 优惠价格信息</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        coupon <span class="token operator">=</span> coupon<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getCouponAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        promotion <span class="token operator">=</span> promotion<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getPromotionAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        intergration <span class="token operator">=</span> intergration<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getIntegrationAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 总价</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        total <span class="token operator">=</span> total<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderItem<span class="token punctuation">.</span><span class="token function">getRealAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// 积分信息和成长值信息</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        integrationTotal <span class="token operator">+=</span> orderItem<span class="token punctuation">.</span><span class="token function">getGiftIntegration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        growthTotal <span class="token operator">+=</span> orderItem<span class="token punctuation">.</span><span class="token function">getGiftGrowth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">//1、订单价格相关的</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setTotalAmount</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token comment">// 设置应付总额 (总额 + 运费)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setPayAmount</span><span class="token punctuation">(</span>total<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">.</span><span class="token function">getFreightAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setCouponAmount</span><span class="token punctuation">(</span>coupon<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setPromotionAmount</span><span class="token punctuation">(</span>promotion<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setIntegrationAmount</span><span class="token punctuation">(</span>intergration<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">// 设置积分成长值信息</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setIntegration</span><span class="token punctuation">(</span>integrationTotal<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setGrowth</span><span class="token punctuation">(</span>growthTotal<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// 设置删除状态 (0 - 未删除，1 - 已删除)</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    orderEntity<span class="token punctuation">.</span><span class="token function">setDeleteStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="保存订单数据"><a class="anchor" href="#保存订单数据">#</a> 保存订单数据</h4><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 保存订单所有数据</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param orderCreateTo</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderCreateTo</span> orderCreateTo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取订单信息</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">OrderEntity</span> order <span class="token operator">=</span> orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setModifyTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 保存订单</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 获取订单项信息</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemEntity</span><span class="token punctuation">></span></span> orderItems <span class="token operator">=</span> orderCreateTo<span class="token punctuation">.</span><span class="token function">getOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 批量保存订单项数据</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    orderItemService<span class="token punctuation">.</span><span class="token function">saveBatch</span><span class="token punctuation">(</span>orderItems<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="库存锁定"><a class="anchor" href="#库存锁定">#</a> 库存锁定</h4><p><strong>实体</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WareSkuLockVo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderSn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/** 需要锁住的所有库存信息 **/</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> locks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//4、库存锁定，只要有异常，回滚订单数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 订单号、所有订单项信息 (skuId,skuNum,skuName)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name">WareSkuLockVo</span> lockVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareSkuLockVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>lockVo<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 获取出要锁定的商品数据信息</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> orderItemVos <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getOrderItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">OrderItemVo</span> orderItemVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderItemVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    orderItemVo<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    orderItemVo<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuQuantity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    orderItemVo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getSkuName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> orderItemVo<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>lockVo<span class="token punctuation">.</span><span class="token function">setLocks</span><span class="token punctuation">(</span>orderItemVos<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">//TODO 调用远程锁定库存的方法</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment">// 出现的问题：扣减库存成功了，但是由于网络原因超时，出现异常，导致订单事务回滚，库存事务不回滚 (解决方案：seata)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// 为了保证高并发，不推荐使用 seata，因为是加锁，并行化，提升不了效率，可以发消息给库存服务</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token class-name">R</span> r <span class="token operator">=</span> wmsFeignService<span class="token punctuation">.</span><span class="token function">orderLockStock</span><span class="token punctuation">(</span>lockVo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>锁库存 sql</strong></p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>listWareIdHasSkuStock<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>java.lang.Long<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    SELECT</pre></td></tr><tr><td data-num="3"></td><td><pre>        ware_id</pre></td></tr><tr><td data-num="4"></td><td><pre>    FROM</pre></td></tr><tr><td data-num="5"></td><td><pre>        wms_ware_sku</pre></td></tr><tr><td data-num="6"></td><td><pre>    WHERE</pre></td></tr><tr><td data-num="7"></td><td><pre>        sku_id = #&#123;skuId&#125;</pre></td></tr><tr><td data-num="8"></td><td><pre>      AND stock - stock_locked > 0</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lockSkuStock<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    UPDATE wms_ware_sku</pre></td></tr><tr><td data-num="13"></td><td><pre>    SET stock_locked = stock_locked + #&#123;num&#125;</pre></td></tr><tr><td data-num="14"></td><td><pre>    WHERE</pre></td></tr><tr><td data-num="15"></td><td><pre>        sku_id = #&#123;skuId&#125;</pre></td></tr><tr><td data-num="16"></td><td><pre>      AND ware_id = #&#123;wareId&#125;</pre></td></tr><tr><td data-num="17"></td><td><pre>      AND stock - stock_locked > 0</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p><strong>代码</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 锁定库存</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param vo</pre></td></tr><tr><td data-num="4"></td><td><pre> *</pre></td></tr><tr><td data-num="5"></td><td><pre> * 库存解锁的场景</pre></td></tr><tr><td data-num="6"></td><td><pre> *      1）、下订单成功，订单过期没有支付被系统自动取消或者被用户手动取消，都要解锁库存</pre></td></tr><tr><td data-num="7"></td><td><pre> *      2）、下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁</pre></td></tr><tr><td data-num="8"></td><td><pre> *      3）、</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @return</pre></td></tr><tr><td data-num="11"></td><td><pre> */</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/lock/order"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">WareSkuLockVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">boolean</span> lockStock <span class="token operator">=</span> wareSkuService<span class="token punctuation">.</span><span class="token function">orderLockStock</span><span class="token punctuation">(</span>vo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>lockStock<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoStockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>NO_STOCK_EXCEPTION<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>NO_STOCK_EXCEPTION<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * 为某个订单锁定库存</pre></td></tr><tr><td data-num="3"></td><td><pre>     * @param vo</pre></td></tr><tr><td data-num="4"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="5"></td><td><pre>     */</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="11"></td><td><pre>         * 保存库存工作单详情信息</pre></td></tr><tr><td data-num="12"></td><td><pre>         * 追溯</pre></td></tr><tr><td data-num="13"></td><td><pre>         */</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">WareOrderTaskEntity</span> wareOrderTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        wareOrderTaskService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">//1、按照下单的收货地址，找到一个就近仓库，锁定库存</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">//2、找到每个商品在哪个仓库都有库存</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> locks <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuWareHasStock</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token class-name">SkuWareHasStock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuWareHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token class-name">Long</span> skuId <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            stock<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            stock<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token comment">// 查询这个商品在哪个仓库有库存</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> wareIdList <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">listWareIdHasSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            stock<span class="token punctuation">.</span><span class="token function">setWareId</span><span class="token punctuation">(</span>wareIdList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">return</span> stock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token comment">//2、锁定库存</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuWareHasStock</span> hasStock <span class="token operator">:</span> collect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">boolean</span> skuStocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token class-name">Long</span> skuId <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> wareIds <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>wareIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token comment">// 没有任何仓库有这个商品的库存</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">//1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给 MQ</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">//2、锁定失败。前面保存的工作单信息都回滚了。发送出去的消息，即使要解锁库存，由于在数据库查不到指定的 id，所有就不用解锁</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> wareId <span class="token operator">:</span> wareIds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token comment">// 锁定成功就返回 1，失败就返回 0</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token class-name">Long</span> count <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">lockSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    skuStocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                    <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">=</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">skuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">skuName</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">skuNum</span><span class="token punctuation">(</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">wareId</span><span class="token punctuation">(</span>wareId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">lockStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                    wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token comment">//                    //TODO 告诉 MQ 库存锁定成功</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                   <span class="token class-name">StockLockedTo</span> lockedTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockLockedTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                   lockedTo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                   <span class="token class-name">StockDetailTo</span> detailTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                    <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">,</span>detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                   lockedTo<span class="token punctuation">.</span><span class="token function">setDetailTo</span><span class="token punctuation">(</span>detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                   rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"stock-event-exchange"</span><span class="token punctuation">,</span><span class="token string">"stock.locked"</span><span class="token punctuation">,</span>lockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                    <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                    <span class="token comment">// 当前仓库锁失败，重试下一个仓库</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>skuStocked <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token comment">// 当前商品所有仓库都没有锁住</span></pre></td></tr><tr><td data-num="79"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token comment">//3、肯定全部都是锁定成功的</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="分布式事务问题"><a class="anchor" href="#分布式事务问题">#</a> 分布式事务问题</h4><p><strong>使用 Rabbit MQ 完成事务问题</strong></p><p><strong>库存解锁</strong></p><p><img data-src="../../assets/image-20210727155335801.png" alt="image-20210727155335801"></p><p><strong>库存服务配置</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRabbitConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 序列化机制 以 json 方式接受</pre></td></tr><tr><td data-num="9"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="10"></td><td><pre>     */</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">MessageConverter</span> <span class="token function">messageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span>  <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">//    /**</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//     * 定制 RabbitTemplate</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">//     * 1、服务收到消息就会回调</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">//     *      1、spring.rabbitmq.publisher-confirms: true</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">//     *      2、设置确认回调</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">//     * 2、消息正确抵达队列就会进行回调</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">//     *      1、spring.rabbitmq.publisher-returns: true</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">//     *         spring.rabbitmq.template.mandatory: true</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//     *      2、设置确认回调 ReturnCallback</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">//     *</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment">//     * 3、消费端确认 (保证每个消息都被正确消费，此时才可以 broker 删除这个消息)</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">//     *</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">//     */</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment">//    // @PostConstruct  //MyRabbitConfig 对象创建完成以后，执行这个方法</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">//    public void initRabbitTemplate() &#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">//        /**</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">//         * 1、只要消息抵达 Broker 就 ack=true</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment">//         * correlationData：当前消息的唯一关联数据 (这个是消息的唯一 id)</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">//         * ack：消息是否成功收到</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">//         * cause：失败的原因</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">//         */</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">//        // 设置确认回调</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">//        rabbitTemplate.setConfirmCallback((correlationData,ack,cause) -> &#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment">//            System.out.println("confirm...correlationData["+correlationData+"]==>ack:["+ack+"]==>cause:["+cause+"]");</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment">//        &#125;);</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">//</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">//        /**</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment">//         * 只要消息没有投递给指定的队列，就触发这个失败回调</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment">//         * message：投递失败的消息详细信息</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token comment">//         * replyCode：回复的状态码</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token comment">//         * replyText：回复的文本内容</span></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token comment">//         * exchange：当时这个消息发给哪个交换机</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token comment">//         * routingKey：当时这个消息用哪个路邮键</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token comment">//         */</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token comment">//        rabbitTemplate.setReturnCallback((message,replyCode,replyText,exchange,routingKey) -> &#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token comment">//            System.out.println("Fail Message["+message+"]==>replyCode["+replyCode+"]" +</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token comment">//                    "==>replyText["+replyText+"]==>exchange["+exchange+"]==>routingKey["+routingKey+"]");</span></pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token comment">//        &#125;);</span></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">//    &#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">stockEventExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TopicExchange</span><span class="token punctuation">(</span><span class="token string">"stock-event-exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">stockReleaseStockQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"stock.release.stock.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">stockDelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="71"></td><td><pre>         * x-dead-letter-exchange: order-event-exchange</pre></td></tr><tr><td data-num="72"></td><td><pre>         * x-dead-letter-routing-key: order.release.order</pre></td></tr><tr><td data-num="73"></td><td><pre>         * x-message-ttl: 60000</pre></td></tr><tr><td data-num="74"></td><td><pre>         */</pre></td></tr><tr><td data-num="75"></td><td><pre>        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span><span class="token string">"stock-event-exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span><span class="token string">"stock.release.stock.queue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-message-ttl"</span><span class="token punctuation">,</span><span class="token number">120000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"stock.delay.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">stockReleaseBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"stock.release.stock.queue"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="83"></td><td><pre>                <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="84"></td><td><pre>                <span class="token string">"stock-event-exchange"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="85"></td><td><pre>                <span class="token string">"stock.release.#"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="86"></td><td><pre>                <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">stockLockedBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"stock.delay.queue"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="91"></td><td><pre>                <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="92"></td><td><pre>                <span class="token string">"stock-event-exchange"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="93"></td><td><pre>                <span class="token string">"stock.locked"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="监听库存解锁"><a class="anchor" href="#监听库存解锁">#</a> 监听库存解锁</h4><pre><code>* 库存解锁的场景
* 1）、下单成功。订单过期没有支付被系统自动取消、被用户手动取消
* 2）、下单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚
</code></pre><p><img data-src="../../assets/image-20210727162254382.png" alt="image-20210727162254382"></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 为某个订单锁定库存</pre></td></tr><tr><td data-num="3"></td><td><pre> *</pre></td></tr><tr><td data-num="4"></td><td><pre> * 库存解锁的场景</pre></td></tr><tr><td data-num="5"></td><td><pre> * 1）、下单成功。订单过期没有支付被系统自动取消、被用户手动取消</pre></td></tr><tr><td data-num="6"></td><td><pre> * 2）、下单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚</pre></td></tr><tr><td data-num="7"></td><td><pre> *</pre></td></tr><tr><td data-num="8"></td><td><pre> * @param vo</pre></td></tr><tr><td data-num="9"></td><td><pre> * @return</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">orderLockStock</span><span class="token punctuation">(</span><span class="token class-name">WareSkuLockVo</span> vo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * 保存库存工作单详情信息</pre></td></tr><tr><td data-num="17"></td><td><pre>     * 追溯</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">WareOrderTaskEntity</span> wareOrderTaskEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setOrderSn</span><span class="token punctuation">(</span>vo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    wareOrderTaskService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">//1、按照下单的收货地址，找到一个就近仓库，锁定库存</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">//2、找到每个商品在哪个仓库都有库存</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItemVo</span><span class="token punctuation">></span></span> locks <span class="token operator">=</span> vo<span class="token punctuation">.</span><span class="token function">getLocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SkuWareHasStock</span><span class="token punctuation">></span></span> collect <span class="token operator">=</span> locks<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token class-name">SkuWareHasStock</span> stock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkuWareHasStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        stock<span class="token punctuation">.</span><span class="token function">setSkuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        stock<span class="token punctuation">.</span><span class="token function">setNum</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token comment">// 查询这个商品在哪个仓库有库存</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> wareIdList <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">listWareIdHasSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        stock<span class="token punctuation">.</span><span class="token function">setWareId</span><span class="token punctuation">(</span>wareIdList<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">return</span> stock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">//2、锁定库存</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SkuWareHasStock</span> hasStock <span class="token operator">:</span> collect<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token keyword">boolean</span> skuStocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">Long</span> skuId <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> wareIds <span class="token operator">=</span> hasStock<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>wareIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token comment">// 没有任何仓库有这个商品的库存</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token comment">//1、如果每一个商品都锁定成功，将当前商品锁定了几件的工作单记录发给 MQ</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">//2、锁定失败。前面保存的工作单信息都回滚了。发送出去的消息，即使要解锁库存，由于在数据库查不到指定的 id，所有就不用解锁</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> wareId <span class="token operator">:</span> wareIds<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token comment">// 锁定成功就返回 1，失败就返回 0</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token class-name">Long</span> count <span class="token operator">=</span> wareSkuDao<span class="token punctuation">.</span><span class="token function">lockSkuStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>                skuStocked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>                <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">=</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">skuId</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">skuName</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">skuNum</span><span class="token punctuation">(</span>hasStock<span class="token punctuation">.</span><span class="token function">getNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">taskId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">wareId</span><span class="token punctuation">(</span>wareId<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">lockStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>                <span class="token comment">//TODO 告诉 MQ 库存锁定成功 ---------------</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token class-name">StockLockedTo</span> lockedTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockLockedTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                lockedTo<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>wareOrderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token class-name">StockDetailTo</span> detailTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StockDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">,</span>detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                lockedTo<span class="token punctuation">.</span><span class="token function">setDetailTo</span><span class="token punctuation">(</span>detailTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"stock-event-exchange"</span><span class="token punctuation">,</span><span class="token string">"stock.locked"</span><span class="token punctuation">,</span>lockedTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>                <span class="token keyword">break</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>                <span class="token comment">// 当前仓库锁失败，重试下一个仓库</span></pre></td></tr><tr><td data-num="79"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>skuStocked <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>            <span class="token comment">// 当前商品所有仓库都没有锁住</span></pre></td></tr><tr><td data-num="84"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoStockException</span><span class="token punctuation">(</span>skuId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token comment">//3、肯定全部都是锁定成功的</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="93"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">SkuWareHasStock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Long</span> skuId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> num<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span> wareId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="解锁业务代码"><a class="anchor" href="#解锁业务代码">#</a> 解锁业务代码</h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 库存自动解锁</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param to</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param message</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@RabbitHandler</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStockLockedRelease</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到库存解锁消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 库存工作单的 id</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">StockDetailTo</span> detail <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">Long</span> detailId <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 解锁</pre></td></tr><tr><td data-num="15"></td><td><pre>     * 1、查询数据库关于这个订单锁定库存信息</pre></td></tr><tr><td data-num="16"></td><td><pre>     *   有：证明库存锁定成功了</pre></td></tr><tr><td data-num="17"></td><td><pre>     *      解锁：订单状况</pre></td></tr><tr><td data-num="18"></td><td><pre>     *          1、没有这个订单，必须解锁库存</pre></td></tr><tr><td data-num="19"></td><td><pre>     *          2、有这个订单，不一定解锁库存</pre></td></tr><tr><td data-num="20"></td><td><pre>     *              订单状态：已取消：解锁库存</pre></td></tr><tr><td data-num="21"></td><td><pre>     *                      已支付：不能解锁库存</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailInfo <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>detailId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 查出 wms_ware_order_task 工作单的信息</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">Long</span> id <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">WareOrderTaskEntity</span> orderTaskInfo <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 获取订单号查询订单状态</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTaskInfo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 远程查询订单信息</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">R</span> orderData <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderData<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 订单数据返回成功</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token class-name">OrderVo</span> orderInfo <span class="token operator">=</span> orderData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token comment">// 判断订单状态是否已取消或者支付或者订单不存在</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token comment">// 订单已被取消，才能解锁库存</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo<span class="token punctuation">.</span><span class="token function">getLockStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    <span class="token comment">// 当前库存工作单详情状态 1，已锁定，但是未解锁才可以解锁</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token function">unLockStock</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detailId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment">// 消息拒绝以后重新放在队列里面，让别人继续消费解锁</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token comment">// 远程调用服务失败</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"远程调用服务失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token comment">// 无需解锁</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="57"></td><td><pre>     * 解锁库存的方法</pre></td></tr><tr><td data-num="58"></td><td><pre>     * @param skuId</pre></td></tr><tr><td data-num="59"></td><td><pre>     * @param wareId</pre></td></tr><tr><td data-num="60"></td><td><pre>     * @param num</pre></td></tr><tr><td data-num="61"></td><td><pre>     * @param taskDetailId</pre></td></tr><tr><td data-num="62"></td><td><pre>     */</pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLockStock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> skuId<span class="token punctuation">,</span><span class="token class-name">Long</span> wareId<span class="token punctuation">,</span><span class="token class-name">Integer</span> num<span class="token punctuation">,</span><span class="token class-name">Long</span> taskDetailId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token comment">// 库存解锁</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        wareSkuDao<span class="token punctuation">.</span><span class="token function">unLockStock</span><span class="token punctuation">(</span>skuId<span class="token punctuation">,</span>wareId<span class="token punctuation">,</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token comment">// 更新工作单的状态</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        taskDetailEntity<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>taskDetailId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token comment">// 变为已解锁</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        taskDetailEntity<span class="token punctuation">.</span><span class="token function">setLockStatus</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="开启手动ack模式"><a class="anchor" href="#开启手动ack模式">#</a> 开启手动 ack 模式</h5><p><strong>如果不开启的话，库存解锁远程调用失败的话，消息队列的消息也被消费了，应该是手动 ack</strong></p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token key atrule">listener</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token key atrule">simple</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual</pre></td></tr></table></figure><p><strong>代码</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"stock.release.stock.queue"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockReleaseListener</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">WareSkuService</span> wareSkuService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     * 1、库存自动解锁</pre></td></tr><tr><td data-num="11"></td><td><pre>     *  下订单成功，库存锁定成功，接下来的业务调用失败，导致订单回滚。之前锁定的库存就要自动解锁</pre></td></tr><tr><td data-num="12"></td><td><pre>     *</pre></td></tr><tr><td data-num="13"></td><td><pre>     *  2、订单失败</pre></td></tr><tr><td data-num="14"></td><td><pre>     *      库存锁定失败</pre></td></tr><tr><td data-num="15"></td><td><pre>     *</pre></td></tr><tr><td data-num="16"></td><td><pre>     *   只要解锁库存的消息失败，一定要告诉服务解锁失败</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@RabbitHandler</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleStockLockedRelease</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> <span class="token keyword">to</span><span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"******收到解锁库存的信息******"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// 当前消息是否被第二次及以后（重新）派发过来了</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">// Boolean redelivered = message.getMessageProperties().getRedelivered();</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment">// 解锁库存</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            wareSkuService<span class="token punctuation">.</span><span class="token function">unlockStock</span><span class="token punctuation">(</span><span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token comment">// 手动删除消息</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token comment">// 解锁失败 将消息重新放回队列，让别人消费</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockStock</span><span class="token punctuation">(</span><span class="token class-name">StockLockedTo</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 库存工作单的 id</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">StockDetailTo</span> detail <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getDetailTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Long</span> detailId <span class="token operator">=</span> detail<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * 解锁</pre></td></tr><tr><td data-num="9"></td><td><pre>     * 1、查询数据库关于这个订单锁定库存信息</pre></td></tr><tr><td data-num="10"></td><td><pre>     *   有：证明库存锁定成功了</pre></td></tr><tr><td data-num="11"></td><td><pre>     *      解锁：订单状况</pre></td></tr><tr><td data-num="12"></td><td><pre>     *          1、没有这个订单，必须解锁库存</pre></td></tr><tr><td data-num="13"></td><td><pre>     *          2、有这个订单，不一定解锁库存</pre></td></tr><tr><td data-num="14"></td><td><pre>     *              订单状态：已取消：解锁库存</pre></td></tr><tr><td data-num="15"></td><td><pre>     *                      已支付：不能解锁库存</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailInfo <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>detailId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 查出 wms_ware_order_task 工作单的信息</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">Long</span> id <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">WareOrderTaskEntity</span> orderTaskInfo <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 获取订单号查询订单状态</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTaskInfo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 远程查询订单信息</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">R</span> orderData <span class="token operator">=</span> orderFeignService<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderData<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">// 订单数据返回成功</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token class-name">OrderVo</span> orderInfo <span class="token operator">=</span> orderData<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderVo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">// 判断订单状态是否已取消或者支付或者订单不存在</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token comment">// 订单已被取消，才能解锁库存</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>taskDetailInfo<span class="token punctuation">.</span><span class="token function">getLockStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token comment">// 当前库存工作单详情状态 1，已锁定，但是未解锁才可以解锁</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token function">unLockStock</span><span class="token punctuation">(</span>detail<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detail<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>detailId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token comment">// 消息拒绝以后重新放在队列里面，让别人继续消费解锁</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token comment">// 远程调用服务失败</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"远程调用服务失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 无需解锁</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="监听订单关闭"><a class="anchor" href="#监听订单关闭">#</a> 监听订单关闭</h4><p><img data-src="../../assets/image-20210728104730165.png" alt="image-20210728104730165"></p><p><img data-src="../../assets/image-20210728104803485.png" alt="image-20210728104803485"></p><p><strong>如果机器卡顿等延迟导致库存先解锁，判断为新订单消费玩消息后消息没了，然后订单这时候解锁订单，那么就会造成库存永远得不到解锁，所以这里会让订单在解锁订单成功后主动通知库存去解锁。</strong></p><h5 id="配置订单交换机绑定解锁库存的队列"><a class="anchor" href="#配置订单交换机绑定解锁库存的队列">#</a> <strong>配置订单交换机绑定解锁库存的队列</strong></h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">orderReleaseOtherBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">"stock.release.stock.queue"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token class-name">Binding<span class="token punctuation">.</span>DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token string">"order-event-exchange"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token string">"order.release.other"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h5 id="定时关闭订单"><a class="anchor" href="#定时关闭订单">#</a> <strong>定时关闭订单</strong></h5><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">"order.release.order.queue"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCloseListener</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@RabbitHandler</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到过期的订单信息，准备关闭订单"</span> <span class="token operator">+</span> orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            orderService<span class="token punctuation">.</span><span class="token function">closeOrder</span><span class="token punctuation">(</span>orderEntity<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 关闭订单</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param orderEntity</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderEntity</span> orderEntity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 关闭订单之前先查询一下数据库，判断此订单状态是否已支付</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">OrderEntity</span> orderInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderEntity</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"order_sn"</span><span class="token punctuation">,</span>orderEntity<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CREATE_NEW<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 代付款状态进行关单</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">OrderEntity</span> orderUpdate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        orderUpdate<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        orderUpdate<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatusEnum</span><span class="token punctuation">.</span>CANCLED<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateById</span><span class="token punctuation">(</span>orderUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 发送消息给 MQ</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">OrderTo</span> orderTo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token comment">//TODO 确保每个消息发送成功，给每个消息做好日志记录，(给数据库保存每一个详细信息) 保存每个消息的详细信息</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"order-event-exchange"</span><span class="token punctuation">,</span> <span class="token string">"order.release.other"</span><span class="token punctuation">,</span> orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">//TODO 定期扫描数据库，重新发送失败的消息</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>防止订单服务卡顿导致解锁库存不解锁，订单解锁成功通知库存解锁</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 订单关闭，准备解锁库存</pre></td></tr><tr><td data-num="3"></td><td><pre> * @param orderTo</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param message</pre></td></tr><tr><td data-num="5"></td><td><pre> * @param channel</pre></td></tr><tr><td data-num="6"></td><td><pre> * @throws IOException</pre></td></tr><tr><td data-num="7"></td><td><pre> */</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@RabbitHandler</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleOrderCloseRelease</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">,</span> <span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"******收到订单关闭，准备解锁库存的信息******"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        wareSkuService<span class="token punctuation">.</span><span class="token function">unlockStock</span><span class="token punctuation">(</span>orderTo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 手动删除消息</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 解锁失败 将消息重新放回队列，让别人消费</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        channel<span class="token punctuation">.</span><span class="token function">basicReject</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 防止订单服务卡顿，导致订单状态消息一直改不了，库存优先到期，查订单状态新建，什么都不处理</pre></td></tr><tr><td data-num="3"></td><td><pre> * 导致卡顿的订单，永远都不能解锁库存</pre></td></tr><tr><td data-num="4"></td><td><pre> * @param orderTo</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlockStock</span><span class="token punctuation">(</span><span class="token class-name">OrderTo</span> orderTo<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">String</span> orderSn <span class="token operator">=</span> orderTo<span class="token punctuation">.</span><span class="token function">getOrderSn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 查一下最新的库存解锁状态，防止重复解锁库存</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">WareOrderTaskEntity</span> orderTaskEntity <span class="token operator">=</span> wareOrderTaskService<span class="token punctuation">.</span><span class="token function">getOrderTaskByOrderSn</span><span class="token punctuation">(</span>orderSn<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 按照工作单的 id 找到所有 没有解锁的库存，进行解锁</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Long</span> id <span class="token operator">=</span> orderTaskEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> wareOrderTaskDetailService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WareOrderTaskDetailEntity</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"lock_status"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">WareOrderTaskDetailEntity</span> taskDetailEntity <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token function">unLockStock</span><span class="token punctuation">(</span>taskDetailEntity<span class="token punctuation">.</span><span class="token function">getSkuId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                taskDetailEntity<span class="token punctuation">.</span><span class="token function">getWareId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                taskDetailEntity<span class="token punctuation">.</span><span class="token function">getSkuNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                taskDetailEntity<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h4 id="保证消息的可靠性"><a class="anchor" href="#保证消息的可靠性">#</a> <strong>保证消息的可靠性</strong></h4><p><strong>RabbitMQ:<a href="https://oxyzen-wxf.github.io/database/msg/rabbitmq-1/">https://oxyzen-wxf.github.io/database/msg/rabbitmq-1/</a></strong></p><h2 id="订单服务整合支付"><a class="anchor" href="#订单服务整合支付">#</a> 订单服务整合支付</h2><p><strong>订单支付：<a href="https://oxyzen-wxf.github.io/worknote/order-2/">https://oxyzen-wxf.github.io/worknote/order-2/</a></strong></p><div class="tags"><a href="/tags/java/" rel="tag"><i class="ic i-tag"></i> java</a> <a href="/tags/Spring-Boot/" rel="tag"><i class="ic i-tag"></i> Spring Boot</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-06-03 16:55:51" itemprop="dateModified" datetime="2022-06-03T16:55:51+08:00">2022-06-03</time> </span><span id="worknote/order-1/" class="item leancloud_visitors" data-flag-title="尚硅谷订单服务笔记" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="WangXuefeng 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="WangXuefeng 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="WangXuefeng 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文博主： </strong>WangXuefeng <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://oxyzen-wxf.github.io/worknote/order-1/" title="尚硅谷订单服务笔记">https://oxyzen-wxf.github.io/worknote/order-1/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/worknote/swagger-1/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclh5u05ej20zk0m87df.jpg" title="微服务整合公共Swagger2以及微服务引用公共模块没有填进容器"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java常用工具</span><h3>微服务整合公共Swagger2以及微服务引用公共模块没有填进容器</h3></a></div><div class="item right"><a href="/worknote/order-3/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipexbei4hj20zk0m8npd.jpg" title="尚硅谷订单服务笔记之秒杀"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Java</span><h3>尚硅谷订单服务笔记之秒杀</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95"><span class="toc-number">1.</span> <span class="toc-text">订单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%A2%E5%8D%95%E4%B8%AD%E5%BF%83"><span class="toc-number">1.1.</span> <span class="toc-text">1、订单中心</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%AE%A2%E5%8D%95%E6%9E%84%E6%88%90"><span class="toc-number">1.2.</span> <span class="toc-text">2、订单构成</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.1.</span> <span class="toc-text">1、用户信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%AE%A2%E5%8D%95%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">2、订单基础信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%95%86%E5%93%81%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">3、商品信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BC%98%E6%83%A0%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.4.</span> <span class="toc-text">4、优惠信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%94%AF%E4%BB%98%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.5.</span> <span class="toc-text">5. 支付信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E7%89%A9%E6%B5%81%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.6.</span> <span class="toc-text">6. 物流信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81"><span class="toc-number">1.3.</span> <span class="toc-text">3、订单状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BE%85%E4%BB%98%E6%AC%BE"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 待付款</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%B7%B2%E4%BB%98%E6%AC%BE%E5%BE%85%E5%8F%91%E8%B4%A7"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 已付款 &#x2F; 待发货</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BE%85%E6%94%B6%E8%B4%A7%E5%B7%B2%E5%8F%91%E8%B4%A7"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 待收货 &#x2F; 已发货</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%B7%B2%E5%AE%8C%E6%88%90"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 已完成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%B7%B2%E5%8F%96%E6%B6%88"><span class="toc-number">1.3.5.</span> <span class="toc-text">5. 已取消</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%94%AE%E5%90%8E%E4%B8%AD"><span class="toc-number">1.3.6.</span> <span class="toc-text">6. 售后中</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%AE%A2%E5%8D%95%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.</span> <span class="toc-text">4、订单流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%AE%A2%E5%8D%95%E5%88%9B%E5%BB%BA%E4%B8%8E%E6%94%AF%E4%BB%98"><span class="toc-number">1.4.1.</span> <span class="toc-text">1、订单创建与支付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%80%86%E5%90%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">2、逆向流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B9%82%E7%AD%89%E6%80%A7%E5%A4%84%E7%90%86"><span class="toc-number">1.4.3.</span> <span class="toc-text">3、幂等性处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">订单业务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.</span> <span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">3.1.</span> <span class="toc-text">配置拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E7%A1%AE%E8%AE%A4%E5%AE%9E%E4%BD%93"><span class="toc-number">3.2.</span> <span class="toc-text">订单确认实体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">3.3.</span> <span class="toc-text">订单业务代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#feign%E8%BF%9C%E7%A8%8B%E4%B8%A2%E5%A4%B1%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">3.4.</span> <span class="toc-text">Feign 远程丢失请求头</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#feign%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B8%A2%E5%A4%B1%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.5.</span> <span class="toc-text">Feign 异步模式丢失上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E8%A7%A3%E5%86%B3%E5%B9%82%E7%AD%89%E6%80%A7"><span class="toc-number">3.6.</span> <span class="toc-text">订单解决幂等性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E5%8D%95%E4%BB%A3%E7%A0%81"><span class="toc-number">3.7.</span> <span class="toc-text">下单代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95"><span class="toc-number">3.7.1.</span> <span class="toc-text">创建订单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-number">3.7.2.</span> <span class="toc-text">构建订单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E8%AE%A2%E5%8D%95%E9%A1%B9%E6%95%B0%E6%8D%AE"><span class="toc-number">3.7.3.</span> <span class="toc-text">构建订单项数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E4%BB%B7%E6%A0%BC"><span class="toc-number">3.7.4.</span> <span class="toc-text">计算价格</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E5%AD%98%E8%AE%A2%E5%8D%95%E6%95%B0%E6%8D%AE"><span class="toc-number">3.7.5.</span> <span class="toc-text">保存订单数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%93%E5%AD%98%E9%94%81%E5%AE%9A"><span class="toc-number">3.7.6.</span> <span class="toc-text">库存锁定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="toc-number">3.7.7.</span> <span class="toc-text">分布式事务问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E5%BA%93%E5%AD%98%E8%A7%A3%E9%94%81"><span class="toc-number">3.7.8.</span> <span class="toc-text">监听库存解锁</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E9%94%81%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">3.7.8.1.</span> <span class="toc-text">解锁业务代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%80%E5%90%AF%E6%89%8B%E5%8A%A8ack%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.7.8.2.</span> <span class="toc-text">开启手动 ack 模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E5%90%AC%E8%AE%A2%E5%8D%95%E5%85%B3%E9%97%AD"><span class="toc-number">3.7.9.</span> <span class="toc-text">监听订单关闭</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%A2%E5%8D%95%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%BB%91%E5%AE%9A%E8%A7%A3%E9%94%81%E5%BA%93%E5%AD%98%E7%9A%84%E9%98%9F%E5%88%97"><span class="toc-number">3.7.9.1.</span> <span class="toc-text">配置订单交换机绑定解锁库存的队列</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%85%B3%E9%97%AD%E8%AE%A2%E5%8D%95"><span class="toc-number">3.7.9.2.</span> <span class="toc-text">定时关闭订单</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7"><span class="toc-number">3.7.10.</span> <span class="toc-text">保证消息的可靠性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E6%95%B4%E5%90%88%E6%94%AF%E4%BB%98"><span class="toc-number">4.</span> <span class="toc-text">订单服务整合支付</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/worknote/security-jwt-vue/amdin-back/" rel="bookmark" title="开发SpringBoot+Jwt+Vue的前后端分离后台管理系统VueAdmin - 后端笔记">开发SpringBoot+Jwt+Vue的前后端分离后台管理系统VueAdmin - 后端笔记</a></li><li><a href="/worknote/easypoi-1/" rel="bookmark" title="easypoi导出大量数据">easypoi导出大量数据</a></li><li><a href="/worknote/javautil/util-2/" rel="bookmark" title="JDBC增删改查">JDBC增删改查</a></li><li><a href="/worknote/javautil/util-1/" rel="bookmark" title="用于将汉语的数字转换为阿拉伯数字">用于将汉语的数字转换为阿拉伯数字</a></li><li><a href="/worknote/javautil/util-3/" rel="bookmark" title="文件进行重命名">文件进行重命名</a></li><li><a href="/worknote/javautil/util-5/" rel="bookmark" title="判断对象中属性值是否全为空">判断对象中属性值是否全为空</a></li><li><a href="/worknote/javautil/util-4/" rel="bookmark" title="JDBC连接工具">JDBC连接工具</a></li><li><a href="/worknote/javautil/util-7/" rel="bookmark" title="保留小数工具">保留小数工具</a></li><li><a href="/worknote/javautil/util-8/" rel="bookmark" title="驼峰转换工具">驼峰转换工具</a></li><li><a href="/worknote/javautil/utli-6/" rel="bookmark" title="随机生成随机码工具">随机生成随机码工具</a></li><li><a href="/worknote/easypoi-2/" rel="bookmark" title="easypoi导出复杂表">easypoi导出复杂表</a></li><li><a href="/worknote/digui-1/" rel="bookmark" title="递归解决权限树或多级联动的两种方法">递归解决权限树或多级联动的两种方法</a></li><li><a href="/worknote/Interview-1/" rel="bookmark" title="面试题笔记记录(一)">面试题笔记记录(一)</a></li><li><a href="/worknote/Interview-2/" rel="bookmark" title="面试题笔记记录(二)面试必考题（通俗易懂精华版）">面试题笔记记录(二)面试必考题（通俗易懂精华版）</a></li><li><a href="/worknote/interview-3/" rel="bookmark" title="面试题笔记记录(三)周阳尚硅谷版">面试题笔记记录(三)周阳尚硅谷版</a></li><li><a href="/worknote/interview-4/" rel="bookmark" title="面试总结之北京行">面试总结之北京行</a></li><li><a href="/worknote/note-1/" rel="bookmark" title="日常笔记之Spring Boot配置指定配置类">日常笔记之Spring Boot配置指定配置类</a></li><li><a href="/worknote/note-2/" rel="bookmark" title="日常笔记之幂等性">日常笔记之幂等性</a></li><li><a href="/worknote/gulinote/" rel="bookmark" title="谷粒商城笔记">谷粒商城笔记</a></li><li><a href="/worknote/order-2/" rel="bookmark" title="尚硅谷订单服务笔记之整合支付">尚硅谷订单服务笔记之整合支付</a></li><li><a href="/worknote/order-3/" rel="bookmark" title="尚硅谷订单服务笔记之秒杀">尚硅谷订单服务笔记之秒杀</a></li><li class="active"><a href="/worknote/order-1/" rel="bookmark" title="尚硅谷订单服务笔记">尚硅谷订单服务笔记</a></li><li><a href="/worknote/swagger-1/" rel="bookmark" title="微服务整合公共Swagger2以及微服务引用公共模块没有填进容器">微服务整合公共Swagger2以及微服务引用公共模块没有填进容器</a></li><li><a href="/worknote/jvm-1/" rel="bookmark" title="JVM(一)">JVM(一)</a></li><li><a href="/worknote/spring-cycle-1/" rel="bookmark" title="Spring循环依赖">Spring循环依赖</a></li><li><a href="/worknote/timing-1/" rel="bookmark" title="定时任务">定时任务</a></li><li><a href="/worknote/interface-safety-1/" rel="bookmark" title="接口安全性">接口安全性</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="WangXuefeng" data-src="/images/avatar.jpg"><p class="name" itemprop="name">WangXuefeng</p><div class="description" itemprop="description">日常学习 & 复习记录</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">85</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">25</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">44</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL294eXplbi13eGY=" title="https:&#x2F;&#x2F;github.com&#x2F;oxyzen-wxf"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTYwNzA2MDI0MQ==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;607060241"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjk2MzIxMDczOEBxcS5jb20=" title="mailto:963210738@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/worknote/swagger-1/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/worknote/order-3/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/jvm-1/" title="JVM(一)">JVM(一)</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/about/" title="关于">关于</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/designpattern/" title="分类于 设计模式">设计模式</a></div><span><a href="/computer-science/java/designpattern/design-8/" title="设计模式之桥接模式(-)">设计模式之桥接模式(-)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/javautil/" title="分类于 Java常用工具">Java常用工具</a></div><span><a href="/worknote/javautil/util-1/" title="用于将汉语的数字转换为阿拉伯数字">用于将汉语的数字转换为阿拉伯数字</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/database/mysql/" title="分类于 Mysql">Mysql</a></div><span><a href="/database/mysql/mysql-2/" title="Mysql高级优化之最左前缀匹配原则">Mysql高级优化之最左前缀匹配原则</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/javautil/" title="分类于 Java常用工具">Java常用工具</a></div><span><a href="/worknote/swagger-1/" title="微服务整合公共Swagger2以及微服务引用公共模块没有填进容器">微服务整合公共Swagger2以及微服务引用公共模块没有填进容器</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/javautil/" title="分类于 Java常用工具">Java常用工具</a></div><span><a href="/worknote/easypoi-2/" title="easypoi导出复杂表">easypoi导出复杂表</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/interview-3/" title="面试题笔记记录(三)周阳尚硅谷版">面试题笔记记录(三)周阳尚硅谷版</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/computer-science/" title="分类于 计算机科学">计算机科学</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/" title="分类于 Java">Java</a> <i class="ic i-angle-right"></i> <a href="/categories/computer-science/java/microservice/" title="分类于 微服务分布式">微服务分布式</a></div><span><a href="/computer-science/java/microservice/ribbon-1/" title="Ribbon">Ribbon</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/worknote/" title="分类于 工作日常笔记">工作日常笔记</a> <i class="ic i-angle-right"></i> <a href="/categories/worknote/java/" title="分类于 Java">Java</a></div><span><a href="/worknote/spring-cycle-1/" title="Spring循环依赖">Spring循环依赖</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">WangXuefeng @ Oxygen Anoxia</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">631k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">9:34</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"worknote/order-1/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:{placeholder:"1. 提问前请先仔细阅读本文档⚡\n2. 页面显示问题💥，请提供控制台截图📸或者您的测试网址\n3. 其他任何报错💣，请提供详细描述和截图📸，文章为个人见解，有问题请评论指出，及时修改🙅‍，祝食用愉快💪"},fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->